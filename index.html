<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FanConnect V5.2.12 - 粉絲滿意度管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --indigo-primary: #4B0082; }
        body { background: linear-gradient(135deg, #1a1a1a 0%, #050505 100%); color: #e0e0e0; height: 100vh; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        
        /* 側邊欄 (V5 風格) */
        .sidebar { background-color: rgba(75, 0, 130, 0.15); border-right: 1px solid rgba(75, 0, 130, 0.3); transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); width: 260px; display: flex; flex-direction: column; }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .menu-text, 
        .sidebar.collapsed .logo-text, 
        .sidebar.collapsed .profile-section { display: none; }
        
        /* 個人資料區塊 (V5) */
        .profile-section { text-align: center; padding: 20px 10px; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .profile-avatar-container { position: relative; width: 60px; height: 60px; margin: 0 auto 10px; cursor: pointer; }
        .profile-avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid #a78bfa; transition: all 0.3s; }
        .avatar-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .profile-avatar-container:hover .avatar-overlay { opacity: 1; }
        .profile-name-input { background: transparent; border: none; border-bottom: 1px solid transparent; color: white; text-align: center; font-weight: bold; font-size: 0.9rem; width: 100%; padding: 4px; transition: all 0.3s; }
        .profile-name-input:focus { outline: none; border-bottom: 1px solid #a78bfa; }

        /* 表格優化 (V5.1 RWD Update) */
        .table-container { 
            height: calc(100vh - 140px); overflow-y: auto; 
            overflow-x: auto; /* 允許水平捲動 */
            position: relative;
        }
        .table-row:hover { background-color: rgba(75, 0, 130, 0.2); transition: background-color 0.2s; }
        
        table { border-collapse: separate; border-spacing: 0; width: 100%; }

        /* V5.1 RWD: 手機版強制寬度以觸發捲動 & 凍結欄位設定 */
        @media (max-width: 768px) {
            table { min-width: 900px; }
        }

        /* 凍結欄位樣式 */
        .sticky-col-1 { position: sticky; left: 0; z-index: 25; background-color: #151515; }
        .sticky-col-2 { position: sticky; left: 45px; z-index: 25; background-color: #151515; border-right: 1px solid #333; }
        .sticky-col-last { position: sticky; right: 0; z-index: 25; background-color: #151515; border-left: 1px solid #333; }

        /* 確保表頭層級最高且顏色正確 */
        th.sticky-col-1, th.sticky-col-2, th.sticky-col-last { z-index: 30; background-color: #202020; }
        
        /* 處理凍結欄位的 Hover 效果 (使用實色模擬透明疊加，避免文字透出) */
        .table-row:hover .sticky-col-1,
        .table-row:hover .sticky-col-2,
        .table-row:hover .sticky-col-last { background-color: #2a1b3d; }

        th { background-color: #202020; position: sticky; top: 0; z-index: 20; padding: 10px; text-align: left; font-size: 0.8rem; color: #aaa; letter-spacing: 1px; border-bottom: 2px solid #4B0082; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        td { padding: 8px 10px; border-bottom: 1px solid #333; vertical-align: middle; }
        
        /* 元件樣式 */
        .btn-indigo { background-color: var(--indigo-primary); transition: all 0.2s; }
        .btn-indigo:hover { background-color: #5a009d; box-shadow: 0 0 15px rgba(75, 0, 130, 0.5); transform: translateY(-1px); }
        .input-dark { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 4px; padding: 8px 12px; width: 100%; transition: border-color 0.3s; }
        .input-dark:focus { outline: none; border-color: #4B0082; }
        .input-error { border-color: #ef4444 !important; background-color: rgba(239, 68, 68, 0.1); }
        
        /* 連結與動畫 */
        .visited-link { color: #047857 !important; text-decoration: none !important; font-weight: bold; transition: color 0.3s; }
        .star-btn { transition: transform 0.2s, color 0.2s; cursor: pointer; }
        .star-btn:hover { transform: scale(1.2); }
        .star-active { color: #fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        .star-inactive { color: #4b5563; }

        /* 卷軸 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #4B0082; border-radius: 4px; }

        /* V5.2 新增樣式: 時間輸入格式 */
        .date-segment-container {
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            padding: 4px 8px;
            width: fit-content; /* V5.2.1 Update: Adjusted to data width */
        }
        .date-segment-container input {
            background: transparent;
            border: none;
            color: white;
            text-align: center;
            padding: 4px 0;
            outline: none;
            width: 100%;
        }
        .date-segment-container input:focus {
            border-bottom: 1px solid #a78bfa; 
        }
        .date-segment-container input::-webkit-outer-spin-button,
        .date-segment-container input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="flex">

    <aside id="sidebar" class="sidebar backdrop-blur-md">
        <div class="p-4 flex items-center gap-4 h-16 border-b border-white/10 shrink-0">
            <button onclick="toggleSidebar()" class="text-white text-lg hover:text-indigo-400 w-6 text-center">
                <i class="fas fa-bars"></i>
            </button>
            <span class="font-bold text-lg tracking-wider italic logo-text text-indigo-400">FanConnect <span class="text-xs bg-indigo-600 text-white px-1 rounded ml-1 not-italic">V5.2.1</span></span>
        </div>

        <div class="profile-section">
            <input type="file" id="avatarUpload" class="hidden" accept="image/*" onchange="handleAvatarUpload(event)">
            <div class="profile-avatar-container" onclick="document.getElementById('avatarUpload').click()">
                <img id="userAvatar" src="https://ui-avatars.com/api/?name=Brand&background=4B0082&color=fff" class="profile-avatar" alt="Avatar">
                <div class="avatar-overlay"><i class="fas fa-camera text-white text-xs"></i></div>
            </div>
            <input type="text" id="userName" value="Brand Name" class="profile-name-input" onchange="saveProfile()" title="點擊編輯品牌名稱">
        </div>
        
        <nav class="flex-1 overflow-y-auto custom-scrollbar flex flex-col pt-2">
            <div>
                <a href="#" onclick="showSection('fans')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-indigo-500">
                      <i class="fas fa-users-cog w-6 text-center"></i> <span class="menu-text">粉絲管理列表</span>
                </a>
                <a href="#" onclick="showSection('manual')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-indigo-500">
                    <i class="fas fa-keyboard w-6 text-center"></i> <span class="menu-text">手動新增紀錄</span>
                </a>
                <a href="#" onclick="showSection('templates')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-indigo-500">
                    <i class="fas fa-pen-nib w-6 text-center"></i> <span class="menu-text">訊息模板設定</span>
                </a>
            </div>

            <div class="my-2 border-t border-white/10 mx-4 shrink-0"></div>
            
            <div>
                <a href="#" onclick="document.getElementById('excelImport').click()" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors">
                    <i class="fas fa-file-import w-6 text-center text-green-500"></i> <span class="menu-text">匯入 Excel/CSV</span>
                </a>
                <a href="#" onclick="exportToExcel()" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors">
                    <i class="fas fa-file-export w-6 text-center text-blue-400"></i> <span class="menu-text">匯出 Excel</span>
                </a>
            </div>

            <div class="my-2 border-t border-white/10 mx-4 shrink-0"></div>
            
            <div>
                <a href="#" onclick="backupData()" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors">
                    <i class="fas fa-cloud-download-alt w-6 text-center text-yellow-400"></i> <span class="menu-text">備份資料 (雲端)</span>
                </a>
                <a href="#" onclick="document.getElementById('restoreImport').click()" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors">
                    <i class="fas fa-cloud-upload-alt w-6 text-center text-yellow-400"></i> <span class="menu-text">還原資料 (雲端)</span>
                </a>
                <a href="#" onclick="clearAllData()" class="flex items-center gap-4 p-4 hover:bg-red-900/10 text-red-900 hover:text-red-500 transition-colors">
                    <i class="fas fa-trash-alt w-6 text-center"></i> <span class="menu-text font-bold text-[10px]">清空列表資料</span>
                </a>
            </div>
        </nav>

        <div class="p-4 border-t border-white/10 bg-black/20 shrink-0">
            <a href="https://www.instagram.com" target="_blank" class="flex items-center gap-4 text-sm text-gray-400 hover:text-white group">
                <i class="fab fa-instagram w-6 text-center text-pink-500 group-hover:scale-110 transition-transform"></i> 
                <span class="menu-text font-bold">開啟 Instagram</span>
            </a>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden relative">
        <input type="file" id="excelImport" class="hidden" accept=".xlsx, .xls, .csv" onchange="handleExcelImport(event)">
        <input type="file" id="restoreImport" class="hidden" accept=".json" onchange="handleRestore(event)">

        <header class="h-16 border-b border-white/10 flex justify-between items-center px-6 bg-[#121212] shrink-0">
            <h2 id="sectionTitle" class="text-xl font-bold text-white tracking-wide">粉絲滿意度管理系統</h2>
            <div class="flex gap-4 items-center">
                <div class="relative">
                    <select id="sortSelect" onchange="renderTable()" class="bg-[#222] border border-gray-700 text-gray-300 text-sm rounded-full pl-3 pr-8 py-1.5 focus:outline-none focus:border-indigo-500 appearance-none cursor-pointer hover:bg-[#333]">
                        <option value="az">字母順序 (A-Z)</option>
                        <option value="za">字母順序 (Z-A)</option>
                        <option value="date_desc">活動日期 (新→舊)</option>
                        <option value="date_asc">活動日期 (舊→新)</option>
                    </select>
                    <i class="fas fa-sort absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-xs pointer-events-none"></i>
                </div>

                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-xs"></i>
                    <input type="text" id="globalSearch" placeholder="搜尋帳號 / 互動..." 
                           class="bg-[#222] border border-gray-700 rounded-full pl-8 pr-4 py-1.5 text-sm focus:outline-none focus:border-indigo-500 w-64 transition-all"
                           onkeyup="renderTable()">
                </div>
            </div>
        </header>

        <div id="contentArea" class="flex-1 overflow-hidden p-0 bg-[#0a0a0a]">
            
            <div id="fansSection" class="h-full p-4 flex flex-col">
                <div class="bg-[#151515] rounded-lg border border-white/5 flex-1 overflow-hidden relative shadow-xl">
                    <div class="table-container custom-scrollbar">
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr>
                                    <th width="4%" class="text-center sticky-col-1"><i class="fas fa-star text-yellow-500"></i></th>
                                    <th width="15%" class="sticky-col-2">帳號名稱 (點擊開啟)</th>
                                    <th width="8%">暱稱</th>
                                    <th width="15%" class="text-indigo-300"><i class="fas fa-history mr-1"></i>最新動態</th>
                                    <th width="20%">互動標籤</th>
                                    <th width="23%">詳細內容</th>
                                    <th width="8%">訊息狀態</th>
                                    <th width="7%" class="text-center sticky-col-last">操作</th>
                                </tr>
                            </thead>
                            <tbody id="fanTableBody"></tbody>
                        </table>
                        
                        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-gray-500">
                            <i class="fas fa-file-csv text-4xl mb-4 opacity-50"></i>
                            <p>尚無資料，請匯入 Excel/CSV 或手動新增</p>
                            <p class="text-xs text-gray-600 mt-2">提示：若暱稱抓取失敗，請確認 Excel 欄位名稱包含「暱稱」、「Name」</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="manualSection" class="hidden h-full p-8 overflow-y-auto">
                <div class="max-w-3xl mx-auto bg-[#1a1a1a] p-8 rounded-2xl border border-indigo-500/20 shadow-2xl">
                    <h3 class="text-2xl font-bold mb-6 text-indigo-400 border-b border-white/10 pb-4">
                        <i class="fas fa-plus-circle mr-2"></i>手動新增互動紀錄
                    </h3>
                    
                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="block text-gray-400 text-xs mb-2">帳號名稱 (@Username) <span class="text-red-500">*</span></label>
                                <input type="text" id="manualUsername" placeholder="輸入帳號" class="input-dark py-3" oninput="validateInput(this)">
                                <p class="text-[10px] text-red-500 mt-1 hidden" id="manualUsernameErr">格式錯誤</p>
                            </div>
                            <div>
                                <label class="block text-gray-400 text-xs mb-2">暱稱 (選填)</label>
                                <input type="text" id="manualNickname" placeholder="粉絲怎麼稱呼？" class="input-dark py-3">
                            </div>
                        </div>

                        <div class="bg-black/20 p-4 rounded-lg border border-white/5">
                            <div class="mb-3 text-indigo-300 text-sm font-bold">互動類型 (可多選)</div>
                            <div class="grid grid-cols-4 gap-3 interaction-checkboxes">
                                <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 text-pink-400 font-bold border border-pink-900/30 bg-pink-900/10 p-2 rounded"><input type="checkbox" value="粉絲" class="accent-indigo-500"> 粉絲</label>
                                <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="留言" class="accent-indigo-500"> 留言</label>
                                <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="讚" class="accent-indigo-500"> 讚</label>
                                <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="投票" class="accent-indigo-500"> 投票</label>
                                <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="分享" class="accent-indigo-500"> 分享</label>
                                <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="回覆" class="accent-indigo-500"> 回覆</label>
                                <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="提及" class="accent-indigo-500"> 提及</label>
                                <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="轉發" class="accent-indigo-500"> 轉發</label>
                            </div>
                        </div>

                        <div class="mt-4">
                            <label class="block text-gray-400 text-xs mb-2">最新互動/活動日期</label>
                            <div class="date-segment-container">
                                <input type="text" id="dateYYYY" maxlength="4" placeholder="YYYY" style="width: 40px;">
                                <span class="text-gray-500">/</span>
                                <input type="text" id="dateMM" maxlength="2" placeholder="MM" style="width: 24px;">
                                <span class="text-gray-500">/</span>
                                <input type="text" id="dateDD" maxlength="2" placeholder="DD" style="width: 24px;">
                            </div>
                        </div>

                        <div>
                            <label class="block text-gray-400 text-xs mb-2">詳細內容</label>
                            <textarea id="manualDetails" placeholder="例如：限動投票「A選項」" class="input-dark h-32"></textarea>
                        </div>

                        <button onclick="addManualInteraction()" class="btn-indigo w-full py-3 rounded-lg font-bold text-white text-lg shadow-lg hover:shadow-indigo-500/50">
                            新增並更新
                        </button>
                    </div>
                </div>
            </div>

            <div id="templatesSection" class="hidden h-full p-8 overflow-y-auto">
                <div class="max-w-3xl mx-auto">
                    <div class="bg-[#1a1a1a] p-6 rounded-xl border border-white/10 mb-8">
                        <h3 class="text-xl font-bold mb-4 text-indigo-300">訊息模板設定</h3>
                        <div class="space-y-4">
                            <input type="hidden" id="tmpId">
                            <input type="text" id="tmpTitle" placeholder="模板標題" class="input-dark">
                            <div class="relative">
                                <textarea id="tmpBody" placeholder="輸入訊息內容... &#10;提示：輸入 {link} 可自動帶入生成的加密連結" class="input-dark h-32"></textarea>
                                <div class="absolute bottom-2 right-2 text-xs text-gray-500">可用變數: {nickname}, {link}</div>
                            </div>
                            <div class="flex gap-2">
                                <button id="saveTmpBtn" onclick="addTemplate()" class="btn-indigo flex-1 py-2 rounded font-bold text-white">儲存模板</button>
                                <button id="cancelTmpBtn" onclick="cancelEditTemplate()" class="hidden bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-white">取消</button>
                            </div>
                        </div>
                    </div>
                    <div id="templateListDisplay" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="msgModal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-[100] backdrop-blur-sm">
        <div class="bg-[#1a1a1a] border border-indigo-500/50 w-[600px] rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-indigo-900/20 p-4 border-b border-indigo-500/30 flex justify-between items-center">
                <h3 class="text-indigo-300 font-bold text-lg">發送訊息</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex items-center justify-between text-sm text-gray-400 bg-black/40 p-2 rounded">
                    <span>目標帳號：<span id="targetUser" class="text-white font-mono"></span></span>
                    <span>稱呼：<span id="targetNickname" class="text-indigo-300"></span></span>
                </div>

                <div class="bg-indigo-900/10 p-3 rounded border border-indigo-500/20">
                    <label class="text-[10px] uppercase tracking-wider text-indigo-400 font-bold mb-2 block flex justify-between">
                        <span><i class="fas fa-shield-alt mr-1"></i>安全追蹤連結 (Next.js)</span>
                        <span class="text-gray-500 font-normal normal-case">已啟用 24h 時效加密</span>
                    </label>
                    <div class="flex gap-2">
                        <input type="text" id="targetLinkInput" placeholder="輸入私密網址 (例: https://devon.com/vault/v1)" class="input-dark text-xs h-9">
                        <button onclick="generateHashLink()" id="genLinkBtn" class="btn-indigo px-4 py-1 rounded text-xs whitespace-nowrap font-bold h-9">
                            <i class="fas fa-lock mr-1"></i>加密生成
                        </button>
                    </div>
                    <input type="hidden" id="finalGeneratedLink">
                    <p class="text-[10px] text-gray-500 mt-1 italic">* 系統將「粉絲帳號+目前時間」打包加密成亂碼參數，Next.js 端需解碼驗證。</p>
                </div>

                <select id="modalTempSelect" onchange="applyTemplate()" class="input-dark">
                    <option value="">-- 選擇模板 --</option>
                </select>
                <textarea id="modalText" class="w-full bg-black border border-indigo-500/30 p-4 rounded h-40 text-sm leading-relaxed text-gray-200 focus:border-indigo-500 focus:outline-none"></textarea>
            </div>
            <div class="p-4 bg-black/20 border-t border-white/5 flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-400 hover:text-white text-sm">取消</button>
                <button onclick="confirmSend()" class="btn-indigo px-6 py-2 rounded text-white font-bold flex items-center gap-2">
                    <i class="fas fa-copy"></i> 複製並開啟 IG
                </button>
            </div>
        </div>
    </div>

    <div id="editFanModal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-[110] backdrop-blur-sm">
        <div class="bg-[#1a1a1a] border border-indigo-500/30 w-[650px] rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-[#202020] p-4 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-indigo-400 font-bold text-lg"><i class="fas fa-edit mr-2"></i>編輯粉絲資料</h3>
                <button onclick="closeEditFanModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-5">
                <input type="hidden" id="editFanId">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-400 text-xs mb-2">帳號名稱 (@Username)</label>
                        <input type="text" id="editFanUsername" class="input-dark" oninput="validateInput(this)">
                        <p class="text-[10px] text-red-500 mt-1 hidden" id="editFanUsernameErr">格式錯誤</p>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-xs mb-2">暱稱 (Nickname)</label>
                        <input type="text" id="editFanNickname" class="input-dark">
                    </div>
                </div>
                
                <div class="bg-black/20 p-4 rounded border border-white/5">
                    <label class="block text-gray-400 text-xs mb-2">編輯互動標籤</label>
                    <div class="grid grid-cols-4 gap-3" id="editFanCheckboxes">
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 text-pink-400 font-bold"><input type="checkbox" value="粉絲" class="accent-indigo-500"> 粉絲</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="留言" class="accent-indigo-500"> 留言</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="讚" class="accent-indigo-500"> 讚</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="投票" class="accent-indigo-500"> 投票</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="分享" class="accent-indigo-500"> 分享</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="回覆" class="accent-indigo-500"> 回覆</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="提及" class="accent-indigo-500"> 提及</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="轉發" class="accent-indigo-500"> 轉發</label>
                    </div>
                    <div id="editFanExtraTags" class="mt-3 flex flex-wrap gap-2 text-xs"></div>
                </div>

                <div>
                    <label class="block text-gray-400 text-xs mb-2">詳細內容</label>
                    <textarea id="editFanDetails" class="input-dark h-24"></textarea>
                </div>
            </div>
            <div class="p-4 bg-black/20 border-t border-white/5 flex justify-end gap-3">
                <button onclick="closeEditFanModal()" class="px-4 py-2 text-gray-400 hover:text-white text-sm">取消</button>
                <button onclick="saveFanEdit()" class="btn-indigo px-6 py-2 rounded text-white font-bold">儲存變更</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 right-8 bg-indigo-600 text-white px-6 py-3 rounded shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-[200]">
        操作成功
    </div>

    <script>
        let fans = JSON.parse(localStorage.getItem('fans')) || [];
        let templates = JSON.parse(localStorage.getItem('templates')) || [
            { id: 1, title: "感謝支持", body: "嗨 {nickname}，感謝你之前的支持！這裡有給你的專屬禮物：\n{link}" }
        ];
        let activeFanId = null;

        // V5.0: Profile Management
        function loadProfile() {
            const profile = JSON.parse(localStorage.getItem('userProfile')) || { name: 'Brand Name', avatar: 'https://ui-avatars.com/api/?name=Brand&background=4B0082&color=fff' };
            document.getElementById('userName').value = profile.name;
            document.getElementById('userAvatar').src = profile.avatar;
        }

        function saveProfile() {
            const name = document.getElementById('userName').value;
            const avatar = document.getElementById('userAvatar').src;
            localStorage.setItem('userProfile', JSON.stringify({ name, avatar }));
            showToast('個人品牌設定已儲存');
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('userAvatar').src = e.target.result;
                saveProfile();
            };
            reader.readAsDataURL(file);
        }

        function validateInput(input) {
            const regex = /^[a-zA-Z0-9._]+$/;
            const errId = input.id + "Err";
            const errEl = document.getElementById(errId);
            if (input.value && !regex.test(input.value)) {
                input.classList.add('input-error');
                if(errEl) errEl.classList.remove('hidden');
                return false;
            } else {
                input.classList.remove('input-error');
                if(errEl) errEl.classList.add('hidden');
                return true;
            }
        }

        // V5.0: 日期解析 (字串或數字)
        function parseDate(str) {
            if (!str) return 0;
            const d = new Date(str);
            return isNaN(d.getTime()) ? 0 : d.getTime();
        }

        // V5.0: Excel 數字日期轉字串 (處理 46016 -> 2025/12/25)
        function excelDateToJSDate(serial) {
           var utc_days  = Math.floor(serial - 25569);
           var utc_value = utc_days * 86400;
           var date_info = new Date(utc_value * 1000);
           return date_info.toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'});
        }

        function renderTable() {
            const tbody = document.getElementById('fanTableBody');
            const search = document.getElementById('globalSearch').value.toLowerCase();
            const sortType = document.getElementById('sortSelect').value;
            const emptyState = document.getElementById('emptyState');
            
            tbody.innerHTML = '';
            let filteredFans = fans.filter(f => 
                (f.username || '').toLowerCase().includes(search) || 
                (f.nickname || '').toLowerCase().includes(search) || 
                (f.interactions || []).join('').toLowerCase().includes(search) || 
                (f.details || '').toLowerCase().includes(search)
            );
            if (filteredFans.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                const starredFans = filteredFans.filter(f => f.isCloseFriend);
                const otherFans = filteredFans.filter(f => !f.isCloseFriend);
                const sorter = (a, b) => {
                    if (sortType === 'za') {
                        return b.username.toLowerCase().localeCompare(a.username.toLowerCase());
                    } else if (sortType === 'date_desc') { 
                        return parseDate(b.latestDate) - parseDate(a.latestDate);
                    } else if (sortType === 'date_asc') {
                        return parseDate(a.latestDate) - parseDate(b.latestDate);
                    } else { 
                        return a.username.toLowerCase().localeCompare(b.username.toLowerCase());
                    }
                };

                starredFans.sort(sorter);
                otherFans.sort(sorter);
                const finalFans = [...starredFans, ...otherFans];
                
                finalFans.forEach(fan => {
                    const row = document.createElement('tr');
                    row.className = 'table-row';
                    
                    const statusHtml = fan.sent 
                        ? `<div class="flex flex-col"><span class="text-green-400 text-xs font-bold border border-green-400/30 px-2 py-0.5 rounded w-fit">✓ 已發送</span><span class="text-[10px] text-gray-500 mt-1">${fan.sentDate || ''}</span></div>`
                        : `<span class="text-amber-500 text-xs font-bold border border-amber-500/30 px-2 py-0.5 rounded w-fit">● 待處理</span>`;

                    const latestInfo = (fan.latestDate || fan.latestType) 
                        ? `<div class="flex flex-col">
                             <span class="text-white font-bold text-xs">${fan.latestType || '無'}</span>
                             <span class="text-[10px] text-gray-500">${fan.latestDate || '未知日期'}</span>
                             </div>`
                        : `<span class="text-gray-600 text-xs">-</span>`;
                    const isValidAccount = /^[a-zA-Z0-9._]+$/.test(fan.username);
                    const nameClass = isValidAccount 
                        ? "text-indigo-300 hover:text-indigo-100 hover:underline" 
                        : "text-red-800 font-bold hover:text-red-600 hover:underline";
                    const tooltip = isValidAccount ? '開啟 Instagram' : '格式錯誤：含有不允許的字元';
                    
                    const accountLink = `<span class="${nameClass} cursor-pointer" onclick="handleAccountClick(this, '${fan.username}')" title="${tooltip}">@${fan.username}</span>`;
                    const tagsHtml = fan.interactions.map(tag => {
                        // V5.0: "新粉絲"已在存入時轉為"粉絲"，此處僅做樣式渲染
                        const style = tag === '粉絲' 
                            ? 'bg-pink-900/40 text-pink-200 border-pink-500/30' 
                            : 'bg-white/5 text-gray-300 border-white/10';
                        return `<span class="px-2 py-0.5 rounded text-xs border whitespace-nowrap ${style}">${tag}</span>`;
                    }).join('');
                    const starClass = fan.isCloseFriend ? 'star-active' : 'star-inactive';
                    const starHtml = `<i class="fas fa-star ${starClass} star-btn" onclick="toggleStar(${fan.id})"></i>`;
                    // V5.1 RWD: Added sticky classes to tds
                    row.innerHTML = `
                        <td class="text-center sticky-col-1">${starHtml}</td>
                        <td class="font-medium sticky-col-2">${accountLink}</td>
                        <td class="text-gray-300 text-xs">${fan.nickname || '-'}</td>
                        <td class="bg-indigo-900/10 border-l border-r border-indigo-900/30">
                            ${latestInfo}
                        </td>
                        <td>
                            <div class="flex flex-wrap gap-1">
                                ${tagsHtml}
                            </div>
                        </td>
                        <td>
                            <div class="text-xs text-gray-400 line-clamp-2 hover:line-clamp-none transition-all cursor-help" title="${fan.details}">
                                ${fan.details.split('/').map(d => `<span class="block border-b border-dashed border-white/10 pb-0.5 mb-0.5 last:border-0">${d.trim()}</span>`).join('')}
                            </div>
                        </td>
                        <td>${statusHtml}</td>
                        <td class="text-center sticky-col-last">
                            <div class="flex justify-center gap-1">
                                <button onclick="openModal(${fan.id})" class="group btn-indigo px-2 py-1.5 rounded text-xs text-white font-bold" title="發訊息">
                                     <i class="fas fa-paper-plane"></i>
                                </button>
                                <button onclick="openEditFanModal(${fan.id})" class="bg-gray-700 hover:bg-gray-600 text-white px-2 py-1.5 rounded text-xs transition-colors" title="編輯資料">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteFan(${fan.id})" class="bg-red-900/30 hover:bg-red-600 text-red-400 hover:text-white px-2 py-1.5 rounded text-xs transition-colors" title="刪除">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        function handleAccountClick(element, username) {
            window.open(`https://www.instagram.com/${username}`, '_blank');
            element.classList.remove('text-indigo-300', 'hover:text-indigo-100');
            element.classList.add('visited-link');
        }

        function toggleStar(id) {
            const fan = fans.find(f => f.id === id);
            if(fan) {
                fan.isCloseFriend = !fan.isCloseFriend;
                saveData();
                renderTable();
            }
        }

        // V5.2 Update: Date Input Logic
        function initDateInput() {
            const today = new Date();
            const els = [
                { id: 'dateYYYY', val: today.getFullYear(), max: 4 },
                { id: 'dateMM', val: String(today.getMonth()+1).padStart(2,'0'), max: 2 },
                { id: 'dateDD', val: String(today.getDate()).padStart(2,'0'), max: 2 }
            ];

            const inputs = els.map((c, i) => {
                const el = document.getElementById(c.id);
                el.value = c.val;
                
                el.addEventListener('focus', function() { this.select(); });
                el.addEventListener('click', function() { this.select(); });
                
                el.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    if(this.value.length >= c.max) {
                        if(i < els.length - 1) {
                            // V5.2.1 Fix: Use setTimeout to ensure the last char is processed before focus shift
                            setTimeout(() => {
                                document.getElementById(els[i+1].id).focus();
                            }, 0);
                        }
                    }
                });
                return el;
            });
        }

        function addManualInteraction() {
            const usernameInput = document.getElementById('manualUsername');
            if (!validateInput(usernameInput)) {
                return alert("帳號格式錯誤，請檢查紅框欄位");
            }
            const username = usernameInput.value.trim();
            const nickname = document.getElementById('manualNickname').value.trim();
            if (!username) return alert("請輸入帳號");

            const checkedBoxes = document.querySelector('#manualSection .interaction-checkboxes').querySelectorAll('input:checked');
            let tags = Array.from(checkedBoxes).map(cb => cb.value);
            // V5.0: 強制轉換 "新粉絲" -> "粉絲"
            tags = tags.map(t => (t === '新粉絲') ? '粉絲' : t);
            const details = document.getElementById('manualDetails').value.trim();
            
            // V5.2 Update: Capture manual date input
            const y = document.getElementById('dateYYYY').value;
            const m = document.getElementById('dateMM').value.padStart(2, '0');
            const d = document.getElementById('dateDD').value.padStart(2, '0');
            const manualDateStr = `${y}/${m}/${d}`;

            const existingFan = fans.find(f => f.username === username);
            if (existingFan) {
                const typeSet = new Set([...existingFan.interactions, ...tags]);
                existingFan.interactions = Array.from(typeSet);
                
                if (details) existingFan.details = existingFan.details ? existingFan.details + " / " + details : details;
                if (nickname) existingFan.nickname = nickname;
                
                if (parseDate(manualDateStr) >= parseDate(existingFan.latestDate)) {
    existingFan.latestType = tags.join(' / ');
    existingFan.latestDate = manualDateStr;
}
 // V5.2: Use manual date
                existingFan.sent = false;
                showToast(`已更新 @${username}`);
            } else {
                fans.push({
                    id: Date.now(),
                    username, nickname, 
                    interactions: tags,
                    latestType: tags.join(' / '),
                    latestDate: manualDateStr, // V5.2: Use manual date
                    details, 
                    sent: false, 
                    sentDate: '',
                    isCloseFriend: false
                });
                showToast(`已新增 @${username}`);
            }
            
            usernameInput.value = '';
            document.getElementById('manualNickname').value = '';
            document.getElementById('manualDetails').value = '';
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            // Reset Date to Today (optional, but good UX)
            initDateInput();
            saveData(); renderTable();
        }

        function openEditFanModal(id) {
            const fan = fans.find(f => f.id === id);
            if(!fan) return;
            document.getElementById('editFanId').value = id;
            document.getElementById('editFanUsername').value = fan.username;
            document.getElementById('editFanNickname').value = fan.nickname || '';
            document.getElementById('editFanDetails').value = fan.details || '';
            const checkContainer = document.getElementById('editFanCheckboxes');
            const inputs = checkContainer.querySelectorAll('input');
            const standardTags = [];
            inputs.forEach(input => {
                standardTags.push(input.value);
                // V5.0: 編輯時 Checkbox 回填邏輯
                let checkVal = input.value;
                if (checkVal === '新粉絲') checkVal = '粉絲';
                input.checked = fan.interactions.includes(checkVal);
            });

            const extraTags = fan.interactions.filter(t => !standardTags.includes(t));
            const extraContainer = document.getElementById('editFanExtraTags');
            if(extraTags.length > 0) {
                extraContainer.innerHTML = '其它標籤(點擊刪除): ' + extraTags.map(t => 
                    `<span onclick="removeExtraTag(${id}, '${t}')" class="cursor-pointer hover:bg-red-900 border border-white/20 px-1 rounded ml-1 bg-white/5">${t} <i class="fas fa-times text-[10px]"></i></span>`
                ).join('');
            } else {
                extraContainer.innerHTML = '';
            }
            document.getElementById('editFanModal').classList.remove('hidden');
        }

        function removeExtraTag(fanId, tag) {
            const fan = fans.find(f => f.id === fanId);
            if(fan) {
                fan.interactions = fan.interactions.filter(t => t !== tag);
                saveData();
                openEditFanModal(fanId);
            }
        }

        function saveFanEdit() {
            const id = parseFloat(document.getElementById('editFanId').value);
            const fan = fans.find(f => f.id === id);
            if(fan) {
                const usernameInput = document.getElementById('editFanUsername');
                if(!validateInput(usernameInput)) return alert("帳號格式錯誤");
                
                fan.username = usernameInput.value.trim();
                fan.nickname = document.getElementById('editFanNickname').value.trim();
                fan.details = document.getElementById('editFanDetails').value.trim();
                
                const checked = Array.from(document.querySelectorAll('#editFanCheckboxes input:checked')).map(cb => cb.value);
                // V5.0: 編輯儲存時也強制轉換
                const checkedClean = checked.map(t => (t === '新粉絲') ? '粉絲' : t);
                const standardValues = Array.from(document.querySelectorAll('#editFanCheckboxes input')).map(cb => cb.value);
                const currentExtra = fan.interactions.filter(t => !standardValues.includes(t));
                
                fan.interactions = Array.from(new Set([...checkedClean, ...currentExtra]));

                saveData(); renderTable();
                closeEditFanModal(); showToast('資料已更新');
            }
        }
        function closeEditFanModal() { document.getElementById('editFanModal').classList.add('hidden');
        }

        // V5.0: 清空列表資料 (使用 Brand Name 驗證)
        function clearAllData() {
            const currentBrandName = document.getElementById('userName').value.trim();
            const firstConfirm = confirm("⚠️ 警告：這將永久刪除所有粉絲列表資料，且無法還原！\n\n您確定要繼續嗎？");
            
            if (firstConfirm) {
                const userInput = prompt(`為了確保安全，請輸入您的品牌名稱「${currentBrandName}」以執行刪除：`);
                if (userInput === currentBrandName) {
                    fans = [];
                    saveData();
                    renderTable();
                    showToast("所有資料已清空");
                } else {
                    alert("名稱輸入錯誤，操作已取消。");
                }
            }
        }

        // --- Excel 匯入 ---
        function handleExcelImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(firstSheet, { defval: "" });
                    let newCount = 0, updateCount = 0;
                    
                    const todayStr = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
                    const nicknameKeywords = [
                        '暱稱', 'nickname', 'display', 'display_name', 'profile', 'profile_name', 
                        'full name', 'full_name', 'name', 'title', 'owner_name', 'owner_full_name',
                        '稱呼', '姓名', '名稱'
                    ];

                    const dateKeywords = ['活動日期', '日期', 'date', 'time', '時間'];
                    json.forEach(row => {
                        const getVal = (keywords) => {
                            const key = Object.keys(row).find(k => keywords.some(kw => k.toLowerCase().includes(kw)));
                            return key ? row[key] : '';
                        };

                        const usernameRaw = getVal(['帳號', 'user', 'name', 'id', 'username']).toString().trim();
                        if (!usernameRaw) return;

                        let nicknameRaw = getVal(nicknameKeywords).toString().trim();
                        
                        // V5.0: 日期判斷邏輯 (數字轉日期)
                        let rawDateVal = getVal(dateKeywords);
                        let fileDate = "";
                        
                        if (typeof rawDateVal === 'number') {
                            fileDate = excelDateToJSDate(rawDateVal);
                        } else {
                            fileDate = rawDateVal.toString().trim();
                        }
                        
                        if (!fileDate) {
                            fileDate = todayStr;
                        }
                        
                        const typeRaw = getVal(['互動', 'type']).toString();
                        let rawTypes = typeRaw.split(/[\/,，]/).map(s => s.trim()).filter(s => s); 
                        // V5.0: 強制轉換
                        rawTypes = rawTypes.map(t => (t === '新粉絲' || t === 'New Fan') ? '粉絲' : t);
                        const detailRaw = getVal(['詳細', 'content', 'details']).toString().trim();

                        const existingFan = fans.find(f => f.username === usernameRaw);
                        if (existingFan) {
                            existingFan.interactions = Array.from(new Set([...existingFan.interactions, ...rawTypes]));
                            if (detailRaw && !existingFan.details.includes(detailRaw)) existingFan.details += " / " + detailRaw;
                            if (nicknameRaw && !existingFan.nickname) existingFan.nickname = nicknameRaw;
                            existingFan.interactions = Array.from(new Set([...existingFan.interactions, ...rawTypes]));
if (detailRaw && !existingFan.details.includes(detailRaw)) existingFan.details += " / " + detailRaw;

// 最新動態判斷更新
if (parseDate(fileDate) >= parseDate(existingFan.latestDate)) {
    existingFan.latestType = rawTypes.join(' / ');
    existingFan.latestDate = fileDate;
}
existingFan.sent = false;
                            updateCount++;
                        } else {
                            fans.push({
                                id: Date.now() + Math.random(),
                                username: usernameRaw,
                                nickname: nicknameRaw,
                                interactions: rawTypes,
                                latestType: rawTypes.join(' / '),
                                latestDate: fileDate,
                                details: detailRaw,
                                sent: false, sentDate: '',
                                isCloseFriend: false 
                            });
                            newCount++;
                        }
                    });
                    saveData(); renderTable();
                    showToast(`匯入成功：新 ${newCount} / 更 ${updateCount}`);
                    e.target.value = '';
                } catch (err) { alert("匯入失敗：" + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function exportToExcel() {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const dateStr = `${yyyy}${mm}${dd}`;
            const ws = XLSX.utils.json_to_sheet(fans.map(f => ({
                '帳號名稱': f.username, 
                '暱稱': f.nickname,
                '互動類型': f.interactions.join(' / '), 
                '最新互動/活動日期': f.latestDate,
                '詳細內容/選項': f.details,
                '是否為摯友': f.isCloseFriend ? 'Yes' : 'No'
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Fans");
            XLSX.writeFile(wb, `FanConnect_Export_${dateStr}.xlsx`);
        }

        function deleteFan(id) {
            if(confirm('刪除資料？')) { fans = fans.filter(f => f.id !== id);
            saveData(); renderTable(); showToast('已刪除'); }
        }
        function openModal(id) {
            activeFanId = id;
            const fan = fans.find(f => f.id === id); if(!fan) return;
            document.getElementById('targetUser').innerText = "@" + fan.username;
            document.getElementById('targetNickname').innerText = fan.nickname || fan.username;
            document.getElementById('modalText').value = "";
            document.getElementById('modalTempSelect').innerHTML = '<option value="">-- 選擇模板 --</option>' + templates.map(t => `<option value="${t.id}">${t.title}</option>`).join('');
            
            document.getElementById('targetLinkInput').value = '';
            document.getElementById('finalGeneratedLink').value = '';
            const btn = document.getElementById('genLinkBtn');
            btn.innerHTML = '<i class="fas fa-lock mr-1"></i>加密生成';
            btn.classList.remove('bg-green-600');
            
            document.getElementById('msgModal').classList.remove('hidden');
        }
        function confirmSend() {
            const fan = fans.find(f => f.id === activeFanId);
            const text = document.getElementById('modalText').value;
            navigator.clipboard.writeText(text).then(() => {
                fan.sent = true; const now = new Date();
                fan.sentDate = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                saveData(); renderTable(); closeModal(); window.open(`https://ig.me/m/${fan.username}`, '_blank');
            });
        }

        function generateHashLink() {
            const rawUrl = document.getElementById('targetLinkInput').value.trim();
            const fan = fans.find(f => f.id === activeFanId);
            
            if (!rawUrl) return alert("請先輸入目標網址！");
            if (!fan) return alert("找不到粉絲資料");
            const payloadObj = {
                u: fan.username,
                ts: Date.now() 
            };
            const encodedPayload = btoa(JSON.stringify(payloadObj));
            const separator = rawUrl.includes('?') ? '&' : '?';
            const finalLink = `${rawUrl}${separator}token=${encodedPayload}`;

            document.getElementById('finalGeneratedLink').value = finalLink;
            const btn = document.getElementById('genLinkBtn');
            btn.innerHTML = '<i class="fas fa-check"></i> 已生成';
            btn.classList.add('bg-green-600');
            if(document.getElementById('modalTempSelect').value) {
                applyTemplate();
            }
        }

        function applyTemplate() {
            const tId = document.getElementById('modalTempSelect').value;
            const fan = fans.find(f => f.id === activeFanId);
            const template = templates.find(t => t.id == tId);
            const generatedLink = document.getElementById('finalGeneratedLink').value || "(尚未生成連結)";

            if(template) {
                let content = template.body;
                content = content.replace(/{nickname}/g, fan.nickname || fan.username);
                content = content.replace(/{link}|{url}/g, generatedLink);
                document.getElementById('modalText').value = content;
            }
        }

        function saveData() { localStorage.setItem('fans', JSON.stringify(fans));
        }
        function closeModal() { document.getElementById('msgModal').classList.add('hidden');
        }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.remove('translate-y-20', 'opacity-0');
        setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000); }
        function addTemplate() {
            const id = document.getElementById('tmpId').value;
            const title = document.getElementById('tmpTitle').value; const body = document.getElementById('tmpBody').value;
            if(!title || !body) return;
            if(id) { const t = templates.find(x => x.id == id); t.title = title; t.body = body;
            }
            else { templates.push({ id: Date.now(), title, body });
            }
            localStorage.setItem('templates', JSON.stringify(templates)); cancelEditTemplate(); renderTemplateList();
        }
        function editTemplate(id) {
            const t = templates.find(x => x.id === id);
            document.getElementById('tmpId').value = t.id; document.getElementById('tmpTitle').value = t.title; document.getElementById('tmpBody').value = t.body;
            document.getElementById('saveTmpBtn').innerText = "更新模板"; document.getElementById('cancelTmpBtn').classList.remove('hidden');
        }
        function cancelEditTemplate() {
            document.getElementById('tmpId').value = '';
            document.getElementById('tmpTitle').value = ''; document.getElementById('tmpBody').value = '';
            document.getElementById('saveTmpBtn').innerText = "儲存模板"; document.getElementById('cancelTmpBtn').classList.add('hidden');
        }
        function deleteTemplate(id) { if(confirm('刪除模板？')) { templates = templates.filter(t => t.id !== id);
        localStorage.setItem('templates', JSON.stringify(templates)); renderTemplateList(); } }
        function renderTemplateList() {
            document.getElementById('templateListDisplay').innerHTML = templates.map(t => `
                <div class="flex justify-between items-center bg-black/30 p-3 rounded border border-white/5">
                    <div><div class="font-bold text-indigo-200 text-sm">${t.title}</div><div class="text-xs text-gray-500 truncate w-64">${t.body}</div></div>
                    <div><button onclick="editTemplate(${t.id})" class="text-gray-400 hover:text-white px-2"><i class="fas fa-edit"></i></button><button onclick="deleteTemplate(${t.id})" class="text-gray-600 hover:text-red-500 px-2"><i class="fas fa-trash"></i></button></div>
                </div>`).join('');
        }
        
        function backupData() {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const filename = `FanConnect_Backup_${yyyy}${mm}${dd}.json`;
            const link = document.createElement('a');
            link.href = 'data:application/json;charset=utf-8,'+ encodeURIComponent(JSON.stringify({ fans, templates })); 
            link.download = filename; 
            link.click();
        }
        
        function handleRestore(e) {
            const r = new FileReader();
            r.onload = (ev) => { try { const o = JSON.parse(ev.target.result); if(confirm(`還原 ${o.fans.length} 筆？`)) { fans=o.fans; templates=o.templates; saveData(); localStorage.setItem('templates', JSON.stringify(templates));
            renderTable(); renderTemplateList(); } } catch(e){alert("格式誤");} }; r.readAsText(e.target.files[0]);
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed');
        }
        function showSection(s) { ['fans', 'manual', 'templates'].forEach(x => document.getElementById(x+'Section').classList.add('hidden')); document.getElementById(s+'Section').classList.remove('hidden'); if(s==='templates') renderTemplateList();
        }

        window.onload = () => { loadProfile(); renderTable(); renderTemplateList(); initDateInput(); };
    </script>
</body>
</html>