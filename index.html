<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FanConnect V5.2.23 - 粉絲滿意度管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --indigo-primary: #4B0082; }
        body { background: linear-gradient(135deg, #1a1a1a 0%, #050505 100%); color: #e0e0e0; height: 100vh; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
       
        .sidebar { background-color: rgba(75, 0, 130, 0.15); border-right: 1px solid rgba(75, 0, 130, 0.3); transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); width: 260px; display: flex; flex-direction: column; }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .menu-text, .sidebar.collapsed .logo-text, .sidebar.collapsed .profile-section { display: none; }
       
        .profile-section { text-align: center; padding: 20px 10px; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .profile-avatar-container { position: relative; width: 60px; height: 60px; margin: 0 auto 10px; cursor: pointer; }
        .profile-avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid #a78bfa; transition: all 0.3s; }
        .avatar-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .profile-avatar-container:hover .avatar-overlay { opacity: 1; }
        .profile-name-input { background: transparent; border: none; border-bottom: 1px solid transparent; color: white; text-align: center; font-weight: bold; font-size: 0.9rem; width: 100%; padding: 4px; transition: all 0.3s; }
        .profile-name-input:focus { outline: none; border-bottom: 1px solid #a78bfa; }
 
        .table-container { height: calc(100vh - 140px); overflow-y: auto; overflow-x: auto; position: relative; }
        .table-row:hover { background-color: rgba(75, 0, 130, 0.2); transition: background-color 0.2s; }
        table { border-collapse: separate; border-spacing: 0; width: 100%; }
 
        @media (max-width: 768px) { table { min-width: 900px; } }
 
        .sticky-col-1 { position: sticky; left: 0; z-index: 25; background-color: #151515; }
        .sticky-col-2 { position: sticky; left: 40px; z-index: 25; background-color: #151515; border-right: 1px solid #333; }
        .sticky-col-last { position: sticky; right: 0; z-index: 25; background-color: #151515; border-left: 1px solid #333; }
 
        th.sticky-col-1, th.sticky-col-2, th.sticky-col-last { z-index: 30; background-color: #202020; }
       
        .table-row:hover .sticky-col-1,
        .table-row:hover .sticky-col-2,
        .table-row:hover .sticky-col-last { background-color: #2a1b3d; }
 
        th { background-color: #202020; position: sticky; top: 0; z-index: 20; padding: 10px; text-align: left; font-size: 0.8rem; color: #aaa; letter-spacing: 1px; border-bottom: 2px solid #4B0082; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        td { padding: 8px 10px; border-bottom: 1px solid #333; vertical-align: middle; }
       
        .thread-badge { background-color: #000; color: #fff; border: 1px solid #4b5563; }
        .fan-badge-style { background-color: rgba(131, 24, 67, 0.4); color: #fbcfe8; border: 1px solid rgba(236, 72, 153, 0.3); box-shadow: 0 0 10px rgba(236, 72, 153, 0.3); }
 
        .btn-indigo { background-color: var(--indigo-primary); transition: all 0.2s; }
        .btn-indigo:hover { background-color: #5a009d; box-shadow: 0 0 15px rgba(75, 0, 130, 0.5); transform: translateY(-1px); }
        .input-dark { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 4px; padding: 8px 12px; width: 100%; transition: border-color 0.3s; }
        .input-dark:focus { outline: none; border-color: #4B0082; }
        .input-error { border-color: #ef4444 !important; background-color: rgba(239, 68, 68, 0.1); }
       
        .visited-link { color: #047857 !important; text-decoration: none !important; font-weight: bold; transition: color 0.3s; }
        .star-btn { transition: transform 0.2s, color 0.2s; cursor: pointer; }
        .star-btn:hover { transform: scale(1.2); }
        .star-active { color: #fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        .star-inactive { color: #4b5563; }
 
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #4B0082; border-radius: 4px; }
 
        .date-segment-container { display: flex; align-items: center; gap: 4px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 4px 8px; width: fit-content; }
        .date-segment-container input { background: transparent; border: none; color: white; text-align: center; padding: 4px 0; outline: none; width: 100%; }
        .date-segment-container input:focus { border-bottom: 1px solid #a78bfa; }
    </style>
</head>
<body class="flex">
 
    <aside id="sidebar" class="sidebar backdrop-blur-md">
        <div class="p-4 flex items-center gap-4 h-16 border-b border-white/10 shrink-0">
            <button onclick="toggleSidebar()" class="text-white text-lg hover:text-indigo-400 w-6 text-center">
                <i class="fas fa-bars"></i>
            </button>
            <span class="font-bold text-lg tracking-wider italic logo-text text-indigo-400">FanConnect <span class="text-xs bg-indigo-600 text-white px-1 rounded ml-1 not-italic">V5.2.23</span></span>
        </div>
 
        <div class="profile-section">
            <input type="file" id="avatarUpload" class="hidden" accept="image/*" onchange="handleAvatarUpload(event)">
            <div class="profile-avatar-container" onclick="document.getElementById('avatarUpload').click()">
                <img id="userAvatar" src="https://ui-avatars.com/api/?name=Brand&background=4B0082&color=fff" class="profile-avatar" alt="Avatar">
                <div class="avatar-overlay"><i class="fas fa-camera text-white text-xs"></i></div>
            </div>
            <input type="text" id="userName" value="Brand Name" class="profile-name-input" onchange="saveProfile()" title="點擊編輯品牌名稱">
        </div>
       
        <nav class="flex-1 overflow-y-auto custom-scrollbar flex flex-col pt-2">
            <div>
                <a href="#" onclick="showSection('fans')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-indigo-500">
                    <i class="fas fa-users-cog w-6 text-center"></i> <span class="menu-text">粉絲管理列表</span>
                </a>
                <a href="#" onclick="showSection('manual')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-indigo-500">
                    <i class="fas fa-keyboard w-6 text-center"></i> <span class="menu-text">手動新增紀錄</span>
                </a>
                <a href="#" onclick="showSection('templates')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-indigo-500">
                    <i class="fas fa-pen-nib w-6 text-center"></i> <span class="menu-text">訊息模板設定</span>
                </a>
            </div>
 
            <div class="my-2 border-t border-white/10 mx-4 shrink-0"></div>
 
            <div>
                <a href="#" onclick="showSection('igPosts')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-pink-500">
                    <i class="fab fa-instagram w-6 text-center text-pink-400"></i> <span class="menu-text">IG 貼文列表</span>
                </a>
                <a href="#" onclick="showSection('giftPosts')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-purple-500">
                    <i class="fas fa-gift w-6 text-center text-purple-400"></i> <span class="menu-text">禮物貼文列表</span>
                </a>
                <a href="#" onclick="showSection('heartStats')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-red-500">
                    <i class="fas fa-heart w-6 text-center text-red-400"></i> <span class="menu-text">粉絲暖心互動</span>
                </a>
            </div>
 
            <div class="my-2 border-t border-white/10 mx-4 shrink-0"></div>
           






            


<div>
                <a href="#" onclick="showSection('decrypt')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-teal-500">
                    <i class="fas fa-key w-6 text-center text-teal-400"></i> <span class="menu-text">連結解密 / 驗證</span>
                </a>
            </div>
 
            <div class="my-2 border-t border-white/10 mx-4 shrink-0"></div>


            <div>
                <a href="#" onclick="showSection('history')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-cyan-500">
                    <i class="fas fa-history w-6 text-center text-cyan-400"></i> <span class="menu-text">動態紀錄</span>
                </a>
                <a href="#" onclick="showSection('compare')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-orange-500">
                    <i class="fas fa-exchange-alt w-6 text-center text-orange-400"></i> <span class="menu-text">官方資料比對</span>
                </a>
            </div>


            <div class="my-2 border-t border-white/10 mx-4 shrink-0"></div>
            
            <div>
                <a href="#" onclick="backupData()" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors">












                    <i class="fas fa-save w-6 text-center text-yellow-400"></i> <span class="menu-text">備份資料</span>
                </a>
                <a href="#" onclick="document.getElementById('restoreImport').click()" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors">
                    <i class="fas fa-folder-open w-6 text-center text-yellow-400"></i> <span class="menu-text">還原資料</span>
                </a>
                <a href="#" onclick="document.getElementById('excelImport').click()" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors">
                    <i class="fas fa-file-import w-6 text-center text-green-400"></i> <span class="menu-text">匯入 Excel</span>
                </a>
                <a href="#" onclick="exportExcel()" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors">
                    <i class="fas fa-file-export w-6 text-center text-green-400"></i> <span class="menu-text">匯出 Excel</span>
                </a>
                <a href="#" onclick="clearAllData()" class="flex items-center gap-4 p-4 hover:bg-red-900/10 text-red-900 hover:text-red-500 transition-colors">
                    <i class="fas fa-trash-alt w-6 text-center"></i> <span class="menu-text font-bold text-[10px]">清空列表資料</span>
                </a>
            </div>
        </nav>
 
        <div class="p-4 border-t border-white/10 bg-black/20 shrink-0">
            <a href="https://www.instagram.com" target="_blank" class="flex items-center gap-4 text-sm text-gray-400 hover:text-white group">
                <i class="fab fa-instagram w-6 text-center text-pink-500 group-hover:scale-110 transition-transform"></i>
                <span class="menu-text font-bold">開啟 Instagram</span>
            </a>
        </div>
    </aside>
 
    <main class="flex-1 flex flex-col overflow-hidden relative">
        <input type="file" id="excelImport" class="hidden" accept=".xlsx, .xls, .csv" onchange="handleExcelImport(event)">
        <input type="file" id="restoreImport" class="hidden" accept=".json" onchange="handleRestore(event)">
 
        <header class="h-16 border-b border-white/10 flex justify-between items-center px-6 bg-[#121212] shrink-0">
            <h2 id="sectionTitle" class="text-xl font-bold text-white tracking-wide">粉絲滿意度管理系統</h2>
           
            <div class="flex gap-4 items-center">
                <div class="flex items-center gap-1 p-1">
                    <button onclick="undo()" class="p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded transition-colors text-sm" title="復原 (Ctrl+Z)">
                        <i class="fas fa-undo"></i>
                    </button>
                    <div class="w-[1px] h-3 bg-white/10 my-auto"></div>
                    <button onclick="redo()" class="p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded transition-colors text-sm" title="重作 (Ctrl+Y)">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
 
                <div id="fanCountBadge" class="fan-badge-style px-4 py-1.5 rounded-full text-xs font-bold transition-all">
                    粉絲人數: 0
                </div>
 
                <div class="relative group">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-xs"></i>
                    <input type="text" id="globalSearch" placeholder="搜尋帳號 / 互動..."
                           class="bg-[#222] border border-gray-700 rounded-full pl-8 pr-8 py-1.5 text-sm focus:outline-none focus:border-indigo-500 w-64 transition-all"
                           onkeyup="handleGlobalSearch(); document.getElementById('clearSearchBtn').classList.toggle('hidden', this.value.length === 0)">
                
     <button onclick="clearSearch()" id="clearSearchBtn" class="hidden absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-white" title="清除搜尋">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>

            </div>
        </header>
 
         <div id="contentArea" class="flex-1 overflow-hidden p-0 bg-[#0a0a0a]">
           
            <div id="fansSection" class="h-full p-4 flex flex-col">
                <div class="bg-[#151515] rounded-lg border border-white/5 flex-1 overflow-hidden relative shadow-xl">
                    <div class="table-container custom-scrollbar">
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr>
                                    <th width="4%" class="text-center sticky-col-1"><i class="fas fa-star text-yellow-500"></i></th>
                                    <th width="15%" class="sticky-col-2 cursor-pointer select-none"
                                        onmousedown="startHeaderLongPress(event, 'username')"
                                        onmouseup="cancelHeaderLongPress()"
                                        onmouseleave="cancelHeaderLongPress()"
                                        ontouchstart="startHeaderLongPress(event, 'username')"
                                        ontouchend="cancelHeaderLongPress()">
                                        帳號名稱
                                    </th>
                                    <th width="8%">暱稱</th>
                                    <th width="15%" class="text-indigo-300 cursor-pointer select-none"
                                        onmousedown="startHeaderLongPress(event, 'status')"
                                        onmouseup="cancelHeaderLongPress()"
                                        onmouseleave="cancelHeaderLongPress()"
                                        ontouchstart="startHeaderLongPress(event, 'status')"
                                        ontouchend="cancelHeaderLongPress()">
                                        <i class="fas fa-history mr-1"></i>最新動態
                                    </th>
                                    <th width="20%" class="cursor-pointer select-none"
                                        onmousedown="startHeaderLongPress(event, 'interactions')"
                                        onmouseup="cancelHeaderLongPress()"
                                        onmouseleave="cancelHeaderLongPress()"
                                        ontouchstart="startHeaderLongPress(event, 'interactions')"
                                        ontouchend="cancelHeaderLongPress()">
                                        互動標籤
                                    </th>
                                    <th width="23%">詳細內容</th>
                                    <th width="8%" class="cursor-pointer select-none"
                                        onmousedown="startHeaderLongPress(event, 'sent')"
                                        onmouseup="cancelHeaderLongPress()"
                                        onmouseleave="cancelHeaderLongPress()"
                                        ontouchstart="startHeaderLongPress(event, 'sent')"
                                        ontouchend="cancelHeaderLongPress()">
                                        訊息
                                    </th>
                                    <th width="7%" class="text-center sticky-col-last">操作</th>
                                </tr>
                            </thead>
                            <tbody id="fanTableBody"></tbody>
                        </table>
                        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-gray-500">
                            <i class="fas fa-file-csv text-4xl mb-4 opacity-50"></i>
                            <p>尚無資料，請匯入 Excel/CSV 或手動新增</p>
                            <p class="text-xs text-gray-600 mt-2">提示：若暱稱抓取失敗，請確認 Excel 欄位名稱包含「暱稱」、「Name」</p>
                        </div>
                    </div>
                </div>
            </div>
 
            <div id="manualSection" class="hidden h-full p-8 overflow-y-auto">
                <div class="max-w-3xl mx-auto bg-[#1a1a1a] rounded-2xl border border-indigo-500/20 shadow-2xl overflow-hidden">
                    <div class="flex border-b border-white/10 bg-[#222]">
                        <button onclick="switchManualTab('standard')" id="tabBtnStd" class="flex-1 py-4 text-center font-bold text-indigo-400 border-b-2 border-indigo-500 bg-[#1a1a1a]">
                            <i class="fas fa-keyboard mr-2"></i>手動新增互動紀錄
                        </button>
                        <button onclick="switchManualTab('heart')" id="tabBtnHeart" class="flex-1 py-4 text-center font-bold text-gray-500 hover:text-pink-400 hover:bg-[#2a1a1a] transition-all">
                            <i class="fas fa-heart mr-2"></i>暖心時刻
                        </button>
                    </div>
 
                    <div class="p-8">
                        <div id="manualStandardForm" class="space-y-6 block">
                            <div class="grid grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-gray-400 text-xs mb-2">帳號名稱 (@Username) <span class="text-red-500">*</span></label>
                                    <input type="text" id="manualUsername" list="usernameOptions" placeholder="輸入帳號" class="input-dark py-3" oninput="validateInput(this); autoFillManualNickname()">
                                    <datalist id="usernameOptions"></datalist>
                                    <p class="text-[10px] text-red-500 mt-1 hidden" id="manualUsernameErr">格式錯誤</p>
                                </div>
                                <div>
                                    <label class="block text-gray-400 text-xs mb-2">暱稱 / 語言</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="manualNickname" placeholder="粉絲稱呼" class="input-dark py-3 w-[70%]">
                                        <select id="manualLang" class="input-dark py-3 w-[30%] text-center">
                                            <option value="中" selected>中</option>
                                            <option value="英">英</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-black/20 p-4 rounded-lg border border-white/5">
                                <div class="mb-3 text-indigo-300 text-sm font-bold">互動類型 (可多選)</div>
                                <div class="grid grid-cols-4 gap-3 interaction-checkboxes">
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 text-pink-400 font-bold border border-pink-900/30 bg-pink-900/10 p-2 rounded"><input type="checkbox" value="粉絲" class="accent-indigo-500"> 粉絲</label>
  
                                  <label class="flex items-center gap-2 cursor-pointer hover:text-[#763BE3] p-2 text-[#763BE3] font-bold"><input type="checkbox" value="前帳粉" class="accent-[#763BE3]"> 前帳粉</label>
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-amber-400 p-2 text-amber-500 font-bold"><input type="checkbox" value="高互動" class="accent-amber-500"> 高互動</label>
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-white p-2 text-gray-300 font-bold bg-black/40 rounded border border-gray-600"><input type="checkbox" value="Thread粉" class="accent-gray-500"> Thread粉</label>
                               
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="留言" class="accent-indigo-500"> 留言</label>
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="讚" class="accent-indigo-500"> 讚</label>
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="投票" class="accent-indigo-500"> 投票</label>
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="分享" class="accent-indigo-500"> 分享</label>
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="回覆" class="accent-indigo-500"> 回覆</label>
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="提及" class="accent-indigo-500"> 提及</label>
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="轉發" class="accent-indigo-500"> 轉發</label>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-gray-400 text-xs mb-2">最新互動/活動日期</label>
                                <div class="date-segment-container">
                                    <input type="text" id="dateYYYY" maxlength="4" placeholder="YYYY" style="width: 40px;">
                                    <span class="text-gray-500">/</span>
                                    <input type="text" id="dateMM" maxlength="2" placeholder="MM" style="width: 24px;">
                                    <span class="text-gray-500">/</span>
                                    <input type="text" id="dateDD" maxlength="2" placeholder="DD" style="width: 24px;">
                                </div>
                            </div>
                            <div>
                                <label class="block text-gray-400 text-xs mb-2">詳細內容</label>
                                <textarea id="manualDetails" placeholder="例如：限動投票「A選項」" class="input-dark h-32"></textarea>
                            </div>
                            <button onclick="addManualInteraction()" class="btn-indigo w-full py-3 rounded-lg font-bold text-white text-lg shadow-lg hover:shadow-indigo-500/50">新增並更新</button>
                        </div>
 
                        <div id="manualHeartForm" class="hidden space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-400 text-xs mb-2">粉絲帳號 <span class="text-red-500">*</span></label>
                                    <input type="text" id="heartUser" list="usernameOptions" placeholder="輸入帳號" class="input-dark py-3" onchange="autoFillHeartNickname()">
                                </div>
                                <div>
                                    <label class="block text-gray-400 text-xs mb-2">粉絲暱稱 (自動帶入)</label>
                                    <input type="text" id="heartNick" class="input-dark py-3" readonly>
                                </div>
                            </div>
                            <div>
                                <label class="block text-gray-400 text-xs mb-2">回應日期</label>
                                <div class="date-segment-container">
                                    <input type="text" id="heartDateYYYY" maxlength="4" placeholder="YYYY" style="width: 40px;">
                                    <span class="text-gray-500">/</span>
                                    <input type="text" id="heartDateMM" maxlength="2" placeholder="MM" style="width: 24px;">
                                    <span class="text-gray-500">/</span>
                                    <input type="text" id="heartDateDD" maxlength="2" placeholder="DD" style="width: 24px;">
                                </div>
                            </div>
                            <div>
                                <label class="block text-gray-400 text-xs mb-2">回應項目</label>
                                <select id="heartResponseItem" class="input-dark py-3">
                                    <option value="DM">DM (私訊)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-400 text-xs mb-2">回應內容 (可換行)</label>
                                <textarea id="heartContent" placeholder="輸入暖心回應內容..." class="input-dark h-32"></textarea>
                            </div>
                            <button onclick="addHeartData()" class="w-full py-3 rounded-lg font-bold text-white text-lg shadow-lg bg-pink-700 hover:bg-pink-600 transition-all">新增暖心紀錄</button>
                        </div>
                    </div>
                </div>
            </div>
 
            <div id="igPostsSection" class="hidden h-full flex flex-col p-4">
                <div class="w-full max-w-6xl mx-auto flex flex-col h-full">
                    <div class="bg-[#1a1a1a] p-4 rounded-xl border border-white/10 mb-4 shrink-0 shadow-lg z-10">
                        <h3 class="text-lg font-bold mb-3 text-pink-400"><i class="fab fa-instagram mr-2"></i>IG 貼文管理</h3>
                        <div class="grid grid-cols-4 gap-3 mb-3">
                            <input type="text" id="igTopic" placeholder="主題" class="input-dark text-xs">
                            <textarea id="igFile" placeholder="檔案名稱 (可 Enter 換行)" class="input-dark text-xs h-10 py-2 resize-none leading-normal"></textarea>
                            <textarea id="igContent" placeholder="內文 (可 Enter 換行)" class="input-dark text-xs h-10 py-2 resize-none leading-normal"></textarea>
                            <input type="text" id="igHash" placeholder="#hashtag" class="input-dark text-xs">
                        </div>
                        <div class="flex items-center gap-4 mb-3">
                            <div class="flex items-center gap-2">
                                <label class="text-gray-400 text-xs whitespace-nowrap">發布日期</label>
                                <div class="date-segment-container">
                                    <input type="text" id="igDateYYYY" maxlength="4" placeholder="YYYY" style="width: 40px;">
                                    <span class="text-gray-500">/</span>
                                    <input type="text" id="igDateMM" maxlength="2" placeholder="MM" style="width: 24px;">
                                    <span class="text-gray-500">/</span>
                                    <input type="text" id="igDateDD" maxlength="2" placeholder="DD" style="width: 24px;">
                                </div>
                            </div>
                            <button onclick="addIgPost()" class="btn-indigo flex-1 py-1.5 rounded font-bold text-white text-sm">新增貼文資料</button>
                        </div>
                    </div>
                    <div class="bg-[#151515] rounded-lg border border-white/5 flex-1 overflow-hidden relative shadow-xl">
                         <div class="h-full overflow-y-auto custom-scrollbar">
                            <table class="w-full text-left text-sm">
                                <thead>
                                    <tr>
                                        <th width="15%" class="sticky top-0 bg-[#202020] z-20 shadow-md">主題</th>
                                        <th width="10%" class="sticky top-0 bg-[#202020] z-20 shadow-md">日期</th>
                                        <th width="30%" class="sticky top-0 bg-[#202020] z-20 shadow-md">內文</th>
                                        <th width="20%" class="sticky top-0 bg-[#202020] z-20 shadow-md">檔案名稱</th>
                                        <th width="15%" class="sticky top-0 bg-[#202020] z-20 shadow-md">Hashtag</th>
                                        <th width="10%" class="text-center sticky top-0 bg-[#202020] z-20 shadow-md">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="igPostTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
 
            <div id="giftPostsSection" class="hidden h-full flex flex-col p-4">
                <div class="w-full max-w-6xl mx-auto flex flex-col h-full">
                    <div class="bg-[#1a1a1a] p-4 rounded-xl border border-white/10 mb-4 shrink-0 shadow-lg z-10">
                        <h3 class="text-lg font-bold mb-3 text-purple-400"><i class="fas fa-gift mr-2"></i>禮物貼文管理</h3>
                        <div class="grid grid-cols-3 gap-3 mb-3">
                            <input type="text" id="giftId" placeholder="禮物 ID" class="input-dark text-xs">
                            <textarea id="giftFile" placeholder="檔案名稱 (可 Enter 換行)" class="input-dark text-xs h-10 py-2 resize-none leading-normal"></textarea>
                            <textarea id="giftDesc" placeholder="描述 (可 Enter 換行)" class="input-dark text-xs h-10 py-2 resize-none leading-normal"></textarea>
                        </div>
                        <div class="flex items-center gap-4 mb-3">
                            <div class="flex items-center gap-2">
                                <label class="text-gray-400 text-xs whitespace-nowrap">發布日期</label>
                                <div class="date-segment-container">
                                    <input type="text" id="giftDateYYYY" maxlength="4" placeholder="YYYY" style="width: 40px;">
                                    <span class="text-gray-500">/</span>
                                    <input type="text" id="giftDateMM" maxlength="2" placeholder="MM" style="width: 24px;">
                                    <span class="text-gray-500">/</span>
                                    <input type="text" id="giftDateDD" maxlength="2" placeholder="DD" style="width: 24px;">
                                </div>
                            </div>
                            <button onclick="addGiftPost()" class="btn-indigo flex-1 py-1.5 rounded font-bold text-white text-sm">新增禮物資料</button>
                        </div>
                    </div>
                    <div class="bg-[#151515] rounded-lg border border-white/5 flex-1 overflow-hidden relative shadow-xl">
                        <div class="h-full overflow-y-auto custom-scrollbar">
                            <table class="w-full text-left text-sm">
                                <thead>
                                    <tr>
                                        <th width="15%" class="sticky top-0 bg-[#202020] z-20 shadow-md">禮物 ID</th>
                                        <th width="15%" class="sticky top-0 bg-[#202020] z-20 shadow-md">日期</th>
                                        <th width="20%" class="sticky top-0 bg-[#202020] z-20 shadow-md">檔案名稱</th>
                                        <th width="40%" class="sticky top-0 bg-[#202020] z-20 shadow-md">描述</th>
                                        <th width="10%" class="text-center sticky top-0 bg-[#202020] z-20 shadow-md">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="giftPostTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
 
            <div id="heartStatsSection" class="hidden h-full flex flex-col p-8">
                <div class="w-full max-w-5xl mx-auto flex flex-col h-full bg-[#1a1a1a] p-8 rounded-2xl border border-red-500/20 shadow-2xl">
                    <h3 class="text-2xl font-bold mb-6 text-red-400 border-b border-white/10 pb-4 shrink-0">
                        <i class="fas fa-heart mr-2"></i>暖心互動紀錄表
                    </h3>
                    <div class="bg-[#151515] rounded-lg border border-white/5 flex-1 overflow-hidden relative">
                         <div class="h-full overflow-y-auto custom-scrollbar">
                            <table class="w-full text-left text-sm">
                                <thead>
                                    <tr>
                        
                                        <th width="15%" class="sticky top-0 bg-[#202020] z-20 shadow-md">粉絲帳號</th>
                                        <th width="10%" class="sticky top-0 bg-[#202020] z-20 shadow-md">粉絲暱稱</th>
                                
                                        <th width="10%" class="sticky top-0 bg-[#202020] z-20 shadow-md">回應日期</th>
                                        <th width="10%" class="sticky top-0 bg-[#202020] z-20 shadow-md">回應項目</th>
                                        
                                        <th width="30%" class="sticky top-0 bg-[#202020] z-20 shadow-md">回應內容</th>
                                        <th width="8%" class="sticky top-0 bg-[#202020] z-20 shadow-md">訊息</th>
                                        <th width="7%" class="text-center sticky top-0 bg-[#202020] z-20 shadow-md">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="heartTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
 
            <div id="templatesSection" class="hidden h-full p-8 overflow-y-auto">
                <div class="max-w-3xl mx-auto">
                    <div class="bg-[#1a1a1a] p-6 rounded-xl border border-white/10 mb-8">
                        <h3 class="text-xl font-bold mb-4 text-indigo-300">訊息模板設定</h3>
                        <div class="space-y-4">
                            <input type="hidden" id="tmpId">
                            <input type="text" id="tmpTitle" placeholder="模板標題" class="input-dark">
                            <div class="relative">
                                <textarea id="tmpBody" placeholder="輸入訊息內容... &#10;提示：輸入 {link} 可自動帶入生成的加密連結" class="input-dark h-32"></textarea>
                                <div class="absolute bottom-2 right-2 text-xs text-gray-500">可用變數: {nickname}, {link}</div>
                            </div>
                            <div class="flex gap-2">
                                <button id="saveTmpBtn" onclick="addTemplate()" class="btn-indigo flex-1 py-2 rounded font-bold text-white">儲存模板</button>
                                <button id="cancelTmpBtn" onclick="cancelEditTemplate()" class="hidden bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-white">取消</button>
                            </div>
                        </div>
                    </div>
                    <div id="templateListDisplay" class="space-y-3"></div>
                </div>
            </div>
 
            <div id="decryptSection" class="hidden h-full p-8 overflow-y-auto">
                <div class="max-w-2xl mx-auto bg-[#1a1a1a] p-8 rounded-2xl border border-teal-500/30 shadow-2xl">
                    <h3 class="text-2xl font-bold mb-6 text-teal-400 border-b border-white/10 pb-4">連結解密與驗證</h3>
                    <div class="space-y-6">
                        <div>
                            <label class="block text-gray-400 text-xs mb-2">貼上完整加密連結 或 Token 亂碼</label>
                            <textarea id="decryptInput" placeholder="例如: https://.../vault/secure/eyJ..." class="input-dark h-24 font-mono text-xs"></textarea>
                        </div>
                        <button onclick="runDecryption()" class="w-full py-3 rounded-lg font-bold text-black bg-teal-500 hover:bg-teal-400 shadow-lg transition-all">開始解密</button>
                        <div id="decryptResult" class="hidden bg-black/40 p-4 rounded border border-white/10 font-mono text-sm space-y-3">
                            <div class="flex justify-between border-b border-white/10 pb-2"><span class="text-gray-500">狀態</span><span id="resStatus" class="font-bold"></span></div>
                            <div class="flex justify-between"><span class="text-gray-500">貼文 ID (PID)</span><span id="resPid" class="text-yellow-400"></span></div>
                            <div class="flex justify-between"><span class="text-gray-500">目標粉絲 (User)</span><span id="resUser" class="text-pink-400"></span></div>
                            <div class="flex justify-between"><span class="text-gray-500">生成時間</span><span id="resTime" class="text-blue-300"></span></div>
                            






<div class="flex justify-between"><span class="text-gray-500">有效期限</span><span id="resExpire" class="text-gray-300"></span></div>
                        </div>
                    </div>
                </div>
            </div>


            <div id="historySection" class="hidden h-full flex flex-col p-8">
                <div class="w-full max-w-5xl mx-auto flex flex-col h-full bg-[#1a1a1a] p-8 rounded-2xl border border-cyan-500/20 shadow-2xl">
                    <h3 class="text-2xl font-bold mb-6 text-cyan-400 border-b border-white/10 pb-4 flex justify-between items-center">
                        <span><i class="fas fa-history mr-2"></i>動態紀錄</span>
                        <button onclick="openHistoryModal()" class="text-sm bg-cyan-900/30 hover:bg-cyan-700 px-3 py-1 rounded text-cyan-200 border border-cyan-500/30">
                            <i class="fas fa-plus mr-1"></i>手動新增
                        </button>
                    </h3>
                    <div class="bg-[#151515] rounded-lg border border-white/5 flex-1 overflow-hidden relative">
                        <div class="h-full overflow-y-auto custom-scrollbar">
                            <table class="w-full text-left text-sm">
                                <thead>
                                    <tr>
                                        <th width="12%" class="sticky top-0 bg-[#202020] z-20 shadow-md">日期</th>
                                        <th width="15%" class="sticky top-0 bg-[#202020] z-20 shadow-md">帳號</th>
                                        <th width="12%" class="sticky top-0 bg-[#202020] z-20 shadow-md">暱稱</th>
                                        <th width="20%" class="sticky top-0 bg-[#202020] z-20 shadow-md">類型</th>
                                        <th width="30%" class="sticky top-0 bg-[#202020] z-20 shadow-md">詳細內容</th>
                                        <th width="11%" class="text-center sticky top-0 bg-[#202020] z-20 shadow-md">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>


            <div id="compareSection" class="hidden h-full flex flex-col p-8 overflow-y-auto">
                <div class="w-full max-w-6xl mx-auto space-y-6">
                    <div class="bg-[#1a1a1a] p-6 rounded-xl border border-orange-500/30 shadow-lg">
                        <h3 class="text-xl font-bold mb-4 text-orange-400"><i class="fab fa-instagram mr-2"></i>官方資料比對 (JSON)</h3>
                        <div class="flex items-center gap-4">
                            <input type="file" id="igJsonFile" accept=".json" class="hidden" onchange="handleIGJsonImport(event)">
                            <button onclick="document.getElementById('igJsonFile').click()" class="btn-indigo bg-orange-700 hover:bg-orange-600 text-white px-6 py-2 rounded font-bold">
                                <i class="fas fa-file-upload mr-2"></i>匯入 followers.json
                            </button>
                            <div class="text-xs text-gray-400">
                                請匯入 IG 官方下載資料中的 <code class="bg-black/30 px-1 rounded">followers_1.json</code>
                            </div>
                        </div>
                    </div>


                    <div id="newFansResult" class="hidden bg-[#1a1a1a] p-6 rounded-xl border border-green-500/30 shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-bold text-green-400">發現新粉絲 (<span id="newFansCount">0</span>)</h4>
                            <button onclick="confirmNewFans()" class="bg-green-700 hover:bg-green-600 text-white px-4 py-1.5 rounded text-sm font-bold shadow-lg">
                                <i class="fas fa-check mr-1"></i>確認加入列表
                            </button>
                        </div>
                        <div class="max-h-64 overflow-y-auto custom-scrollbar bg-[#151515] rounded border border-white/5">
                            <table class="w-full text-left text-sm">
                                <thead>
                                    <tr>
                                        <th class="sticky top-0 bg-[#202020] z-20">帳號名稱</th>
                                        <th class="sticky top-0 bg-[#202020] z-20">設定暱稱</th>
                                        <th class="sticky top-0 bg-[#202020] z-20">語系</th>
                                        <th class="sticky top-0 bg-[#202020] z-20">狀態</th>
                                    </tr>
                                </thead>
                                <tbody id="newFansBody"></tbody>
                            </table>
                        </div>
                    </div>


                    <div id="unfollowedResult" class="hidden bg-[#1a1a1a] p-6 rounded-xl border border-red-500/30 shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-bold text-red-400">疑似退追粉絲 (<span id="unfollowedCount">0</span>)</h4>
                            <button onclick="confirmUnfollowed()" class="bg-red-900/50 hover:bg-red-700 text-red-200 px-4 py-1.5 rounded text-sm font-bold shadow-lg">
                                <i class="fas fa-user-minus mr-1"></i>確認更新狀態
                            </button>
                        </div>
                        <div class="max-h-64 overflow-y-auto custom-scrollbar bg-[#151515] rounded border border-white/5">
                            <table class="w-full text-left text-sm">
                                <thead>
                                    <tr>
                                        <th class="sticky top-0 bg-[#202020] z-20">帳號名稱</th>
                                        <th class="sticky top-0 bg-[#202020] z-20">目前暱稱</th>
                                        <th class="sticky top-0 bg-[#202020] z-20">最後互動</th>
                                        <th class="sticky top-0 bg-[#202020] z-20">處理方式</th>
                                    </tr>
                                </thead>
                                <tbody id="unfollowedBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>


        <div id="historyModal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-[110] backdrop-blur-sm">
        <div class="bg-[#1a1a1a] border border-cyan-500/30 w-[700px] rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-[#202020] p-4 border-b border-white/10 flex justify-between items-center shrink-0">
                <h3 class="text-cyan-400 font-bold text-lg"><i class="fas fa-history mr-2"></i><span id="historyModalTitle">新增動態紀錄</span></h3>
                <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-5 overflow-y-auto custom-scrollbar flex-1">
                <input type="hidden" id="historyId">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-400 text-xs mb-2">帳號名稱 (@Username)</label>
                        <input type="text" id="histUsername" list="usernameOptions" class="input-dark" placeholder="輸入帳號">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-xs mb-2">暱稱</label>
                        <input type="text" id="histNickname" class="input-dark" placeholder="粉絲暱稱">
                    </div>
                </div>
                
                <div class="bg-black/20 p-4 rounded border border-white/5">
                    <label class="block text-gray-400 text-xs mb-2">互動類型 (可多選)</label>
                    <div class="grid grid-cols-4 gap-3" id="histCheckboxes">
                        <label class="flex items-center gap-2 cursor-pointer hover:text-cyan-300 text-pink-400 font-bold"><input type="checkbox" value="粉絲" class="accent-cyan-500"> 粉絲</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-[#763BE3] font-bold text-[#763BE3]"><input type="checkbox" value="前帳粉" class="accent-[#763BE3]"> 前帳粉</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-amber-300 
 font-bold text-amber-500"><input type="checkbox" value="高互動" class="accent-amber-500"> 高互動</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-white text-gray-300 font-bold bg-black/40 rounded px-1"><input type="checkbox" value="Thread粉" class="accent-gray-500"> Thread粉</label>
                        
                        <label class="flex items-center gap-2 cursor-pointer hover:text-cyan-300"><input type="checkbox" value="留言" class="accent-cyan-500"> 留言</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-cyan-300"><input type="checkbox" value="讚" class="accent-cyan-500"> 讚</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-cyan-300"><input type="checkbox" value="投票" class="accent-cyan-500"> 投票</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-cyan-300"><input type="checkbox" value="分享" class="accent-cyan-500"> 分享</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-cyan-300"><input type="checkbox" value="回覆" class="accent-cyan-500"> 回覆</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-cyan-300"><input type="checkbox" value="提及" class="accent-cyan-500"> 提及</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-cyan-300"><input type="checkbox" value="轉發" class="accent-cyan-500"> 轉發</label>
                    </div>
                </div>

                <div>
                    <label class="block text-gray-400 text-xs mb-2">活動日期 (YYYY/MM/DD)</label>
                    <div class="date-segment-container w-full bg-black/40">
                        <input type="text" id="histDateYYYY" maxlength="4" placeholder="YYYY" style="width: 60px;" class="text-center bg-transparent text-white outline-none">
                        <span class="text-gray-500">/</span>
                        <input type="text" id="histDateMM" maxlength="2" placeholder="MM" style="width: 40px;" class="text-center bg-transparent text-white outline-none">
                        <span class="text-gray-500">/</span>
                        <input type="text" id="histDateDD" maxlength="2" placeholder="DD" style="width: 40px;" class="text-center bg-transparent text-white outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-gray-400 text-xs mb-2">詳細內容</label>
                    <textarea id="histDetails" class="input-dark h-24" placeholder="詳細內容..."></textarea>
                </div>
            </div>
            <div class="p-4 bg-black/20 border-t border-white/5 flex justify-end gap-3">
                <button onclick="closeHistoryModal()" class="px-4 py-2 text-gray-400 hover:text-white text-sm">取消</button>
                <button onclick="saveHistoryData()" class="btn-indigo bg-cyan-700 hover:bg-cyan-600 px-6 py-2 rounded text-white font-bold">儲存紀錄</button>
            </div>
        </div>
    </div>









 
    <div id="msgModal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-[100] backdrop-blur-sm">
        <div class="bg-[#1a1a1a] border border-indigo-500/50 w-[600px] rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-indigo-900/20 p-4 border-b border-indigo-500/30 flex justify-between items-center">
                <h3 class="text-indigo-300 font-bold text-lg">發送訊息</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex items-center justify-between text-sm text-gray-400 bg-black/40 p-2 rounded">
                    <span>目標帳號：<span id="targetUser" class="text-white font-mono"></span></span>
                    <span>稱呼：<span id="targetNickname" class="text-indigo-300"></span></span>
                </div>
                <div class="bg-indigo-900/10 p-3 rounded border border-indigo-500/20">
                    <label class="text-[10px] uppercase tracking-wider text-indigo-400 font-bold mb-2 block flex justify-between">
                        <span><i class="fas fa-shield-alt mr-1"></i>安全追蹤連結 (Next.js)</span>
                        <span class="text-gray-500 font-normal normal-case">請選擇時效</span>
                    </label>
                    <div class="flex gap-2 items-center">
                        <select id="targetLinkInput" class="input-dark text-xs h-9 w-3/5">
                            <option value="">-- 選擇禮物 --</option>
                        </select>
                        <div class="flex items-center gap-2 text-[10px] text-gray-400 whitespace-nowrap px-1">
                            <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="linkExpiry" value="24" checked class="accent-indigo-500"> 24h</label>
                            <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="linkExpiry" value="168" class="accent-indigo-500"> 7day</label>
                        </div>
                        <button onclick="generateHashLink()" id="genLinkBtn" class="btn-indigo px-3 py-1 rounded text-xs whitespace-nowrap font-bold h-9 flex-1"><i class="fas fa-lock mr-1"></i>生成</button>
                    </div>
                    <input type="hidden" id="finalGeneratedLink">
                    <p class="text-[10px] text-gray-500 mt-1 italic">* 系統將「粉絲帳號+目前時間」打包加密成亂碼參數，Next.js 端需解碼驗證。</p>
                </div>
                <select id="modalTempSelect" onchange="applyTemplate()" class="input-dark"><option value="">-- 選擇模板 --</option></select>
                <textarea id="modalText" class="w-full bg-black border border-indigo-500/30 p-4 rounded h-40 text-sm leading-relaxed text-gray-200 focus:border-indigo-500 focus:outline-none"></textarea>
             </div>
            <div class="p-4 bg-black/20 border-t border-white/5 flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-400 hover:text-white text-sm">取消</button>
                <button onclick="confirmSend()" class="btn-indigo px-6 py-2 rounded text-white font-bold flex items-center gap-2"><i class="fas fa-copy"></i> 複製並開啟 IG</button>
            </div>
        </div>
    </div>
 
    <div id="editFanModal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-[110] backdrop-blur-sm">
        <div class="bg-[#1a1a1a] border border-indigo-500/30 w-[650px] rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-[#202020] p-4 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-indigo-400 font-bold text-lg"><i class="fas fa-edit mr-2"></i>編輯粉絲資料</h3>
                <button onclick="closeEditFanModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
             </div>
            <div class="p-6 space-y-5">
                <input type="hidden" id="editFanId">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-400 text-xs mb-2">帳號名稱 (@Username)</label>
                        <input type="text" id="editFanUsername" class="input-dark" oninput="validateInput(this)">
                        <p class="text-[10px] text-red-500 mt-1 hidden" id="editFanUsernameErr">格式錯誤</p>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-xs mb-2">暱稱 (Nickname)</label>
                        <input type="text" id="editFanNickname" class="input-dark">
                    </div>
                </div>
                 <div class="bg-black/20 p-4 rounded border border-white/5">
                    <label class="block text-gray-400 text-xs mb-2">編輯互動標籤</label>
                    <div class="grid grid-cols-4 gap-3" id="editFanCheckboxes">
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 text-pink-400 font-bold"><input type="checkbox" value="粉絲" class="accent-indigo-500"> 粉絲</label>
                        <label class="flex items-center gap-2 
 cursor-pointer hover:text-[#763BE3] text-[#763BE3] font-bold"><input type="checkbox" value="前帳粉" class="accent-[#763BE3]"> 前帳粉</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-amber-300 text-amber-500 font-bold"><input type="checkbox" value="高互動" class="accent-amber-500"> 高互動</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-white text-gray-300 font-bold bg-black/40 rounded px-1"><input type="checkbox" value="Thread粉" class="accent-gray-500"> Thread粉</label>

                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="留言" class="accent-indigo-500"> 留言</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="讚" class="accent-indigo-500"> 讚</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="投票" class="accent-indigo-500"> 投票</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="分享" class="accent-indigo-500"> 分享</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="回覆" class="accent-indigo-500"> 回覆</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="提及" class="accent-indigo-500"> 提及</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="轉發" class="accent-indigo-500"> 轉發</label>
                    </div>
                    <div id="editFanExtraTags" class="mt-3 flex flex-wrap gap-2 text-xs"></div>
                </div>
                <div>
                    <label class="block text-gray-400 text-xs mb-2">詳細內容</label>
                    <textarea id="editFanDetails" class="input-dark h-24"></textarea>
                </div>
            </div>
            <div class="p-4 bg-black/20 border-t border-white/5 flex justify-end gap-3">
                <button onclick="closeEditFanModal()" class="px-4 py-2 text-gray-400 hover:text-white text-sm">取消</button>
                <button onclick="saveFanEdit()" class="btn-indigo px-6 py-2 rounded text-white font-bold">儲存變更</button>
            </div>
        </div>
    </div>
 
    <div id="editIgModal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-[110] backdrop-blur-sm">
        <div class="bg-[#1a1a1a] border border-pink-500/30 w-[600px] rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-[#202020] p-4 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-pink-400 font-bold text-lg"><i class="fas fa-edit mr-2"></i>編輯 IG 貼文</h3>
                <button onclick="document.getElementById('editIgModal').classList.add('hidden')" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="editIgIndex">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-gray-400 text-xs mb-2">主題</label><input type="text" id="editIgTopic" class="input-dark"></div>
                    <div><label class="block text-gray-400 text-xs mb-2">日期 (YYYY/MM/DD)</label><input type="text" id="editIgDate" class="input-dark"></div>
                </div>
                <div><label class="block text-gray-400 text-xs mb-2">檔案名稱 (可換行)</label><textarea id="editIgFile" class="input-dark h-20"></textarea></div>
                <div><label class="block text-gray-400 text-xs mb-2">內文 (可換行)</label><textarea id="editIgContent" class="input-dark h-24"></textarea></div>
                <div><label class="block text-gray-400 text-xs mb-2">Hashtag</label><input type="text" id="editIgHash" class="input-dark"></div>
            </div>
            <div class="p-4 bg-black/20 border-t border-white/5 flex justify-end gap-3">
                <button onclick="document.getElementById('editIgModal').classList.add('hidden')" class="px-4 py-2 text-gray-400 hover:text-white text-sm">取消</button>
                <button onclick="saveIgPostEdit()" class="btn-indigo px-6 py-2 rounded text-white font-bold">儲存變更</button>
            </div>
        </div>
    </div>
 
    <div id="editGiftModal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-[110] backdrop-blur-sm">
        <div class="bg-[#1a1a1a] border border-purple-500/30 w-[600px] rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-[#202020] p-4 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-purple-400 font-bold text-lg"><i class="fas fa-edit mr-2"></i>編輯禮物貼文</h3>
                <button onclick="document.getElementById('editGiftModal').classList.add('hidden')" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="editGiftIndex">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-gray-400 text-xs mb-2">禮物 ID</label><input type="text" id="editGiftId" class="input-dark"></div>
                    <div><label class="block text-gray-400 text-xs mb-2">日期 (YYYY/MM/DD)</label><input type="text" id="editGiftDate" class="input-dark"></div>
                </div>
                <div><label class="block text-gray-400 text-xs mb-2">檔案名稱 (可換行)</label><textarea id="editGiftFile" class="input-dark h-20"></textarea></div>
                <div><label class="block text-gray-400 text-xs mb-2">描述 (可換行)</label><textarea id="editGiftDesc" class="input-dark h-24"></textarea></div>
            </div>
            <div class="p-4 bg-black/20 border-t border-white/5 flex justify-end gap-3">
                <button onclick="document.getElementById('editGiftModal').classList.add('hidden')" class="px-4 py-2 text-gray-400 hover:text-white text-sm">取消</button>
                <button onclick="saveGiftPostEdit()" class="btn-indigo px-6 py-2 rounded text-white font-bold">儲存變更</button>
            </div>
        </div>
    </div>
 
    <div id="editHeartModal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-[110] backdrop-blur-sm">
        <div class="bg-[#1a1a1a] border border-red-500/30 w-[600px] rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-[#202020] p-4 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-red-400 font-bold text-lg"><i class="fas fa-edit mr-2"></i>編輯暖心紀錄</h3>
                <button onclick="document.getElementById('editHeartModal').classList.add('hidden')" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="editHeartIndex">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-gray-400 text-xs mb-2">粉絲帳號</label><input type="text" id="editHeartUser" class="input-dark"></div>
                    <div><label class="block text-gray-400 text-xs mb-2">粉絲暱稱</label><input type="text" id="editHeartNick" class="input-dark"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-gray-400 text-xs mb-2">回應日期</label><input type="text" id="editHeartDate" class="input-dark"></div>
                    <div>
                        <label class="block text-gray-400 text-xs mb-2">回應項目</label>
                        <select id="editHeartItem" class="input-dark py-2">
                            <option value="DM">DM (私訊)</option>
                             <optgroup label="IG 貼文" id="editHeartItemIg"></optgroup>
                             <optgroup label="禮物 ID" id="editHeartItemGift"></optgroup>
                        </select>
                    </div>
                </div>
                <div><label class="block text-gray-400 text-xs mb-2">回應內容 (可換行)</label><textarea id="editHeartContent" class="input-dark h-24"></textarea></div>
            </div>
            <div class="p-4 bg-black/20 border-t border-white/5 flex justify-end gap-3">
                <button onclick="document.getElementById('editHeartModal').classList.add('hidden')" class="px-4 py-2 text-gray-400 hover:text-white text-sm">取消</button>
                <button onclick="saveHeartEdit()" class="btn-indigo px-6 py-2 rounded text-white font-bold">儲存變更</button>
            </div>
        </div>
    </div>
 
    <div id="toast" class="fixed bottom-8 right-8 bg-indigo-600 text-white px-6 py-3 rounded shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-[200]">操作成功</div>
 
    <div id="filterMenu" class="fixed z-[600] hidden bg-[#1a1a1a] border border-indigo-500/50 rounded-lg shadow-2xl flex-col w-64 max-h-[450px]" onclick="event.stopPropagation()">
        <div class="p-3 border-b border-white/10 flex justify-between items-center bg-[#252525]">
            <span class="text-indigo-400 font-bold text-sm"><i class="fas fa-sort-amount-down mr-2"></i>欄位操作</span>
            <button onclick="closeFilterMenu()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        <div id="sortSection" class="p-4 bg-[#2a2a2a]">
            <div id="filterContentContainer" class="space-y-3"></div>
        </div>
        <div class="p-3 border-t border-white/10 flex justify-end bg-[#252525]"><p class="text-[10px] text-gray-500">提示：點擊 X 關閉視窗</p></div>
    </div>
 
    <script>












let fans = JSON.parse(localStorage.getItem('fans')) || [];
        let templates = JSON.parse(localStorage.getItem('templates')) || [{ id: 1, title: "感謝支持", body: "嗨 {nickname}，感謝你之前的支持！這裡有給你的專屬禮物：\n{link}" }];
        let igPosts = JSON.parse(localStorage.getItem('igPosts')) || [];
        let giftPosts = JSON.parse(localStorage.getItem('giftPosts')) || [];
        let heartData = JSON.parse(localStorage.getItem('heartData')) || [];
        let historyData = JSON.parse(localStorage.getItem('historyData')) || []; // 新增動態紀錄


        // 自動為舊資料補上 ID
        heartData = heartData.map(d => ({ ...d, id: d.id || Date.now() + Math.random() }));
        historyData = historyData.map(d => ({ ...d, id: d.id || Date.now() + Math.random() }));


        let activeFanId = null;






















        
        let headerLongPressTimer;
        let activeSourceType = 'fan'; // 用於區分來源: 'fan' 或 'heart'
        let currentFilterCol = null;
        let activeSort = { col: 'status', order: 'new' }; // 預設排序
        let activeFilters = { pending: false, oldSent: false, tags: [] };
        let historyStack = [];
        let redoStack = [];
        const MAX_HISTORY = 50;
        let isUndoRedoAction = false;
 
        // 紀錄狀態到歷史 (全面升級：紀錄所有資料表狀態)
        function saveData(recordHistory = true) {
            if (recordHistory) {
                const snapshot = {
                    fans: localStorage.getItem('fans') || '[]',
                    igPosts: localStorage.getItem('igPosts') || '[]',
                    giftPosts: localStorage.getItem('giftPosts') || '[]',
                    heartData: localStorage.getItem('heartData') || '[]',
                    historyData: localStorage.getItem('historyData') || '[]'
                };
                historyStack.push(snapshot);
                if (historyStack.length > MAX_HISTORY) historyStack.shift();
                redoStack = [];
            }
            // 同步寫入 LocalStorage
            localStorage.setItem('fans', JSON.stringify(fans));
            localStorage.setItem('igPosts', JSON.stringify(igPosts));
            localStorage.setItem('giftPosts', JSON.stringify(giftPosts));
            localStorage.setItem('heartData', JSON.stringify(heartData));
            localStorage.setItem('historyData', JSON.stringify(historyData));
        }
 
        function undo() {
            if (historyStack.length === 0) return showToast("沒有可復原的動作");
            isUndoRedoAction = true;
            
            // 復原前，將當前狀態 Snapshot 推入 Redo
            const currentSnapshot = {
                fans: JSON.stringify(fans),
                igPosts: JSON.stringify(igPosts),
                giftPosts: JSON.stringify(giftPosts),
                heartData: JSON.stringify(heartData),
                historyData: JSON.stringify(historyData)
            };
            redoStack.push(currentSnapshot);

            const prevSnapshot = historyStack.pop();
            applySnapshot(prevSnapshot);
            
            showToast("已復原");
            isUndoRedoAction = false;
        }
 
        function redo() {
            if (redoStack.length === 0) return showToast("沒有可重作的動作");
            isUndoRedoAction = true;
            
            // 重作前，將當前狀態 Snapshot 推入 History
            const currentSnapshot = {
                fans: JSON.stringify(fans),
                igPosts: JSON.stringify(igPosts),
                giftPosts: JSON.stringify(giftPosts),
                heartData: JSON.stringify(heartData),
                historyData: JSON.stringify(historyData)
            };
            historyStack.push(currentSnapshot);

            const nextSnapshot = redoStack.pop();
            applySnapshot(nextSnapshot);

            showToast("已重作");
            isUndoRedoAction = false;
        }

        function applySnapshot(snap) {
            fans = JSON.parse(snap.fans);
            igPosts = JSON.parse(snap.igPosts);
            giftPosts = JSON.parse(snap.giftPosts);
            heartData = JSON.parse(snap.heartData);
            historyData = JSON.parse(snap.historyData);

            saveData(false); // 僅存檔，不重複推入歷史
            
            // 重新渲染所有畫面
            renderTable();
            renderIgPosts();
            renderGiftPosts();
            renderHeartData();
            if(document.getElementById('historySection')) renderHistory();
        }
 
        function loadProfile() {
            const profile = JSON.parse(localStorage.getItem('userProfile')) || { name: 'Brand Name', avatar: 'https://ui-avatars.com/api/?name=Brand&background=4B0082&color=fff' };
            document.getElementById('userName').value = profile.name;
            document.getElementById('userAvatar').src = profile.avatar;
        }
        function saveProfile() {
            const name = document.getElementById('userName').value;
            const avatar = document.getElementById('userAvatar').src;
            localStorage.setItem('userProfile', JSON.stringify({ name, avatar }));
            showToast('個人品牌設定已儲存');
        }
        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { document.getElementById('userAvatar').src = e.target.result; saveProfile(); };
            reader.readAsDataURL(file);
        }
 
        function validateInput(input) {
            const regex = /^[a-zA-Z0-9._]+$/;
            const errId = input.id + "Err";
            const errEl = document.getElementById(errId);
            if (input.value && !regex.test(input.value)) {
                input.classList.add('input-error');
                if(errEl) errEl.classList.remove('hidden'); return false;
            } else {
                input.classList.remove('input-error');
                if(errEl) errEl.classList.add('hidden'); return true;
            }
        }
 
        function parseDate(str) { if (!str) return 0;
            const d = new Date(str); return isNaN(d.getTime()) ? 0 : d.getTime();
        }
       
        function parseDate2(str) {
            if (!str) return 0;
            const now = new Date();
            const parts = str.split(' ');
            if(parts.length < 2) return 0;
            const [m, d] = parts[0].split('/').map(Number);
            const [h, min] = parts[1].split(':').map(Number);
            const date = new Date(now.getFullYear(), m - 1, d, h, min);
            return date.getTime();
        }
 
        function excelDateToJSDate(serial) {
           var utc_days  = Math.floor(serial - 25569);
           var utc_value = utc_days * 86400;
           var date_info = new Date(utc_value * 1000);
           return date_info.toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'});
        }


         function handleGlobalSearch() {
            const input = document.getElementById('globalSearch');
            const clearBtn = document.getElementById('clearSearchBtn');
            
            if (input.value.length > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }

            if (!document.getElementById('fansSection').classList.contains('hidden')) {
                renderTable();
            } else if (!document.getElementById('heartStatsSection').classList.contains('hidden')) {
                renderHeartData();
            } else if (!document.getElementById('historySection').classList.contains('hidden')) {
                // [更新] 讓動態紀錄支援搜尋
                renderHistory();
            }
        }

        function clearSearch() {
            const input = document.getElementById('globalSearch');
            input.value = '';
            handleGlobalSearch(); // 觸發重繪與隱藏按鈕
        }


        function renderTable() {
            const tbody = document.getElementById('fanTableBody');
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
            const emptyState = document.getElementById('emptyState');
            tbody.innerHTML = '';
           
            const totalFanCount = fans.filter(f => f.interactions && f.interactions.includes('粉絲')).length;
            const countBadge = document.getElementById('fanCountBadge');
            if(countBadge) countBadge.innerText = `粉絲人數: ${totalFanCount}`;
 
            let filteredFans = fans.filter(f => {
                const matchesSearch = (f.username || '').toLowerCase().includes(searchTerm) ||
                                      (f.nickname || '').toLowerCase().includes(searchTerm) ||
                                      (f.interactions || []).join('').toLowerCase().includes(searchTerm) ||
                                      (f.details || '').toLowerCase().includes(searchTerm);
                if (!matchesSearch) return false;
                if (activeFilters.pending && f.sent) return false;
 
                // 新增超過14天篩選 (針對已發送)
                const DAYS_14_MS = 1209600000;
                if (activeFilters.oldSent) {
                    const isOld = f.sent && f.sentDate && (Date.now() - parseDate2(f.sentDate) > DAYS_14_MS);
                    if (!isOld) return false;
                }
 
                if (activeFilters.tags.length > 0) {
                    const matchAll = activeFilters.tags.every(tag => {
                        if (tag === '非粉絲') return !f.interactions.includes('粉絲');
                        return f.interactions.includes(tag);
                    });
                    if (!matchAll) return false;
                }
                return true;
            });

            if (filteredFans.length > 0) {
                const sorter = (a, b) => {
                    if (activeSort) {
                        const { col, order } = activeSort;
                        if (col === 'username') return order === 'az' ? a.username.localeCompare(b.username) : b.username.localeCompare(a.username);
                        if (col === 'status') {
                            const dateA = parseDate(a.latestDate);
                            const dateB = parseDate(b.latestDate);
                            return order === 'new' ? dateB - dateA : dateA - dateB;
                        }
                        if (col === 'sent') {
                            const getSentValue = (fan) => {
                                if (!fan.sent) return 9999999999999;
                                return fan.sentDate ? parseDate2(fan.sentDate) : 0;
                            };
                            const valA = getSentValue(a);
                            const valB = getSentValue(b);
                            return order === 'date_new' ? valB - valA : valA - valB;
                        }
                    }
                    return a.username.toLowerCase().localeCompare(b.username.toLowerCase());
                };
                const starredFans = filteredFans.filter(f => f.isCloseFriend);
                const otherFans = filteredFans.filter(f => !f.isCloseFriend);
                starredFans.sort(sorter); otherFans.sort(sorter);
                filteredFans = [...starredFans, ...otherFans];
            }
           
            if (filteredFans.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                const DAYS_14 = 1209600000; // 14 days in ms
 
                filteredFans.forEach(fan => {
                    const row = document.createElement('tr'); row.className = 'table-row';
                    
                    // [修正邏輯] 跨表比對：找出該粉絲在所有紀錄中「最新」的發送狀態
                    let finalSent = fan.sent;
                    let finalSentDate = fan.sentDate;
                    let finalTimestamp = parseDate2(fan.sentDate);

                    // 掃描 HeartData 中是否有該粉絲的已發送紀錄，並比對時間
                    const userHearts = heartData.filter(h => h.username === fan.username);
                    userHearts.forEach(h => {
                        if (h.sent) {
                            finalSent = true; // 只要有任何一筆是 Sent，就視為已發送
                            const hTime = parseDate2(h.sentDate);
                            if (hTime > finalTimestamp) {
                                finalTimestamp = hTime;
                                finalSentDate = h.sentDate; // 更新為最新的日期
                            }
                        }
                    });

                    // 使用計算後的 finalSentDate 進行判斷
                    const isOldSent = finalSentDate && (Date.now() - parseDate2(finalSentDate)) > DAYS_14;
                    const sentStyle = isOldSent ? 'text-[#4B0082] border-[#4B0082]/30' : 'text-green-400 border-green-400/30';
                    const statusHtml = finalSent
                        ? `<div class="flex flex-col"><span class="${sentStyle} text-xs font-bold border px-2 py-0.5 rounded w-fit">✓ 已發送</span><span class="text-[10px] text-gray-500 mt-1">${finalSentDate || ''}</span></div>`
                        : `<span class="text-amber-500 text-xs font-bold border border-amber-500/30 px-2 py-0.5 rounded w-fit">● 待處理</span>`;
                    
                    const isOldActivity = (Date.now() - parseDate(fan.latestDate)) > DAYS_14;
                    const actColor = isOldActivity ? 'text-[#4B0082]' : 'text-white';
                    const latestInfo = (fan.latestDate || fan.latestType) ? `<div class="flex flex-col"><span class="${actColor} font-bold text-xs">${fan.latestType ||
                        '無'}</span><span class="text-[10px] text-gray-500">${fan.latestDate || '未知日期'}</span></div>` : `<span class="text-gray-600 text-xs">-</span>`;
                    
                    const isValidAccount = /^[a-zA-Z0-9._]+$/.test(fan.username);
                    const nameClass = isValidAccount ?
                        "text-indigo-300 hover:text-indigo-100 hover:underline" : "text-red-800 font-bold hover:text-red-600 hover:underline";
                    
                    const langBadge = `<span class="ml-2 inline-flex items-center justify-center w-5 h-5 bg-[#4B0082] text-[#D8BFD8] text-[10px] font-bold rounded-[2px]">${fan.language ||
                        '中'}</span>`;
                    const accountLink = `<span class="${nameClass} cursor-pointer select-none" onmousedown="startFanLongPress(event, '${fan.username}')" onmouseup="cancelFanLongPress(this, '${fan.username}')" ontouchstart="startFanLongPress(event, '${fan.username}')" ontouchend="cancelFanLongPress(this, '${fan.username}')">@${fan.username}</span>${langBadge}`;
                    
                    const tagsHtml = fan.interactions.map(tag => {
                        let style = 'bg-white/5 text-gray-300 border-white/10'; 
                        if (tag === '粉絲') style = 'bg-pink-900/40 text-pink-200 border-pink-500/30';
                        else if (tag === '前帳粉') style = 'bg-[#763BE3]/20 text-[#763BE3] border-[#763BE3]/30';
                        else if (tag === '高互動') style = 'bg-amber-900/20 text-amber-500 border-amber-500/30';
                        else if (tag === 'Thread粉') style = 'thread-badge';
                        return `<span class="px-2 py-0.5 rounded text-xs border whitespace-nowrap ${style}">${tag}</span>`;
                    }).join('');
                    
                    const starClass = fan.isCloseFriend ? 'star-active' : 'star-inactive';
                    row.innerHTML = `
                        <td class="text-center sticky-col-1"><i class="fas fa-star ${starClass} star-btn" onclick="toggleStar(${fan.id})"></i></td>
                        <td class="font-medium sticky-col-2">${accountLink}</td>
                        <td class="text-gray-300 text-xs">${fan.nickname || '-'}</td>
                        <td class="bg-indigo-900/10 border-l border-r border-indigo-900/30">${latestInfo}</td>
                        <td><div class="flex flex-wrap gap-1">${tagsHtml}</div></td>
                        <td><div class="text-xs text-gray-400 line-clamp-2 hover:line-clamp-none transition-all cursor-help" title="${fan.details}">${fan.details.split('/').map(d => `<span class="block border-b border-dashed border-white/10 pb-0.5 mb-0.5 last:border-0">${d.trim()}</span>`).join('')}</div></td>
                        <td>${statusHtml}</td>
                        <td class="text-center sticky-col-last">
                            <div class="flex justify-center gap-1">
                                <button 
                                    onmousedown="startMsgBtnPress(event, '${fan.username}', ${fan.id})" 
                                    ontouchstart="startMsgBtnPress(event, '${fan.username}', ${fan.id})" 
                                    onmouseup="endMsgBtnPress(event, ${fan.id})" 
                                    ontouchend="endMsgBtnPress(event, ${fan.id})" 
                                    class="group btn-indigo px-2 py-1.5 rounded text-xs text-white font-bold select-none" 
                                    title="點擊:發送訊息 / 長按:開啟Threads">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                                <button onclick="openEditFanModal(${fan.id})" class="bg-gray-700 hover:bg-gray-600 text-white px-2 py-1.5 rounded text-xs transition-colors" title="編輯資料"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteFan(${fan.id})" class="bg-red-900/30 hover:bg-red-600 text-red-400 hover:text-white px-2 py-1.5 rounded text-xs transition-colors" title="刪除"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>`;
                    tbody.appendChild(row);
                });
            }
        }
 
        // --- New Render Functions ---
        function renderIgPosts() {
            const tbody = document.getElementById('igPostTableBody');
            tbody.innerHTML = igPosts.map((p, idx) => `
                <tr class="table-row">
                    <td class="font-bold text-pink-200">${p.topic}</td>
                    <td class="text-gray-500 text-xs">${p.date || '-'}</td>
                    <td class="text-gray-400 text-xs whitespace-pre-wrap">${p.content}</td>
                    <td class="text-gray-400 text-xs whitespace-pre-wrap">${p.fileName}</td>
                    <td class="text-blue-300 text-xs">${p.hashtag}</td>
                    <td class="text-center">
                        <button onclick="openEditIgPostModal(${idx})" class="bg-gray-700 hover:bg-gray-600 text-white px-2 py-1.5 rounded text-xs transition-colors mr-2"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteIgPost(${idx})" class="bg-red-900/30 hover:bg-red-600 text-red-400 hover:text-white px-2 py-1.5 rounded text-xs transition-colors"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
            `).join('');
        }
 
        function renderGiftPosts() {
            const tbody = document.getElementById('giftPostTableBody');
            tbody.innerHTML = giftPosts.map((p, idx) => `
                <tr class="table-row">
                    <td class="font-bold text-purple-200">${p.giftId}</td>
                    <td class="text-gray-400 text-xs">${p.date}</td>
                    <td class="text-gray-400 text-xs whitespace-pre-wrap">${p.fileName}</td>
                    <td class="text-gray-300 text-xs whitespace-pre-wrap">${p.desc}</td>
                    <td class="text-center">
                        <button onclick="openEditGiftPostModal(${idx})" class="bg-gray-700 hover:bg-gray-600 text-white px-2 py-1.5 rounded text-xs transition-colors mr-2"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteGiftPost(${idx})" class="bg-red-900/30 hover:bg-red-600 text-red-400 hover:text-white px-2 py-1.5 rounded text-xs transition-colors"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
            `).join('');
        }
 
        
        function renderHeartData() {
            const tbody = document.getElementById('heartTableBody');
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
            const DAYS_14 = 1209600000; // 14 days

            let displayData = [...heartData];
            if (searchTerm) {
                displayData = displayData.filter(d => 
                    (d.username || '').toLowerCase().includes(searchTerm) ||
                    (d.nickname || '').toLowerCase().includes(searchTerm) ||
                    (d.content || '').toLowerCase().includes(searchTerm) ||
                    (d.responseItem || '').toLowerCase().includes(searchTerm)
                );
            }

            displayData.sort((a, b) => parseDate(b.date) - parseDate(a.date));
            
            tbody.innerHTML = displayData.map((d) => {
                // --- [關鍵修正] 讀取時強制同步狀態 ---
                const targetUser = (d.username || '').trim().toLowerCase();
                
                // 1. 預設使用該筆紀錄的狀態
                let finalSent = d.sent;
                let finalSentDate = d.sentDate;
                let maxTimestamp = parseDate2(d.sentDate);

                // 2. 檢查 [粉絲管理列表] 主檔 (Master) 是否已發送且時間更新
                const masterFan = fans.find(f => f.username.trim().toLowerCase() === targetUser);
                if (masterFan && masterFan.sent) {
                    const fanTime = parseDate2(masterFan.sentDate);
                    // 如果主檔有發送，且 (目前沒發送 OR 主檔時間比較新)，就採用主檔狀態
                    if (!finalSent || fanTime > maxTimestamp) {
                        finalSent = true;
                        finalSentDate = masterFan.sentDate;
                        maxTimestamp = fanTime;
                    }
                }

                // 3. 檢查 [其他暖心紀錄] 是否有更新的發送時間 (Siblings)
                heartData.forEach(h => {
                    if (h.username.trim().toLowerCase() === targetUser && h.sent) {
                        const hTime = parseDate2(h.sentDate);
                        if (hTime > maxTimestamp) {
                            finalSent = true;
                            finalSentDate = h.sentDate;
                            maxTimestamp = hTime;
                        }
                    }
                });
                // ------------------------------------

                const isOldSent = finalSentDate && (Date.now() - parseDate2(finalSentDate)) > DAYS_14;
                const sentStyle = isOldSent ? 'text-[#4B0082] border-[#4B0082]/30' : 'text-green-400 border-green-400/30';
                
                // 使用計算後的 finalSent 與 finalSentDate 顯示
                const statusHtml = finalSent
                    ? `<div class="flex flex-col"><span class="${sentStyle} text-xs font-bold border px-2 py-0.5 rounded w-fit">✓ 已發送</span><span class="text-[10px] text-gray-500 mt-1">${finalSentDate || ''}</span></div>`
                    : `<span class="text-amber-500 text-xs font-bold border border-amber-500/30 px-2 py-0.5 rounded w-fit">● 待處理</span>`;

                return `
                <tr class="table-row">
                    <td class="font-bold">
                        <span class="text-indigo-300 cursor-pointer hover:text-indigo-100 hover:underline select-none" 
                              onmousedown="startFanLongPress(event, '${d.username}')" 
                              onmouseup="cancelFanLongPress(this, '${d.username}')" 
                              ontouchstart="startFanLongPress(event, '${d.username}')" 
                              ontouchend="cancelFanLongPress(this, '${d.username}')">
                            @${d.username}
                        </span>
                    </td>
                    <td class="text-gray-400">${d.nickname}</td>
                    <td class="text-gray-400 text-xs">${d.date}</td>
                    <td class="text-pink-300 text-xs border border-pink-900/50 bg-pink-900/20 px-2 rounded w-fit">${d.responseItem}</td>
                    <td class="text-gray-300 text-xs whitespace-pre-wrap">${d.content}</td>
                    <td>${statusHtml}</td>
                    <td class="text-center">
                        <div class="flex items-center justify-center gap-1">
                            <button 
                                 onmousedown="startMsgBtnPress(event, '${d.username}', ${d.id}, 'heart')" 
                                 ontouchstart="startMsgBtnPress(event, '${d.username}', ${d.id}, 'heart')" 
                                 onmouseup="endMsgBtnPress(event, ${d.id})" 
                                 ontouchend="endMsgBtnPress(event, ${d.id})" 
                                 class="group btn-indigo px-2 py-1.5 rounded text-xs text-white font-bold select-none" 
                                 title="點擊:發送訊息 / 長按:開啟Threads">
                                 <i class="fas fa-paper-plane"></i>
                            </button>
                            <button onclick="openEditHeartModal(${d.id})" class="bg-gray-700 hover:bg-gray-600 text-white px-2 py-1.5 rounded text-xs transition-colors" title="編輯"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteHeartData(${d.id})" class="bg-red-900/30 hover:bg-red-600 text-red-400 hover:text-white px-2 py-1.5 rounded text-xs transition-colors" title="刪除"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }
 
        // --- Add/Delete/Edit Logic ---
 
        function openEditIgPostModal(idx) {
            const p = igPosts[idx];
            document.getElementById('editIgIndex').value = idx;
            document.getElementById('editIgTopic').value = p.topic;
            document.getElementById('editIgDate').value = p.date || '';
            document.getElementById('editIgFile').value = p.fileName;
            document.getElementById('editIgContent').value = p.content;
            document.getElementById('editIgHash').value = p.hashtag;
            document.getElementById('editIgModal').classList.remove('hidden');
        }
        function saveIgPostEdit() {
            const idx = document.getElementById('editIgIndex').value;
            igPosts[idx] = {
                topic: document.getElementById('editIgTopic').value,
                date: document.getElementById('editIgDate').value,
                fileName: document.getElementById('editIgFile').value,
                content: document.getElementById('editIgContent').value,
                hashtag: document.getElementById('editIgHash').value
            };
            localStorage.setItem('igPosts', JSON.stringify(igPosts));
            renderIgPosts();
            updateResponseOptions();
            document.getElementById('editIgModal').classList.add('hidden');
        }
 
        function addIgPost() {
            const topic = document.getElementById('igTopic').value.trim();
            const content = document.getElementById('igContent').value.trim();
            const fileName = document.getElementById('igFile').value.trim();
            const hashtag = document.getElementById('igHash').value.trim();
            const dateStr = `${document.getElementById('igDateYYYY').value}/${document.getElementById('igDateMM').value}/${document.getElementById('igDateDD').value}`;
           
            if(!topic) return alert("請輸入主題");
            igPosts.push({ topic, content, fileName, hashtag, date: dateStr });
            localStorage.setItem('igPosts', JSON.stringify(igPosts));
            renderIgPosts();
           
            document.getElementById('igTopic').value = '';
            document.getElementById('igContent').value = '';
            document.getElementById('igFile').value = '';
            document.getElementById('igHash').value = '';
            showToast('IG 貼文已新增');
            updateResponseOptions();
        }
        function deleteIgPost(idx) {
            if(confirm("確定刪除?")) {
                igPosts.splice(idx, 1);
                localStorage.setItem('igPosts', JSON.stringify(igPosts));
                renderIgPosts();
                updateResponseOptions();
            }
        }
 
        function openEditGiftPostModal(idx) {
            const p = giftPosts[idx];
            document.getElementById('editGiftIndex').value = idx;
            document.getElementById('editGiftId').value = p.giftId;
            document.getElementById('editGiftDate').value = p.date;
            document.getElementById('editGiftFile').value = p.fileName;
            document.getElementById('editGiftDesc').value = p.desc;
            document.getElementById('editGiftModal').classList.remove('hidden');
        }
        function saveGiftPostEdit() {
            const idx = document.getElementById('editGiftIndex').value;
            giftPosts[idx] = {
                giftId: document.getElementById('editGiftId').value,
                date: document.getElementById('editGiftDate').value,
                fileName: document.getElementById('editGiftFile').value,
                desc: document.getElementById('editGiftDesc').value
            };
            localStorage.setItem('giftPosts', JSON.stringify(giftPosts));
            renderGiftPosts();
            updateResponseOptions();
            document.getElementById('editGiftModal').classList.add('hidden');
        }
 
        function addGiftPost() {
            const giftId = document.getElementById('giftId').value.trim();
            const fileName = document.getElementById('giftFile').value.trim();
            const desc = document.getElementById('giftDesc').value.trim();
            const dateStr = `${document.getElementById('giftDateYYYY').value}/${document.getElementById('giftDateMM').value}/${document.getElementById('giftDateDD').value}`;
           
            if(!giftId) return alert("請輸入禮物 ID");
            giftPosts.push({ giftId, date: dateStr, fileName, desc });
            localStorage.setItem('giftPosts', JSON.stringify(giftPosts));
            renderGiftPosts();
           
            document.getElementById('giftId').value = '';
            document.getElementById('giftFile').value = '';
            document.getElementById('giftDesc').value = '';
            showToast('禮物貼文已新增');
            updateResponseOptions();
        }
        function deleteGiftPost(idx) {
            if(confirm("確定刪除?")) {
                giftPosts.splice(idx, 1);
                localStorage.setItem('giftPosts', JSON.stringify(giftPosts));
                renderGiftPosts();
                updateResponseOptions();
            }
        }
 
        function switchManualTab(tab) {
            const stdForm = document.getElementById('manualStandardForm');
            const heartForm = document.getElementById('manualHeartForm');
            const btnStd = document.getElementById('tabBtnStd');
            const btnHeart = document.getElementById('tabBtnHeart');
            if (tab === 'standard') {
                stdForm.classList.remove('hidden');
                heartForm.classList.add('hidden');
                btnStd.className = "flex-1 py-4 text-center font-bold text-indigo-400 border-b-2 border-indigo-500 bg-[#1a1a1a]";
                btnHeart.className = "flex-1 py-4 text-center font-bold text-gray-500 hover:text-red-400 hover:bg-[#2a1a1a] transition-all";
            } else {
                stdForm.classList.add('hidden');
                heartForm.classList.remove('hidden');
                btnStd.className = "flex-1 py-4 text-center font-bold text-gray-500 hover:text-indigo-400 hover:bg-[#2a1a1a] transition-all";
                btnHeart.className = "flex-1 py-4 text-center font-bold text-red-400 border-b-2 border-red-500 bg-[#1a1a1a]";
                updateResponseOptions();
            }
        }
 
        function autoFillHeartNickname() {
            const user = document.getElementById('heartUser').value.trim();
            const fan = fans.find(f => f.username === user);
            if(fan) document.getElementById('heartNick').value = fan.nickname || '';
        }


        // 新增：手動紀錄自動帶入暱稱
        function autoFillManualNickname() {
            const user = document.getElementById('manualUsername').value.trim();
            const fan = fans.find(f => f.username === user);
            if(fan && fan.nickname) document.getElementById('manualNickname').value = fan.nickname;
        }
 
        function updateResponseOptions() {
            const select = document.getElementById('heartResponseItem');
            const editSelect = document.getElementById('editHeartItem');
            const editGroupIg = document.getElementById('editHeartItemIg');
            const editGroupGift = document.getElementById('editHeartItemGift');
            
            // Basic options
            select.innerHTML = '<option value="DM">DM (私訊)</option>';
            editGroupIg.innerHTML = '';
            editGroupGift.innerHTML = '';
           
            if(igPosts.length > 0) {
                const group = document.createElement('optgroup');
                group.label = "IG 貼文留言";
                igPosts.forEach(p => {
                    const opt = `<option value="貼文: ${p.topic}">${p.topic}</option>`;
                    group.innerHTML += opt;
                    editGroupIg.innerHTML += opt;
                });
                select.appendChild(group);
            }
            if(giftPosts.length > 0) {
                const group = document.createElement('optgroup');
                group.label = "禮物 ID";
                giftPosts.forEach(g => {
                    const opt = `<option value="禮物: ${g.giftId}">${g.giftId}</option>`;
                    group.innerHTML += opt;
                    editGroupGift.innerHTML += opt;
                });
                select.appendChild(group);
            }
        }
 
        function startHeaderLongPress(e, key) {
            if(e.button !== 0 && e.type !== 'touchstart') return;
            if(!['username', 'status', 'sent', 'interactions'].includes(key)) return;
            headerLongPressTimer = setTimeout(() => { openFilterMenu(e, key); }, 600);
        }
        function cancelHeaderLongPress() { clearTimeout(headerLongPressTimer); }
 
        function openFilterMenu(e, key) {
            const menu = document.getElementById('filterMenu');
            currentFilterCol = key;
            const container = document.getElementById('filterContentContainer');
            container.innerHTML = '';
            if (key === 'username' || key === 'status') {
                container.innerHTML = `<label class="text-xs text-gray-400 block mb-2">排序方式：</label><select id="filterSortSelect" onchange="applySort(this.value)" class="bg-black/40 border border-gray-600 text-gray-300 text-xs rounded w-full p-2 focus:border-indigo-500 outline-none"></select>`;
                const sortSelect = document.getElementById('filterSortSelect');
                sortSelect.innerHTML = '<option value="">(預設)</option>';
                const addOpt = (val, txt) => {
                    const selected = (activeSort && activeSort.col === key && activeSort.order === val) ? 'selected' : '';
                    sortSelect.innerHTML += `<option value="${val}" ${selected}>${txt}</option>`;
                };
                if (key === 'username') { addOpt('az', '字母順序 (A-Z)'); addOpt('za', '字母順序 (Z-A)'); }
                else if (key === 'status') { addOpt('new', '活動日期 (新-舊)'); addOpt('old', '活動日期 (舊-新)'); }
            } else if (key === 'interactions') {
                container.innerHTML = `<div class="text-xs text-gray-400 mb-2 font-bold">篩選標籤 (需同時滿足/AND)：</div>`;
                // 新增 '前帳粉' 與 '高互動', 'Thread粉'
                ['粉絲', '非粉絲', '前帳粉', 'Thread粉', '高互動', '留言', '轉發', '分享'].forEach(tag => {
                    const checked = activeFilters.tags.includes(tag) ? 'checked' : '';
                    let colorClass = "text-gray-300";
                    
                    if(tag==='粉絲') colorClass = "text-pink-200"; // 粉絲改為粉紅色
                    if(tag==='前帳粉') colorClass = "text-[#763BE3]"; // 移除粗體
                    if(tag==='Thread粉') colorClass = "text-white"; // 移除粗體
                    if(tag==='高互動') colorClass = "text-amber-400"; // 移除粗體
                    
                    container.innerHTML += `<label class="flex items-center gap-2 text-sm ${colorClass} 
cursor-pointer hover:bg-white/5 p-1 rounded"><input type="checkbox" value="${tag}" ${checked} onchange="toggleFilter('tag', this.value)" class="accent-indigo-500"> ${tag}</label>`;
        });
            } else if (key === 'sent') {
                const pendingChecked = activeFilters.pending ? 'checked' : '';
                // 新增超過14天篩選
                const oldSentChecked = activeFilters.oldSent ? 'checked' : '';
                let html = `<label class="flex items-center gap-2 text-sm text-amber-400 font-bold cursor-pointer mb-2"><input type="checkbox" ${pendingChecked} onchange="toggleFilter('pending')" class="accent-amber-500"> 顯示「待處理」</label>`;
                html += `<label class="flex items-center gap-2 text-sm text-[#4B0082] font-bold cursor-pointer border-b border-white/10 pb-2 mb-2"><input type="checkbox" ${oldSentChecked} onchange="toggleFilter('oldSent')" class="accent-indigo-900"> 超過14天</label>`;
                html += `<label class="text-xs text-gray-400 block mb-2">排序方式：</label><select onchange="applySort(this.value)" class="bg-black/40 border border-gray-600 text-gray-300 text-xs rounded w-full p-2 focus:border-indigo-500 outline-none"><option value="">(預設)</option>`;
                const opts = [{val: 'date_new', txt: '發送日期 (新-舊)'}, {val: 'date_old', txt: '發送日期 (舊-新)'}];
                opts.forEach(o => {
                    const selected = (activeSort && activeSort.col === key && activeSort.order === o.val) ? 'selected' : '';
                    html += `<option value="${o.val}" ${selected}>${o.txt}</option>`;
                });
                html += `</select>`;
                container.innerHTML = html;
            }
            const posX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const posY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
            menu.style.left = Math.min(posX, window.innerWidth - 270) + 'px';
            menu.style.top = Math.min(posY, window.innerHeight - 200) + 'px';
            menu.classList.remove('hidden'); menu.classList.add('flex');
        }
 
        function toggleFilter(type, value) {
            if (type === 'pending') { activeFilters.pending = !activeFilters.pending; }
            else if (type === 'oldSent') { activeFilters.oldSent = !activeFilters.oldSent; }
            else if (type === 'tag') {
                if (activeFilters.tags.includes(value)) activeFilters.tags = activeFilters.tags.filter(t => t !== value);
                else activeFilters.tags.push(value);
            }
            renderTable();
        }
 
        function closeFilterMenu() { document.getElementById('filterMenu').classList.add('hidden'); document.getElementById('filterMenu').classList.remove('flex'); currentFilterCol = null; }
        function applySort(order) { activeSort = order ? { col: currentFilterCol, order: order } : null; renderTable(); }
 
        function addHeartData() {
            const username = document.getElementById('heartUser').value.trim();
            const nickname = document.getElementById('heartNick').value.trim();
            const responseItem = document.getElementById('heartResponseItem').value;
            const content = document.getElementById('heartContent').value.trim();
            const dateStr = `${document.getElementById('heartDateYYYY').value}/${document.getElementById('heartDateMM').value}/${document.getElementById('heartDateDD').value}`;
           
            if(!username) return alert("請輸入粉絲帳號");
            heartData.push({ username, nickname, responseItem, content, date: dateStr });
            localStorage.setItem('heartData', JSON.stringify(heartData));
            renderHeartData();
            document.getElementById('heartUser').value = '';
            document.getElementById('heartNick').value = '';
            document.getElementById('heartContent').value = '';
            showToast('暖心紀錄已儲存');
        }
 
        function openEditHeartModal(idx) {
            const d = heartData[idx];
            document.getElementById('editHeartIndex').value = idx;
            document.getElementById('editHeartUser').value = d.username;
            document.getElementById('editHeartNick').value = d.nickname;
            document.getElementById('editHeartDate').value = d.date;
            document.getElementById('editHeartItem').value = d.responseItem;
            document.getElementById('editHeartContent').value = d.content;
            document.getElementById('editHeartModal').classList.remove('hidden');
        }
        function saveHeartEdit() {
            const idx = document.getElementById('editHeartIndex').value;
            heartData[idx] = {
                username: document.getElementById('editHeartUser').value,
                nickname: document.getElementById('editHeartNick').value,
                date: document.getElementById('editHeartDate').value,
                responseItem: document.getElementById('editHeartItem').value,
                content: document.getElementById('editHeartContent').value
            };
            localStorage.setItem('heartData', JSON.stringify(heartData));
            renderHeartData();
            document.getElementById('editHeartModal').classList.add('hidden');
        }
 
        function deleteHeartData(idx) {
            if(confirm("確定刪除?")) {
                heartData.splice(idx, 1);
                localStorage.setItem('heartData', JSON.stringify(heartData));
                renderHeartData();
            }
        }
 
        let fanLongPressTimer;
        let isLongPress = false;
 
        function startFanLongPress(e, username) {
            if(e.button !== 0 && e.type !== 'touchstart') return;
            isLongPress = false;
            fanLongPressTimer = setTimeout(() => {
                isLongPress = true;
                window.open(`https://www.threads.net/@${username}`, '_blank');
                if(navigator.vibrate) navigator.vibrate(50); // Optional feedback
            }, 600);
        }
 
        function cancelFanLongPress(element, username) {
            clearTimeout(fanLongPressTimer);
if (!isLongPress) {
                window.open(`https://www.instagram.com/${username}`, '_blank');
element.classList.remove('text-indigo-300', 'hover:text-indigo-100');
                element.classList.add('visited-link');
            }
        }

        // [新增] 訊息按鈕專用邏輯 (短按Modal / 長按Threads)
        let msgBtnTimer;
        let isMsgBtnLong = false;
        let currentMsgPlatform = 'ig'; // 新增：追蹤目前要發送的平台

        function startMsgBtnPress(e, username, id, type = 'fan') {
            // 只接受左鍵(0)或觸控
            if(e.button !== 0 && e.type !== 'touchstart') return;
            activeSourceType = type; // 設定操作來源
            isMsgBtnLong = false;
            msgBtnTimer = setTimeout(() => {
                isMsgBtnLong = true;
                if(navigator.vibrate) navigator.vibrate(50);
                // 長按：設定為 Threads 模式並開啟 Modal
                currentMsgPlatform = 'threads';
                openModal(id); 
   
             }, 600);
        }

        function endMsgBtnPress(e, id) {
            clearTimeout(msgBtnTimer);
            // 如果不是長按，代表是點擊，執行原本的開啟視窗 (IG模式)
            if (!isMsgBtnLong) {
                currentMsgPlatform = 'ig';
                openModal(id);
            }
            isMsgBtnLong = false;
            // 阻止預設行為避免重複觸發
            // if(e.cancelable && e.type !== 'mouseup') e.preventDefault();
        }
 
        function toggleStar(id) { const fan = fans.find(f => f.id === id);
            if(fan) { fan.isCloseFriend = !fan.isCloseFriend; saveData(); renderTable(); } }
       
        function initDateInput() {
            const today = new Date();
            const setup = (prefix) => {
                const els = [
                    { id: prefix + 'YYYY', val: today.getFullYear(), max: 4 },
                    { id: prefix + 'MM', val: String(today.getMonth()+1).padStart(2,'0'), max: 2 },
                    { id: prefix + 'DD', val: String(today.getDate()).padStart(2,'0'), max: 2 }
                ];
                els.forEach((c, i) => {
                    const el = document.getElementById(c.id);
                    if(!el) return;
                    el.value = c.val;
                    el.addEventListener('focus', function() { this.select(); });
                    el.addEventListener('input', function() {
                        this.value = this.value.replace(/[^0-9]/g, '');
                        if(this.value.length >= c.max && i < els.length - 1) setTimeout(() => document.getElementById(els[i+1].id).focus(), 0);
                    });
                });
            };
            setup('date'); // 手動記錄
            setup('igDate'); // IG
            setup('giftDate'); // Gift
            setup('heartDate'); // Heart
        }
 
        function addManualInteraction() {
            const usernameInput = document.getElementById('manualUsername');
            if (!validateInput(usernameInput)) return alert("帳號格式錯誤");
            const username = usernameInput.value.trim(); if (!username) return alert("請輸入帳號");
            const nickname = document.getElementById('manualNickname').value.trim();
            const language = document.getElementById('manualLang').value;
            const checkedBoxes = document.querySelector('#manualSection .interaction-checkboxes').querySelectorAll('input:checked');
            let tags = Array.from(checkedBoxes).map(cb => (cb.value === '新粉絲' ? '粉絲' : cb.value));
            const details = document.getElementById('manualDetails').value.trim();
            const manualDateStr = `${document.getElementById('dateYYYY').value}/${document.getElementById('dateMM').value.padStart(2, '0')}/${document.getElementById('dateDD').value.padStart(2, '0')}`;
           
            const existingFan = fans.find(f => f.username === username);
            if (existingFan) {
                existingFan.interactions = Array.from(new Set([...existingFan.interactions, ...tags]));
                if (details) existingFan.details = existingFan.details ? existingFan.details + " / " + details : details;
                if (nickname) existingFan.nickname = nickname;
                existingFan.language = language; // Update language
                if (parseDate(manualDateStr) >= parseDate(existingFan.latestDate)) { existingFan.latestType = tags.join(' / '); existingFan.latestDate = manualDateStr; }
                showToast(`已更新 @${username}`);
            } else {
                fans.push({ id: Date.now(), username, nickname, language, interactions: tags, latestType: tags.join(' / '), latestDate: manualDateStr, details, sent: false, sentDate: '', isCloseFriend: false });
                showToast(`已新增 @${username}`);
            }

            // 連動：寫入動態紀錄
            addHistoryLog(username, nickname, tags.join(' / '), manualDateStr, details);

            usernameInput.value = ''; document.getElementById('manualNickname').value = '';
            document.getElementById('manualDetails').value = ''; document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false); initDateInput();
            saveData(); renderTable();
        }
 
        function openEditFanModal(id) {
            const fan = fans.find(f => f.id === id);
            if(!fan) return;
            document.getElementById('editFanId').value = id;
            document.getElementById('editFanUsername').value = fan.username;
            document.getElementById('editFanNickname').value = fan.nickname || '';
            document.getElementById('editFanDetails').value = fan.details || '';
            const inputs = document.querySelectorAll('#editFanCheckboxes input');
            const standardTags = [];
            inputs.forEach(input => { standardTags.push(input.value); input.checked = fan.interactions.includes(input.value === '新粉絲' ? '粉絲' : input.value); });
            const extraTags = fan.interactions.filter(t => !standardTags.includes(t));
            const extraContainer = document.getElementById('editFanExtraTags');
            extraContainer.innerHTML = extraTags.length ?
            '其它標籤: ' + extraTags.map(t => `<span onclick="removeExtraTag(${id}, '${t}')" class="cursor-pointer hover:bg-red-900 border border-white/20 px-1 rounded ml-1 bg-white/5">${t} <i class="fas fa-times text-[10px]"></i></span>`).join('') : '';
            document.getElementById('editFanModal').classList.remove('hidden');
        }
 
        function removeExtraTag(fanId, tag) {
            const fan = fans.find(f => f.id === fanId);
            if(fan) { fan.interactions = fan.interactions.filter(t => t !== tag); saveData(); openEditFanModal(fanId); }
        }
 
        function saveFanEdit() {
            const id = parseFloat(document.getElementById('editFanId').value);
            const fan = fans.find(f => f.id === id);
            if(fan) {
                const usernameInput = document.getElementById('editFanUsername');
                if(!validateInput(usernameInput)) return alert("帳號格式錯誤");
                fan.username = usernameInput.value.trim();
                fan.nickname = document.getElementById('editFanNickname').value.trim();
                fan.details = document.getElementById('editFanDetails').value.trim();
                const checked = Array.from(document.querySelectorAll('#editFanCheckboxes input:checked')).map(cb => cb.value === '新粉絲' ? '粉絲' : cb.value);
                const standardValues = Array.from(document.querySelectorAll('#editFanCheckboxes input')).map(cb => cb.value);
                const currentExtra = fan.interactions.filter(t => !standardValues.includes(t));
                fan.interactions = Array.from(new Set([...checked, ...currentExtra]));
                saveData(); renderTable(); closeEditFanModal(); showToast('資料已更新');
            }
        }
        function closeEditFanModal() { document.getElementById('editFanModal').classList.add('hidden'); }
        function clearAllData() {
            const currentBrandName = document.getElementById('userName').value.trim();
            if (confirm("⚠️ 警告：這將永久刪除所有資料！(包含粉絲列表、IG貼文、禮物貼文、暖心互動)")) {
                if (prompt(`請輸入品牌名稱「${currentBrandName}」確認刪除：`) === currentBrandName) {
                    // 1. 清空所有資料陣列
                    fans = [];
                    igPosts = [];
                    giftPosts = [];
                    heartData = [];
                    historyData = [];

                    // 2. 更新 LocalStorage
                    saveData();
// 儲存 fans
                    localStorage.setItem('igPosts', '[]');
localStorage.setItem('giftPosts', '[]');
                    localStorage.setItem('heartData', '[]');
                    localStorage.setItem('historyData', '[]');


                    // 3. 重新渲染所有列表介面
                    renderTable();
                    renderIgPosts();
                    renderGiftPosts();
                    renderHeartData();
                    
                    // 4. 更新下拉選單選項 (移除已刪除的貼文/禮物選項)
                    updateResponseOptions();


                    showToast("所有資料已清空");
                }
            }
        }
        
        // --- Excel Import/Export Logic ---
        function exportExcel() {
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: 互動紀錄
            const wsData1 = fans.map(f => ({
                "帳號": f.username,
                "暱稱": f.nickname,
                "語言": f.language || '中',
                "互動類型": f.interactions.join(' / '),
                "最近互動/活動日期": f.latestDate,
                "詳細內容": f.details,
                // 新增訊息狀態欄位
                "訊息": f.sent ? `已發送 ${f.sentDate}` : "待處理"
            }));
            const ws1 = XLSX.utils.json_to_sheet(wsData1);
            XLSX.utils.book_append_sheet(wb, ws1, "互動紀錄");


            // Sheet 2: 暖心時刻
            const wsData2 = heartData.map(h => ({
                "粉絲帳號": h.username,
                "粉絲暱稱": h.nickname,
                "回應日期": h.date,
                "回應項目": h.responseItem,
                "回應內容": h.content
            }));
            const ws2 = XLSX.utils.json_to_sheet(wsData2);
            XLSX.utils.book_append_sheet(wb, ws2, "暖心時刻");


            // 檔名改為 FanConnect_"Brand Name"_Export_YYYYMMDD
            const profile = JSON.parse(localStorage.getItem('userProfile')) || { name: 'Brand' };
            const brandName = (profile.name || 'Brand').replace(/\s+/g, '_');
            const now = new Date();
            const ymd = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
            
            XLSX.writeFile(wb, `FanConnect_${brandName}_Export_${ymd}.xlsx`);
        }


        function handleExcelImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            // [新增] 匯入前先存檔，確保可復原
            saveData();
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
const workbook = XLSX.read(data, { type: 'array' });
                    let updateCount = 0, newCount = 0;
const todayStr = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
// 1. 處理 {互動紀錄}
                    const sheet1Name = workbook.SheetNames.find(n => n.includes('互動')) ||
workbook.SheetNames[0];
                    const json1 = XLSX.utils.sheet_to_json(workbook.Sheets[sheet1Name], { defval: "" });
                    
                    json1.forEach(row => {
                        const getVal = (kws) => { const k = Object.keys(row).find(key => kws.some(kw => key.toLowerCase().includes(kw))); return k ? row[k] : ''; };
                        const username = getVal(['帳號','user']).toString().trim();
                        if (!username) return;
 
                        const nickname = getVal(['暱稱','name','profile']).toString().trim();
                        let dateVal = getVal(['日期','date','time']);
                        let fileDate = (typeof dateVal === 'number') ? excelDateToJSDate(dateVal) : dateVal.toString().trim() || todayStr;
                        // 處理多選互動
                        let typeRaw = getVal(['互動','type']).toString();
                        let tags = typeRaw.split(/[\/，,]/).map(s=>s.trim()).filter(s=>s).map(t=>(t==='新粉絲'||t==='New Fan')?'粉絲':t);
                        
                        const details = getVal(['詳細','details']).toString().trim();
                        const language = getVal(['語言']).toString().trim() || '中';
                        
                        // 解析訊息欄位
                        const msgVal = getVal(['訊息', 'message', 'status']).toString().trim();
                        let isSent = false, sentDate = '';
                        if (msgVal.includes('已發送')) {
                            isSent = true;
                            sentDate = msgVal.replace('已發送', '').trim();
                        }


                        // [更新後的程式碼]
                        const existing = fans.find(f => f.username === username);
                        if (existing) {
                            // [修正] 標籤處理：直接合併，不再因為「前帳粉」而移除「粉絲」
                            let mergedTags = new Set([...existing.interactions, ...tags]);
                            // (已移除) if (tags.includes('前帳粉')) { mergedTags.delete('粉絲'); }
                            existing.interactions = Array.from(mergedTags);

                            if (details && !existing.details.includes(details)) existing.details += " / " + details;
                            if (nickname && !existing.nickname) existing.nickname = nickname;
                            existing.language = language;
                            if (msgVal) { existing.sent = isSent; existing.sentDate = sentDate;
                            }
                            if (parseDate(fileDate) >= parseDate(existing.latestDate)) { existing.latestType = tags.join(' / ');
                            existing.latestDate = fileDate; }
                            updateCount++;
                        } else {
                            fans.push({ id: Date.now()+Math.random(), username, nickname, language, interactions: tags, latestType: tags.join(' / '), latestDate: fileDate, details, sent: isSent, sentDate: sentDate, isCloseFriend: false });
                            newCount++;
                        }
                        
                        // [更新] 連動動態紀錄 (防止重複)
                        // 檢查是否已存在相同的紀錄 (帳號 + 日期 + 詳細內容)
                        const existHistIdx = historyData.findIndex(h => 
                            h.username === username && 
                            h.date === fileDate && 
                            h.details === details
                        );
                        if (existHistIdx === -1) {
                             // [修正] 傳入 false 禁止單筆存檔，避免歷史紀錄被洗版
                             addHistoryLog(username, nickname, tags.join(' / '), fileDate, details, false);
                        } else {
                            // [更新] 若重複但新資料為「前帳粉」，則更新原有的「粉絲」標籤
                            const oldLog = historyData[existHistIdx];
                            if (tags.includes('前帳粉') && oldLog.type.includes('粉絲') && !oldLog.type.includes('前帳粉')) {
                                historyData[existHistIdx].type = tags.join(' / ');
                            }
                        }
                    });


                    // 2. 處理 {暖心時刻}
                    const sheet2Name = workbook.SheetNames.find(n => n.includes('暖心'));
                    if (sheet2Name) {
                        const json2 = XLSX.utils.sheet_to_json(workbook.Sheets[sheet2Name], { defval: "" });
                        json2.forEach(row => {
                           const username = row['粉絲帳號'] || row['username'];
                           if(username) {
                               // 修正日期格式：判斷是否為 Excel 序列號
    
                           let rawDate = row['回應日期'];
                               let finalDate = rawDate;
                               if (typeof rawDate === 'number') {
                                    finalDate = excelDateToJSDate(rawDate);
                               } else {
                                    finalDate = (rawDate || todayStr).toString().trim();
                               }

                           
    heartData.push({
                                   id: Date.now() + Math.random(),
                                   username: username.toString().trim(),
                      
             nickname: (row['粉絲暱稱'] || '').toString().trim(),
                                   date: finalDate,
                                   responseItem: (row['回應項目'] || 'DM').toString().trim(),
          
                         content: (row['回應內容'] || '').toString().trim()
                               });
                           }
                        });
                        // 已於開頭執行 saveData() 紀錄 Undo 狀態
                        // 此處僅更新 LocalStorage
}

                    localStorage.setItem('heartData', JSON.stringify(heartData));
                    localStorage.setItem('fans', JSON.stringify(fans));
                    localStorage.setItem('historyData', JSON.stringify(historyData)); renderTable(); renderHeartData();
                    showToast(`匯入完成：新 ${newCount} / 更 ${updateCount}`); e.target.value = '';
                } catch (err) { alert("匯入失敗：" + err.message); }
            };
            reader.readAsArrayBuffer(file);
        }
 
        function deleteFan(id) { if(confirm('刪除資料？')) { fans = fans.filter(f => f.id !== id);
            saveData(); renderTable(); showToast('已刪除'); } }
        function openModal(id) {
            activeFanId = id;
            // 根據來源查找資料
            const data = activeSourceType === 'heart' ? heartData.find(h => h.id === id) : fans.find(f => f.id === id);
            if(!data) return;
            document.getElementById('targetUser').innerText = "@" + data.username;
            document.getElementById('targetNickname').innerText = data.nickname || data.username;
            document.getElementById('modalText').value = "";
            document.getElementById('modalTempSelect').innerHTML = '<option value="">-- 選擇模板 --</option>' + templates.map(t => `<option value="${t.id}">${t.title}</option>`).join('');
            // Populate Dropdown for Gifts
            const giftSelect = document.getElementById('targetLinkInput');
            giftSelect.innerHTML = '<option value="">-- 選擇禮物 --</option>';
            giftPosts.forEach(p => {
                giftSelect.innerHTML += `<option value="${p.giftId}">${p.giftId} (${p.fileName})</option>`;
            });
            document.getElementById('finalGeneratedLink').value = '';
            const btn = document.getElementById('genLinkBtn'); btn.innerHTML = '<i class="fas fa-lock mr-1"></i>生成'; btn.classList.remove('bg-green-600');
            document.getElementById('msgModal').classList.remove('hidden');
        }
 
        function confirmSend() {
            // 取得目前操作的資料物件
            const currentData = activeSourceType === 'heart' ?
                heartData.find(h => h.id === activeFanId) : fans.find(f => f.id === activeFanId);
            
            const text = document.getElementById('modalText').value;
            
            navigator.clipboard.writeText(text).then(() => {
                if(currentData) {
                    // 1. 準備統一的時間戳記與目標帳號
                    const now = new Date();
                    const timeStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                    const targetUserLower = currentData.username.trim().toLowerCase(); // 轉小寫以確保比對無誤

                    // 2. [強力同步] 掃描 FANS 列表：更新該粉絲的主檔狀態
                    fans.forEach(f => {
                        if (f.username.trim().toLowerCase() === targetUserLower) {
                            f.sent = true;
                            f.sentDate = timeStr;
                        }
                    });

                    // 3. [強力同步] 掃描 HEART 列表：更新該粉絲所有待處理的紀錄
                    heartData.forEach(h => {
                        if (h.username.trim().toLowerCase() === targetUserLower) {
                            // 無論之前狀態為何，統一更新為已發送 (因為已執行發送動作)
                            h.sent = true;
                            h.sentDate = timeStr;
                        }
                    });
                }

                // 4. 存檔並刷新所有介面
                saveData(); 
                renderTable();     // 刷新粉絲列表
                renderHeartData(); // 刷新暖心紀錄表
                
                closeModal(); 
                
                // 5. 根據平台開啟連結
                if (currentData) {
                    if (currentMsgPlatform === 'threads') {
                        window.open(`https://www.threads.net/@${currentData.username}`, '_blank');
                    } else {
                        window.open(`https://ig.me/m/${currentData.username}`, '_blank');
                    }
                }
            });
        }
 
        function generateHashLink() {
            const data = activeSourceType === 'heart' ? heartData.find(h => h.id === activeFanId) : fans.find(f => f.id === activeFanId);
            const postInput = document.getElementById('targetLinkInput').value.trim();
            const expiryHours = document.querySelector('input[name="linkExpiry"]:checked').value;
            
            if (!data || !postInput) return alert("請選擇禮物 ID");
            let postId = postInput.includes('/') ?
                postInput.split('/').pop().split('?')[0] : postInput;
            
            // Include expiry hours in token payload
            const payload = { pid: postId, u: data.username, ts: Date.now(), exp: parseInt(expiryHours) };
            const token = btoa(encodeURIComponent(JSON.stringify(payload))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
            document.getElementById('finalGeneratedLink').value = `https://our-vault-iota.vercel.app/vault/secure/${token}`;
            const btn = document.getElementById('genLinkBtn'); btn.innerHTML = '<i class="fas fa-check"></i> 完成';
            btn.classList.add('bg-green-600');
            if(document.getElementById('modalTempSelect').value) applyTemplate();
        }
 
        function applyTemplate() {
            const tId = document.getElementById('modalTempSelect').value;
            const data = activeSourceType === 'heart' ? heartData.find(h => h.id === activeFanId) : fans.find(f => f.id === activeFanId);
            const template = templates.find(t => t.id == tId);
            if(template && data) {
                let content = template.body.replace(/{nickname}/g, data.nickname || data.username);
                const link = document.getElementById('finalGeneratedLink').value;
                if(link) content = content.replace(/{link}|{url}/g, link);
                const msgBox = document.getElementById('modalText'); msgBox.value = content;
                msgBox.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }
 
        function runDecryption() {
            const input = document.getElementById('decryptInput').value.trim();
            const resultDiv = document.getElementById('decryptResult');
            if(!input) return alert("請輸入內容");
            try {
                let token = input.includes('/vault/') ? input.split('/').pop() : input;
                token = token.replace(/-/g, '+').replace(/_/g, '/'); while (token.length % 4) token += '=';
                const data = JSON.parse(decodeURIComponent(atob(token)));
                
                // Use token's exp if available, otherwise default to 24
                const expiryHours = data.exp || 24;
                const expiryMs = expiryHours * 60 * 60 * 1000;
                
                const isExpired = new Date() > new Date(data.ts + expiryMs);
                resultDiv.classList.remove('hidden');
                document.getElementById('resPid').innerText = data.pid; document.getElementById('resUser').innerText = data.u;
                document.getElementById('resTime').innerText = new Date(data.ts).toLocaleString('zh-TW');
                document.getElementById('resExpire').innerText = new Date(data.ts + expiryMs).toLocaleString('zh-TW');
                document.getElementById('resStatus').innerHTML = isExpired ?
                '<span class="text-red-500">❌ 已過期</span>' : '<span class="text-green-400">✅ 有效連結</span>';
            } catch (e) { alert("解密失敗"); resultDiv.classList.add('hidden'); }
        }
 


















function showSection(s) {
            // 加入 'history', 'compare' 到隱藏列表
            ['fans', 'manual', 'templates', 'decrypt', 'igPosts', 'giftPosts', 'heartStats', 'history', 'compare'].forEach(x => {
                const el = document.getElementById(x+'Section');
                if(el) el.classList.add('hidden');
            });
            const target = document.getElementById(s+'Section');
            if(target) target.classList.remove('hidden');
           
            if(s==='templates') renderTemplateList();
            if(s==='igPosts') renderIgPosts();
            if(s==='giftPosts') renderGiftPosts();
            if(s==='heartStats') renderHeartData();
            if(s==='history') renderHistory(); // 渲染動態紀錄
            if(s==='manual' || s==='heartStats') updateUsernameDatalist();
        }
        function closeModal() { document.getElementById('msgModal').classList.add('hidden');
        }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.remove('translate-y-20', 'opacity-0');
        setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000); }
 
        function addTemplate() {
            const id = document.getElementById('tmpId').value;
            const title = document.getElementById('tmpTitle').value; const body = document.getElementById('tmpBody').value;
            if(!title || !body) return;
            if(id) { const t = templates.find(x => x.id == id); t.title = title; t.body = body;
            } else { templates.push({ id: Date.now(), title, body }); }
            localStorage.setItem('templates', JSON.stringify(templates));
            cancelEditTemplate(); renderTemplateList();
        }
        function editTemplate(id) { const t = templates.find(x => x.id === id);
            document.getElementById('tmpId').value = t.id; document.getElementById('tmpTitle').value = t.title; document.getElementById('tmpBody').value = t.body; document.getElementById('saveTmpBtn').innerText = "更新模板"; document.getElementById('cancelTmpBtn').classList.remove('hidden');
        }
        function cancelEditTemplate() { document.getElementById('tmpId').value = ''; document.getElementById('tmpTitle').value = ''; document.getElementById('tmpBody').value = '';
            document.getElementById('saveTmpBtn').innerText = "儲存模板"; document.getElementById('cancelTmpBtn').classList.add('hidden'); }
        function deleteTemplate(id) { if(confirm('刪除模板？')) { templates = templates.filter(t => t.id !== id);
            localStorage.setItem('templates', JSON.stringify(templates)); renderTemplateList(); } }
        function renderTemplateList() { document.getElementById('templateListDisplay').innerHTML = templates.map(t => `<div class="flex justify-between items-center bg-black/30 p-3 rounded border border-white/5"><div><div class="font-bold text-indigo-200 text-sm">${t.title}</div><div class="text-xs text-gray-500 truncate w-64">${t.body}</div></div><div><button onclick="editTemplate(${t.id})" class="text-gray-400 hover:text-white px-2"><i class="fas fa-edit"></i></button><button onclick="deleteTemplate(${t.id})" class="text-gray-600 hover:text-red-500 px-2"><i class="fas fa-trash"></i></button></div></div>`).join('');
        }
       
        function backupData() {
            const profile = JSON.parse(localStorage.getItem('userProfile')) ||
            { name: 'Brand' };
            const brandName = (profile.name || 'Brand').replace(/\s+/g, '');
            const now = new Date();
            const ymd = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
            const filename = `FanConnect_${brandName}_${ymd}.json`;
            const link = document.createElement('a');
            // 備份加入 historyData
            link.href = 'data:application/json;charset=utf-8,'+ encodeURIComponent(JSON.stringify({ fans, templates, userProfile: profile, igPosts, giftPosts, heartData, historyData }));
            link.download = filename; link.click();
        }
       
        function handleRestore(e) {
            const r = new FileReader();
            r.onload = (ev) => {
                try {
                    const o = JSON.parse(ev.target.result);
                    if(confirm(`確認還原備份？\n包含 ${o.fans.length} 筆粉絲資料與設定`)) {
                        fans = o.fans;
                        templates = o.templates || templates;
                        igPosts = o.igPosts || [];
                        giftPosts = o.giftPosts || [];
                        heartData = o.heartData || [];
                        historyData = o.historyData || []; // 還原歷史紀錄
                        if (o.userProfile) { localStorage.setItem('userProfile', JSON.stringify(o.userProfile)); loadProfile(); }
                        saveData();
                        localStorage.setItem('igPosts', JSON.stringify(igPosts));
                        localStorage.setItem('giftPosts', JSON.stringify(giftPosts));
                        localStorage.setItem('heartData', JSON.stringify(heartData));
                        localStorage.setItem('historyData', JSON.stringify(historyData));
                        localStorage.setItem('templates', JSON.stringify(templates));
                        renderTable(); renderTemplateList();
                        renderIgPosts(); renderGiftPosts(); renderHeartData();
                    }
                } catch(e){alert("格式錯誤");}
            };
            r.readAsText(e.target.files[0]);
        }










































        
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
        function updateUsernameDatalist() {
            const datalist = document.getElementById('usernameOptions');
            if (!datalist) return;
            const uniqueUsers = [...new Set(fans.map(f => f.username))];
            datalist.innerHTML = uniqueUsers.sort().map(u => {
                const fan = fans.find(f => f.username === u);
                const nick = fan && fan.nickname ? `(${fan.nickname})` : '';
                return `<option value="${u}">${nick}</option>`;
            }).join('');
        }
 










        // --- 新增：官方資料比對與動態紀錄邏輯 ---
        
        let pendingNewFans = [];
        let pendingUnfollowed = [];


        // 1. 動態紀錄功能
        function renderHistory() {
            const tbody = document.getElementById('historyTableBody');
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase();

            // [更新] 1. 搜尋過濾
            let displayData = [...historyData];
if (searchTerm) {
                displayData = displayData.filter(h => 
                    (h.username || '').toLowerCase().includes(searchTerm) ||
                    (h.nickname || '').toLowerCase().includes(searchTerm) ||
                    (h.type || '').toLowerCase().includes(searchTerm) ||
         
           (h.details || '').toLowerCase().includes(searchTerm)
                );
}

            // 2. 排序 (強制新到舊)
            const sorted = displayData.sort((a, b) => {
                const dateA = parseDate(a.date);
                const dateB = parseDate(b.date);
                return dateB - dateA;
     
       });
            
            tbody.innerHTML = sorted.map(h => {
                let typeClass = 'text-gray-400';
                const t = (h.type || '').toString();
                
                // [更新] 樣式判斷
              
  if(t.includes('新粉絲')) typeClass = 'text-green-400 font-bold';
                else if(t.includes('退追')) typeClass = 'text-red-400 font-bold';
                else if(t.includes('前帳粉')) typeClass = 'text-[#763BE3] font-bold';
                else if(t.includes('粉絲')) typeClass = 'text-pink-300';
                else if(h.type === '更新') typeClass = 'text-blue-400';

        
        return `<tr class="table-row">
                    <td class="text-xs text-gray-500">${h.date}</td>
                    <td class="font-bold">
                        <span class="text-indigo-300 cursor-pointer hover:text-indigo-100 hover:underline select-none" 
                 
             onmousedown="startFanLongPress(event, '${h.username}')" 
                              onmouseup="cancelFanLongPress(this, '${h.username}')" 
                              ontouchstart="startFanLongPress(event, '${h.username}')" 
                     
         ontouchend="cancelFanLongPress(this, '${h.username}')">
                            ${h.username}
                        </span>
                    </td>
                  
  <td class="text-xs text-gray-400">${h.nickname || '-'}</td>
                    <td class="text-xs ${typeClass}">${h.type}</td>
                    <td class="text-xs text-gray-300 whitespace-pre-wrap">${h.details ||
''}</td>
                    <td class="text-center">
                        <div class="flex justify-center gap-2">
                            <button onclick="openHistoryModal('${h.id}')" class="text-gray-400 hover:text-white" title="編輯"><i class="fas fa-edit"></i></button>
                   
         <button onclick="deleteHistory('${h.id}')" class="text-red-500 hover:text-white" title="刪除"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }


        // [更新後的程式碼]
        // 增加 save 參數，預設為 true。批次匯入時可設為 false 以避免重複寫入歷史
        function addHistoryLog(username, nickname, type, dateStr, details, save = true) {
            historyData.push({
                id: Date.now() + Math.random(),
                date: dateStr,
                username: username,
                nickname: nickname,
                type: type,
                details: details
            });
            // 只有當 save 為 true 時才觸發存檔
            if (save) saveData();
        }

        // --- History Modal Logic ---
        // --- History Modal Logic ---
        function openHistoryModal(id = null) {
            const modal = document.getElementById('historyModal');
            const title = document.getElementById('historyModalTitle');
            const inputs = {
                id: document.getElementById('historyId'),
                user: document.getElementById('histUsername'),
                nick: document.getElementById('histNickname'),
                y: document.getElementById('histDateYYYY'),
                m: document.getElementById('histDateMM'),
                d: document.getElementById('histDateDD'),
                detail: document.getElementById('histDetails')
            };
            
            document.querySelectorAll('#histCheckboxes input').forEach(cb => cb.checked = false);

            if (id) {
                const h = historyData.find(d => d.id == id);
                if (!h) return;
                title.innerText = "編輯動態紀錄";
                inputs.id.value = h.id;
                inputs.user.value = h.username || '';
                inputs.nick.value = h.nickname || '';
                inputs.detail.value = h.details || '';
                
                if(h.date) {
                    const parts = h.date.split(' ')[0].split('/'); 
                    if(parts.length >= 3) {
                        inputs.y.value = parts[0]; inputs.m.value = parts[1]; inputs.d.value = parts[2];
                    }
                }
                const types = (h.type || '').split(' / ');
                document.querySelectorAll('#histCheckboxes input').forEach(cb => {
                    if(types.includes(cb.value)) cb.checked = true;
                });
            } else {
                title.innerText = "新增動態紀錄";
                inputs.id.value = '';
                inputs.user.value = '';
                inputs.nick.value = '';
                inputs.detail.value = '';
                const now = new Date();
                inputs.y.value = now.getFullYear();
                inputs.m.value = String(now.getMonth()+1).padStart(2,'0');
                inputs.d.value = String(now.getDate()).padStart(2,'0');
            }
            modal.classList.remove('hidden');
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.add('hidden');
        }

        function saveHistoryData() {
            const id = document.getElementById('historyId').value;
            const user = document.getElementById('histUsername').value.trim();
            const nick = document.getElementById('histNickname').value.trim();
            const dateStr = `${document.getElementById('histDateYYYY').value}/${document.getElementById('histDateMM').value}/${document.getElementById('histDateDD').value}`;
            const details = document.getElementById('histDetails').value.trim();
            const checked = Array.from(document.querySelectorAll('#histCheckboxes input:checked')).map(cb => cb.value);
            const typeStr = checked.join(' / ');

            if (!user) return alert("請輸入帳號");

            if (id) {
                const idx = historyData.findIndex(h => h.id == id);
                if (idx !== -1) {
                    historyData[idx] = { ...historyData[idx], username: user, nickname: nick, date: dateStr, type: typeStr, details: details };
                }
            } else {
                addHistoryLog(user, nick, typeStr, dateStr, details);
                closeHistoryModal();
                return;
            }
            saveData(); // 使用全局存檔以支援 Undo
            renderHistory();
            closeHistoryModal();
        }

        function addManualInteraction() {
            const usernameInput = document.getElementById('manualUsername');
            if (!validateInput(usernameInput)) return alert("帳號格式錯誤");
            const username = usernameInput.value.trim(); if (!username) return alert("請輸入帳號");
            const nickname = document.getElementById('manualNickname').value.trim();
            const language = document.getElementById('manualLang').value;
            const checkedBoxes = document.querySelector('#manualSection .interaction-checkboxes').querySelectorAll('input:checked');
            let tags = Array.from(checkedBoxes).map(cb => (cb.value === '新粉絲' ? '粉絲' : cb.value));
            const details = document.getElementById('manualDetails').value.trim();
            const manualDateStr = `${document.getElementById('dateYYYY').value}/${document.getElementById('dateMM').value.padStart(2, '0')}/${document.getElementById('dateDD').value.padStart(2, '0')}`;
           
            const existingFan = fans.find(f => f.username === username);
            if (existingFan) {
                existingFan.interactions = Array.from(new Set([...existingFan.interactions, ...tags]));
                if (details) existingFan.details = existingFan.details ? existingFan.details + " / " + details : details;
                if (nickname) existingFan.nickname = nickname;
                existingFan.language = language; 
                if (parseDate(manualDateStr) >= parseDate(existingFan.latestDate)) { existingFan.latestType = tags.join(' / '); existingFan.latestDate = manualDateStr; }
                showToast(`已更新 @${username}`);
            } else {
                fans.push({ id: Date.now(), username, nickname, language, interactions: tags, latestType: tags.join(' / '), latestDate: manualDateStr, details, sent: false, sentDate: '', isCloseFriend: false });
                showToast(`已新增 @${username}`);
            }

            addHistoryLog(username, nickname, tags.join(' / '), manualDateStr, details);

            usernameInput.value = ''; document.getElementById('manualNickname').value = '';
            document.getElementById('manualDetails').value = ''; document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false); initDateInput();
            saveData(); // 使用全局存檔
            renderTable();
        }

        function addHeartData() {
            const username = document.getElementById('heartUser').value.trim();
            const nickname = document.getElementById('heartNick').value.trim();
            const responseItem = document.getElementById('heartResponseItem').value;
            const content = document.getElementById('heartContent').value.trim();
            const dateStr = `${document.getElementById('heartDateYYYY').value}/${document.getElementById('heartDateMM').value}/${document.getElementById('heartDateDD').value}`;
           
            if(!username) return alert("請輸入粉絲帳號");
            heartData.push({ id: Date.now(), username, nickname, responseItem, content, date: dateStr });
            
            saveData(); // 使用全局存檔
            renderHeartData();
            document.getElementById('heartUser').value = '';
            document.getElementById('heartNick').value = '';
            document.getElementById('heartContent').value = '';
            showToast('暖心紀錄已儲存');
        }

        function openEditHeartModal(id) {
            const d = heartData.find(h => h.id === id); // Fix: use find by id
            if(!d) return;
            document.getElementById('editHeartIndex').value = id; // Actually storing ID
            document.getElementById('editHeartUser').value = d.username;
            document.getElementById('editHeartNick').value = d.nickname;
            document.getElementById('editHeartDate').value = d.date;
            document.getElementById('editHeartItem').value = d.responseItem;
            document.getElementById('editHeartContent').value = d.content;
            document.getElementById('editHeartModal').classList.remove('hidden');
        }

        function saveHeartEdit() {
            const id = parseFloat(document.getElementById('editHeartIndex').value);
            const idx = heartData.findIndex(h => h.id === id);
            if(idx !== -1) {
                heartData[idx] = {
                    id: id,
                    username: document.getElementById('editHeartUser').value,
                    nickname: document.getElementById('editHeartNick').value,
                    date: document.getElementById('editHeartDate').value,
                    responseItem: document.getElementById('editHeartItem').value,
                    content: document.getElementById('editHeartContent').value
                };
                saveData(); // 使用全局存檔
                renderHeartData();
                document.getElementById('editHeartModal').classList.add('hidden');
            }
        }
 
        function deleteHeartData(id) {
            if(confirm("確定刪除?")) {
                heartData = heartData.filter(h => h.id !== id);
                saveData(); // 使用全局存檔
                renderHeartData();
            }
        }


        function deleteHistory(id) {
            if(confirm("刪除此條紀錄？")) {
                historyData = historyData.filter(h => h.id != id);
                localStorage.setItem('historyData', JSON.stringify(historyData));
                renderHistory();
            }
        }


        // 2. 官方資料比對功能
        function handleIGJsonImport(e) {
            const file = e.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const json = JSON.parse(ev.target.result);
                    let officialUsers = [];
                    
                    const findValues = (obj) => {
                        if(Array.isArray(obj)) {
                            obj.forEach(item => findValues(item));
                        } else if (typeof obj === 'object' && obj !== null) {
                            if(obj.hasOwnProperty('string_list_data')) {
                                obj.string_list_data.forEach(d => {
                                    if(d.value) officialUsers.push(d.value);
                                });
                            } else {
                                Object.values(obj).forEach(val => findValues(val));
                            }
                        }
                    };
                    findValues(json);
                    
                    officialUsers = [...new Set(officialUsers)];
                    if(officialUsers.length === 0) throw new Error("找不到粉絲資料，請確認檔案格式");


                    compareData(officialUsers);
                    e.target.value = ''; 
                } catch(err) {
                    alert("解析失敗：" + err.message);
                }
            };
            reader.readAsText(file);
        }


        function compareData(officialUsers) {
            const currentUsers = fans.map(f => f.username);
            const newUsers = officialUsers.filter(u => !currentUsers.includes(u));
            
            pendingNewFans = newUsers.map(u => ({ username: u, nickname: '', lang: '中' }));
            
            const unfollowedUsers = fans.filter(f => {
                const isMarkedFan = f.interactions.includes('粉絲');
                return isMarkedFan && !officialUsers.includes(f.username);
            });
            
            pendingUnfollowed = unfollowedUsers;
            renderCompareResults();
        }


        function renderCompareResults() {
            document.getElementById('newFansCount').innerText = pendingNewFans.length;
            const newBody = document.getElementById('newFansBody');
            if(pendingNewFans.length > 0) {
                document.getElementById('newFansResult').classList.remove('hidden');
                newBody.innerHTML = pendingNewFans.map((u, idx) => `
                    <tr class="border-b border-white/5 hover:bg-white/5">
                        <td class="py-2 font-bold text-green-300">${u.username}</td>
                        <td><input type="text" onchange="updatePendingNewFan(${idx}, 'nickname', this.value)" placeholder="暱稱" class="bg-black/30 border border-gray-600 rounded px-2 py-1 text-xs w-24"></td>
                        <td>
                            <select onchange="updatePendingNewFan(${idx}, 'lang', this.value)" class="bg-black/30 border border-gray-600 rounded px-1 py-1 text-xs">
                                <option value="中">中</option>
                                <option value="英">英</option>
                            </select>
                        </td>
                        <td class="text-xs text-gray-400">待加入</td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('newFansResult').classList.add('hidden');
            }


            document.getElementById('unfollowedCount').innerText = pendingUnfollowed.length;
            const unfBody = document.getElementById('unfollowedBody');
            if(pendingUnfollowed.length > 0) {
                document.getElementById('unfollowedResult').classList.remove('hidden');
                unfBody.innerHTML = pendingUnfollowed.map(f => `
                    <tr class="border-b border-white/5 hover:bg-white/5">
                        <td class="py-2 font-bold text-red-300">${f.username}</td>
                        <td class="text-gray-400 text-xs">${f.nickname || '-'}</td>
                        <td class="text-gray-500 text-xs">${f.latestDate || '-'}</td>
                        <td><span class="text-xs bg-red-900/50 text-red-300 px-2 py-1 rounded border border-red-500/30">將移除「粉絲」標籤</span></td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('unfollowedResult').classList.add('hidden');
            }
        }


        function updatePendingNewFan(idx, field, value) {
            pendingNewFans[idx][field] = value;
        }


        function confirmNewFans() {
            if(!confirm(`確定加入 ${pendingNewFans.length} 位新粉絲？`)) return;
            const nowStr = new Date().toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'});
            
            pendingNewFans.forEach(u => {
                fans.push({
                    id: Date.now() + Math.random(),
                    username: u.username,
                    nickname: u.nickname,
                    language: u.lang,
                    interactions: ['粉絲'],
                    latestType: '新粉絲',
                    latestDate: nowStr,
                    details: '官方比對匯入',
                    sent: false,
                    isCloseFriend: false
                });
                // 更新參數順序：user, nick, type, date, detail
                addHistoryLog(u.username, u.nickname, '新粉絲', nowStr, '官方資料比對加入');
            });
            
            saveData();
            pendingNewFans = [];
            renderCompareResults();
            showToast('已加入新粉絲');
        }


        function confirmUnfollowed() {
            if(!confirm(`確定更新 ${pendingUnfollowed.length} 位退追狀態？\n(將移除「粉絲」標籤)`)) return;
            
            const nowStr = new Date().toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'});
            pendingUnfollowed.forEach(u => {
                const fan = fans.find(f => f.id === u.id);
                if(fan) {
                    fan.interactions = fan.interactions.filter(t => t !== '粉絲');
                    // 更新參數順序
                    addHistoryLog(fan.username, fan.nickname, '退追', nowStr, '官方資料比對移除粉絲標籤');
                }
            });
            
            saveData();
            pendingUnfollowed = [];
            renderCompareResults();
            showToast('已更新退追狀態');
        }














        window.onload = () => {
            loadProfile();
            renderTable();
            renderTemplateList();
            initDateInput();
            renderIgPosts();
            renderGiftPosts();
            renderHeartData();
        };
    </script>
</body>
</html>

