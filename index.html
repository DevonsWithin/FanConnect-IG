<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FanConnect V5.3 - 粉絲滿意度管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --indigo-primary: #4B0082; }
        body { background: linear-gradient(135deg, #1a1a1a 0%, #050505 100%); color: #e0e0e0; height: 100vh; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
       
        .sidebar { background-color: rgba(75, 0, 130, 0.15); border-right: 1px solid rgba(75, 0, 130, 0.3); transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); width: 260px; display: flex; flex-direction: column; }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .menu-text, .sidebar.collapsed .logo-text, .sidebar.collapsed .profile-section { display: none; }
       
        .profile-section { text-align: center; padding: 20px 10px; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .profile-avatar-container { position: relative; width: 60px; height: 60px; margin: 0 auto 10px; cursor: pointer; }
        .profile-avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid #a78bfa; transition: all 0.3s; }
        .avatar-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .profile-avatar-container:hover .avatar-overlay { opacity: 1; }
        .profile-name-input { background: transparent; border: none; border-bottom: 1px solid transparent; color: white; text-align: center; font-weight: bold; font-size: 0.9rem; width: 100%; padding: 4px; transition: all 0.3s; }
        .profile-name-input:focus { outline: none; border-bottom: 1px solid #a78bfa; }
 
        .table-container { height: calc(100vh - 140px); overflow-y: auto; overflow-x: auto; position: relative; }
        .table-row:hover { background-color: rgba(75, 0, 130, 0.2); transition: background-color 0.2s; }
        table { border-collapse: separate; border-spacing: 0; width: 100%; }
 
        @media (max-width: 768px) { table { min-width: 900px; } }
 
        .sticky-col-1 { position: sticky; left: 0; z-index: 25; background-color: #151515; width: 35px; min-width: 35px; }
        .sticky-col-2 { position: sticky; left: 35px; z-index: 25; background-color: #151515; border-right: none; }
        .sticky-col-last { position: sticky; right: 0; z-index: 25; background-color: #151515; border-left: 1px solid #333; }
 
        th.sticky-col-1, th.sticky-col-2, th.sticky-col-last { z-index: 30; background-color: #202020; }
       
        .table-row:hover .sticky-col-1,
        .table-row:hover .sticky-col-2,
        .table-row:hover .sticky-col-last { background-color: #2a1b3d; }
 
        th { background-color: #202020; position: sticky; top: 0; z-index: 20; padding: 10px; text-align: left; font-size: 0.8rem; color: #aaa; letter-spacing: 1px; border-bottom: 2px solid #4B0082; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        td { padding: 8px 10px; border-bottom: 1px solid #333; vertical-align: middle; }
       
        .thread-badge { background-color: #000; color: #fff; border: 1px solid #4b5563; }
        .fan-badge-style { background-color: rgba(131, 24, 67, 0.4); color: #fbcfe8; border: 1px solid rgba(236, 72, 153, 0.3); box-shadow: 0 0 10px rgba(236, 72, 153, 0.3); }
 
        .btn-indigo { background-color: var(--indigo-primary); transition: all 0.2s; }
        .btn-indigo:hover { background-color: #5a009d; box-shadow: 0 0 15px rgba(75, 0, 130, 0.5); transform: translateY(-1px); }
        .input-dark { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 4px; padding: 8px 12px; width: 100%; transition: border-color 0.3s; }
        .input-dark:focus { outline: none; border-color: #4B0082; }
        .input-error { border-color: #ef4444 !important; background-color: rgba(239, 68, 68, 0.1); }
       
        .visited-link { color: #047857 !important; text-decoration: none !important; font-weight: bold; transition: color 0.3s; }
        .star-btn { transition: transform 0.2s, color 0.2s; cursor: pointer; }
        .star-btn:hover { transform: scale(1.2); }
        .star-active { color: #fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        .star-inactive { color: #4b5563; }
 
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #4B0082; border-radius: 4px; }
 
        .date-segment-container { display: flex; align-items: center; gap: 4px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 4px 8px; width: fit-content; }
        .date-segment-container input { background: transparent; border: none; color: white; text-align: center; padding: 4px 0; outline: none; width: 100%; }
        .date-segment-container input:focus { border-bottom: 1px solid #a78bfa; }

        /* [新增] 疑似重複篩選樣式 */
        .duplicate-group-a { background-color: rgba(20, 184, 166, 0.15) !important; border-left: 3px solid #14b8a6; } /* 青色 A */
        .duplicate-group-b { background-color: rgba(20, 184, 166, 0.05) !important; border-left: 3px solid #0d9488; } /* 青色 B (較淺) */
        .btn-cyan { background-color: rgba(20, 184, 166, 0.2); color: #2dd4bf; border: 1px solid rgba(20, 184, 166, 0.3); }
        .btn-cyan:hover { background-color: rgba(20, 184, 166, 0.4); color: white; }

/* 鑰匙管理專用樣式 */
        @keyframes blink-red { 0%, 100% { background-color: #4b5563; } 50% { background-color: #dc2626; box-shadow: 0 0 10px #ef4444; } }
        @keyframes blink-green { 0%, 100% { background-color: #064e3b; } 50% { background-color: #059669; box-shadow: 0 0 10px #10b981; } }
        @keyframes blink-yellow { 0%, 100% { background-color: #713f12; } 50% { background-color: #d97706; box-shadow: 0 0 10px #f59e0b; } }
        
        .flashing-master { animation: blink-red 1.5s infinite; color: white !important; border-color: white !important; }
        .flashing-append { animation: blink-green 1.5s infinite; color: white !important; border-color: white !important; opacity: 1 !important; }
        .flashing-edit { animation: blink-yellow 1.5s infinite; color: white !important; border-color: white !important; opacity: 1 !important; }

        .key-row-pinned { background-color: rgba(16, 185, 129, 0.08); border-left: 3px solid #10b981; }
        .key-row-disabled { filter: grayscale(1); opacity: 0.6; pointer-events: none; }


    </style>
</head>
<body class="flex">
 
    <aside id="sidebar" class="sidebar backdrop-blur-md">
        <div class="p-4 flex items-center gap-4 h-16 border-b border-white/10 shrink-0">
            <button onclick="toggleSidebar()" class="text-white text-lg hover:text-indigo-400 w-6 text-center">
                <i class="fas fa-bars"></i>
            </button>
            <span class="font-bold text-lg tracking-wider italic logo-text text-indigo-400">FanConnect <span class="text-xs bg-indigo-600 text-white px-1 rounded ml-1 not-italic">V5.3</span></span>
        </div>
 
        <div class="profile-section">
            <input type="file" id="avatarUpload" class="hidden" accept="image/*" onchange="handleAvatarUpload(event)">
            <div class="profile-avatar-container" onclick="document.getElementById('avatarUpload').click()">
                <img id="userAvatar" src="https://ui-avatars.com/api/?name=Brand&background=4B0082&color=fff" class="profile-avatar" alt="Avatar">
                <div class="avatar-overlay"><i class="fas fa-camera text-white text-xs"></i></div>
            </div>
            <input type="text" id="userName" value="Brand Name" class="profile-name-input" onchange="saveProfile()" title="點擊編輯品牌名稱">
        </div>
       
        <nav class="flex-1 overflow-y-auto custom-scrollbar flex flex-col pt-2">
            <div>
                <a href="#" onclick="showSection('fans')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-indigo-500">
                    <i class="fas fa-users-cog w-6 text-center"></i> <span class="menu-text">粉絲管理列表</span>
                </a>
                <a href="#" onclick="showSection('manual')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-indigo-500">
                    <i class="fas fa-keyboard w-6 text-center"></i> <span class="menu-text">手動新增紀錄</span>
                </a>
                <a href="#" onclick="showSection('templates')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-indigo-500">
                    <i class="fas fa-pen-nib w-6 text-center"></i> <span class="menu-text">訊息模板設定</span>
                </a>
            </div>
 
            <div class="my-2 border-t border-white/10 mx-4 shrink-0"></div>
 
            <div>
                <a href="#" onclick="showSection('igPosts')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-pink-500">
                    <i class="fab fa-instagram w-6 text-center text-pink-400"></i> <span class="menu-text">IG 貼文列表</span>
                </a>
                <a href="#" onclick="showSection('giftPosts')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-purple-500">
                    <i class="fas fa-gift w-6 text-center text-purple-400"></i> <span class="menu-text">禮物貼文列表</span>
                </a>
                <a href="#" onclick="showSection('heartStats')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-red-500">
                    <i class="fas fa-heart w-6 text-center text-red-400"></i> <span class="menu-text">粉絲暖心互動</span>
                </a>
            </div>
 
            <div class="my-2 border-t border-white/10 mx-4 shrink-0"></div>
           












            




<div>
                <a href="#" onclick="showSection('decrypt')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-teal-500">
                    <i class="fas fa-unlock-alt w-6 text-center text-teal-400"></i> <span class="menu-text">連結解密 / 驗證</span>
                </a>
                <a href="#" onclick="showSection('keyManage')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-emerald-500">
                    <i class="fas fa-key w-6 text-center text-emerald-400"></i> <span class="menu-text">鑰匙管理</span>
                </a>
            </div>
 
            <div class="my-2 border-t border-white/10 mx-4 shrink-0"></div>




            <div>
                <a href="#" onclick="showSection('history')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-cyan-500">
                    <i class="fas fa-history w-6 text-center text-cyan-400"></i> <span class="menu-text">動態紀錄</span>
                </a>
                <a href="#" onclick="showSection('compare')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-orange-500">
                    <i class="fas fa-exchange-alt w-6 text-center text-orange-400"></i> <span class="menu-text">官方資料比對</span>
                </a>
            </div>




            <div class="my-2 border-t border-white/10 mx-4 shrink-0"></div>
            
            <div>
                <a href="#" onclick="backupData()" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors">
























                    <i class="fas fa-save w-6 text-center text-yellow-400"></i> <span class="menu-text">備份資料</span>
                </a>
                <a href="#" onclick="document.getElementById('restoreImport').click()" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors">
                    <i class="fas fa-folder-open w-6 text-center text-yellow-400"></i> <span class="menu-text">還原資料</span>
                </a>
                <a href="#" onclick="document.getElementById('excelImport').click()" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors">
                    <i class="fas fa-file-import w-6 text-center text-green-400"></i> <span class="menu-text">匯入 Excel</span>
                </a>
                <a href="#" onclick="exportExcel()" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors">
                    <i class="fas fa-file-export w-6 text-center text-green-400"></i> <span class="menu-text">匯出 Excel</span>
                </a>
                <a href="#" onclick="clearAllData()" class="flex items-center gap-4 p-4 hover:bg-red-900/10 text-red-900 hover:text-red-500 transition-colors">
                    <i class="fas fa-trash-alt w-6 text-center"></i> <span class="menu-text font-bold text-[10px]">清空列表資料</span>
                </a>
            </div>
        </nav>
 
        <div class="p-4 border-t border-white/10 bg-black/20 shrink-0">
            <a href="https://www.instagram.com" target="_blank" class="flex items-center gap-4 text-sm text-gray-400 hover:text-white group">
                <i class="fab fa-instagram w-6 text-center text-pink-500 group-hover:scale-110 transition-transform"></i>
                <span class="menu-text font-bold">開啟 Instagram</span>
            </a>
        </div>
    </aside>
 
    <main class="flex-1 flex flex-col overflow-hidden relative">
        <input type="file" id="excelImport" class="hidden" accept=".xlsx, .xls, .csv" onchange="handleExcelImport(event)">
        <input type="file" id="restoreImport" class="hidden" accept=".json" onchange="handleRestore(event)">
 
        <header class="h-16 border-b border-white/10 flex justify-between items-center px-6 bg-[#121212] shrink-0 gap-4">
            
            <!-- 左側區域：標題 + 工具列 + 搜尋 -->
            <div class="flex items-center gap-6 flex-1">
                <h2 id="sectionTitle" class="text-xl font-bold text-white tracking-wide shrink-0">粉絲滿意度管理系統</h2>
                
                <div class="flex items-center gap-4">
                    <!-- 復原/重作 (移至左側) -->
                    <div class="flex items-center gap-1 p-1 bg-white/5 rounded border border-white/5">
                        <button onclick="undo()" class="p-1.5 text-gray-400 hover:text-white hover:bg-white/10 rounded transition-colors text-xs" title="復原 (Ctrl+Z)">
                            <i class="fas fa-undo"></i>
                        </button>
                        <div class="w-[1px] h-3 bg-white/10 my-auto"></div>
                        <button onclick="redo()" class="p-1.5 text-gray-400 hover:text-white hover:bg-white/10 rounded transition-colors text-xs" title="重作 (Ctrl+Y)">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>

                    <!-- 搜尋框 (移至左側) -->
                    <div class="relative group">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-xs"></i>
                        <input type="text" id="globalSearch" placeholder="搜尋帳號 / 互動..."
                               class="bg-[#222] border border-gray-700 rounded-full pl-8 pr-8 py-1.5 text-sm focus:outline-none focus:border-indigo-500 w-64 transition-all"
                               onkeyup="handleGlobalSearch(); document.getElementById('clearSearchBtn').classList.toggle('hidden', this.value.length === 0)">
                        <button onclick="clearSearch()" id="clearSearchBtn" class="hidden absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-white" title="清除搜尋">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 右側區域：粉絲人數 + 功能按鈕 -->
            <div class="flex gap-4 items-center shrink-0">
                <div id="fanCountBadge" class="fan-badge-style px-4 py-1.5 rounded-full text-xs font-bold transition-all whitespace-nowrap">
                    粉絲人數: 0
                </div>

                <div class="h-6 w-[1px] bg-white/10 mx-1"></div>

                <!-- [新增] 疑似重複篩選按鈕 -->
                <button id="btnDuplicateCheck" onclick="openDuplicateModal()" class="btn-cyan px-3 py-1.5 rounded text-xs font-bold transition-all shadow-md flex items-center gap-2 whitespace-nowrap">
                    <i class="fas fa-clone"></i> 篩選疑似重複
                </button>
                <button id="btnDuplicateExit" onclick="exitDuplicateMode()" class="hidden bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded text-xs font-bold transition-all flex items-center gap-2 whitespace-nowrap border border-white/10">
                    <i class="fas fa-times"></i> 結束篩選
                </button>
            </div>
        </header>
 
         <div id="contentArea" class="flex-1 overflow-hidden p-0 bg-[#0a0a0a]">
           
            <div id="fansSection" class="h-full p-4 flex flex-col">
                <div class="bg-[#151515] rounded-lg border border-white/5 flex-1 overflow-hidden relative shadow-xl flex flex-col">
               
     <div class="table-container custom-scrollbar flex-1" style="height: auto;">
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr>
                                    <th width="4%" class="text-center sticky-col-1"><i class="fas fa-star text-yellow-500"></i></th>
                                    <th width="15%" class="sticky-col-2 cursor-pointer select-none"
                                        onmousedown="startHeaderLongPress(event, 'username')"
                                        onmouseup="cancelHeaderLongPress()"
                                        onmouseleave="cancelHeaderLongPress()"
                                        ontouchstart="startHeaderLongPress(event, 'username')"
                                        ontouchend="cancelHeaderLongPress()">
                                        帳號名稱 <i id="icon_filter_username" class="fas fa-filter text-[10px] text-pink-500 ml-1 hidden"></i>
                                    </th>
                                    <th width="8%">暱稱</th>
                                    <th width="15%" class="text-indigo-300 cursor-pointer select-none"
                                        onmousedown="startHeaderLongPress(event, 'status')"
                                        onmouseup="cancelHeaderLongPress()"
                                        onmouseleave="cancelHeaderLongPress()"
                                        ontouchstart="startHeaderLongPress(event, 'status')"
                                        ontouchend="cancelHeaderLongPress()">
                                        <i class="fas fa-history mr-1"></i>最新動態 <i id="icon_filter_status" class="fas fa-filter text-[10px] text-pink-500 ml-1 hidden"></i>
                                    </th>
                                    <th width="20%" class="cursor-pointer select-none"
                                        onmousedown="startHeaderLongPress(event, 'interactions')"
                                        onmouseup="cancelHeaderLongPress()"
                                        onmouseleave="cancelHeaderLongPress()"
                                        ontouchstart="startHeaderLongPress(event, 'interactions')"
                                        ontouchend="cancelHeaderLongPress()">
                                        互動標籤 <i id="icon_filter_interactions" class="fas fa-filter text-[10px] text-pink-500 ml-1 hidden"></i>
                                    </th>
                                    <th width="23%">詳細內容</th>
                                    <th width="95px" class="cursor-pointer select-none min-w-[95px]"
                                        onmousedown="startHeaderLongPress(event, 'sent')"
                                        onmouseup="cancelHeaderLongPress()"
                                        onmouseleave="cancelHeaderLongPress()"
                                        ontouchstart="startHeaderLongPress(event, 'sent')"
                                        ontouchend="cancelHeaderLongPress()">
                                        訊息 <i id="icon_filter_sent" class="fas fa-filter text-[10px] text-pink-500 ml-1 hidden"></i>
                                    </th>
                                    <th width="7%" class="text-center sticky-col-last">操作</th>
                                </tr>
                            </thead>
                            <tbody id="fanTableBody"></tbody>
                        </table>
                        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-gray-500">
                            <i class="fas fa-file-csv text-4xl mb-4 opacity-50"></i>
                            <p>尚無資料，請匯入 Excel/CSV 或手動新增</p>
                            <p class="text-xs text-gray-600 mt-2">提示：若暱稱抓取失敗，請確認 Excel 欄位名稱包含「暱稱」、「Name」</p>
                        </div>
             
       </div>
                    
                    <div class="w-full text-center py-2 text-[10px] font-bold text-[#4B0082] tracking-wider select-none shrink-0 border-t border-white/5">
                        Designed by Devons Within © 2026
                    </div>
                </div>
            </div>
 
            <div id="manualSection" class="hidden h-full p-8 overflow-y-auto">
                <div class="max-w-3xl mx-auto bg-[#1a1a1a] rounded-2xl border border-indigo-500/20 shadow-2xl overflow-hidden">
                    <div class="flex border-b border-white/10 bg-[#222]">
                        <button onclick="switchManualTab('standard')" id="tabBtnStd" class="flex-1 py-4 text-center font-bold text-indigo-400 border-b-2 border-indigo-500 bg-[#1a1a1a]">
                            <i class="fas fa-keyboard mr-2"></i>手動新增互動紀錄
                        </button>
                        <button onclick="switchManualTab('heart')" id="tabBtnHeart" class="flex-1 py-4 text-center font-bold text-gray-500 hover:text-pink-400 hover:bg-[#2a1a1a] transition-all">
                            <i class="fas fa-heart mr-2"></i>暖心時刻
                        </button>
                    </div>
 
                    <div class="p-8">
                        <div id="manualStandardForm" class="space-y-6 block">
                            <div class="grid grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-gray-400 text-xs mb-2">帳號名稱 (@Username) <span class="text-red-500">*</span></label>
                                    <input type="text" id="manualUsername" list="usernameOptions" placeholder="輸入帳號" class="input-dark py-3" oninput="validateInput(this); autoFillManualNickname()">
                                    <datalist id="usernameOptions"></datalist>
                                    <p class="text-[10px] text-red-500 mt-1 hidden" id="manualUsernameErr">格式錯誤</p>
                                </div>
                                <div>
                                    <label class="block text-gray-400 text-xs mb-2">暱稱 / 語言</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="manualNickname" placeholder="粉絲稱呼" class="input-dark py-3 w-[70%]">
                                        <select id="manualLang" class="input-dark py-3 w-[30%] text-center">
                                            <option value="中" selected>中</option>
                                            <option value="英">英</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-black/20 p-4 rounded-lg border border-white/5">
                                <div class="mb-3 text-indigo-300 text-sm font-bold">互動類型 (可多選)</div>
                                <div class="grid grid-cols-4 gap-3 interaction-checkboxes">
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 text-pink-400 font-bold border border-pink-900/30 bg-pink-900/10 p-2 rounded"><input type="checkbox" value="粉絲" class="accent-indigo-500"> 粉絲</label>
  
                                  <label class="flex items-center gap-2 cursor-pointer hover:text-[#763BE3] p-2 text-[#763BE3] font-bold"><input type="checkbox" value="前帳粉" class="accent-[#763BE3]"> 前帳粉</label>
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-amber-400 p-2 text-amber-500 font-bold"><input type="checkbox" value="高互動" class="accent-amber-500"> 高互動</label>
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-white p-2 text-gray-300 font-bold bg-black/40 rounded border border-gray-600"><input type="checkbox" value="Thread粉" class="accent-gray-500"> Thread粉</label>
                               
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="留言" class="accent-indigo-500"> 留言</label>
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="讚" class="accent-indigo-500"> 讚</label>
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="投票" class="accent-indigo-500"> 投票</label>
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="分享" class="accent-indigo-500"> 分享</label>
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="回覆" class="accent-indigo-500"> 回覆</label>
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="提及" class="accent-indigo-500"> 提及</label>
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 p-2"><input type="checkbox" value="轉發" class="accent-indigo-500"> 轉發</label>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-gray-400 text-xs mb-2">最新互動/活動日期</label>
                                <div class="date-segment-container">
                                    <input type="text" id="dateYYYY" maxlength="4" placeholder="YYYY" style="width: 40px;">
                                    <span class="text-gray-500">/</span>
                                    <input type="text" id="dateMM" maxlength="2" placeholder="MM" style="width: 24px;">
                                    <span class="text-gray-500">/</span>
                                    <input type="text" id="dateDD" maxlength="2" placeholder="DD" style="width: 24px;">
                                </div>
                            </div>
                            <div>
                                <label class="block text-gray-400 text-xs mb-2">詳細內容</label>
                                <textarea id="manualDetails" placeholder="例如：限動投票「A選項」" class="input-dark h-32"></textarea>
                            </div>
                            <button onclick="addManualInteraction()" class="btn-indigo w-full py-3 rounded-lg font-bold text-white text-lg shadow-lg hover:shadow-indigo-500/50">新增並更新</button>
                        </div>
 
                        <div id="manualHeartForm" class="hidden space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-400 text-xs mb-2">粉絲帳號 <span class="text-red-500">*</span></label>
                                    <input type="text" id="heartUser" list="usernameOptions" placeholder="輸入帳號" class="input-dark py-3" onchange="autoFillHeartNickname()">
                                </div>
                                <div>
                                    <label class="block text-gray-400 text-xs mb-2">粉絲暱稱 (自動帶入)</label>
                                    <input type="text" id="heartNick" class="input-dark py-3">
                                </div>
                            </div>
                            <div>
                                <label class="block text-gray-400 text-xs mb-2">回應日期</label>
                                <div class="flex items-center gap-4">
                                    <div class="date-segment-container">
                                        <input type="text" id="heartDateYYYY" maxlength="4" placeholder="YYYY" style="width: 40px;">
                                        <span class="text-gray-500">/</span>
                                        <input type="text" id="heartDateMM" maxlength="2" placeholder="MM" style="width: 24px;">
                                        <span class="text-gray-500">/</span>
                                        <input type="text" id="heartDateDD" maxlength="2" placeholder="DD" style="width: 24px;">
                                    </div>
                                    <label class="flex items-center gap-1 text-xs text-gray-400 cursor-pointer select-none">
                                        <input type="checkbox" id="heartCheckComment" class="accent-pink-500" checked onchange="toggleHeartCheck('comment')"> 留言
                                    </label>
                                    <label class="flex items-center gap-1 text-xs text-gray-400 cursor-pointer select-none">
                                        <input type="checkbox" id="heartCheckDM" class="accent-indigo-500" onchange="toggleHeartCheck('dm')"> DM(私訊)
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-gray-400 text-xs mb-2">回應項目</label>
                                <select id="heartResponseItem" class="input-dark py-3" onchange="handleHeartItemChange(this)">
                                    <option value="DM">DM私訊內容</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-400 text-xs mb-2">回應內容 (可換行)</label>
                                <textarea id="heartContent" placeholder="輸入暖心回應內容..." class="input-dark h-32"></textarea>
                            </div>
                            <button onclick="addHeartData()" class="w-full py-3 rounded-lg font-bold text-white text-lg shadow-lg bg-pink-700 hover:bg-pink-600 transition-all">新增暖心紀錄</button>
                        </div>
                    </div>
                </div>
            </div>
 
            <div id="igPostsSection" class="hidden h-full flex flex-col p-4">
                <div class="w-full max-w-6xl mx-auto flex flex-col h-full">
                    <div class="bg-[#1a1a1a] p-4 rounded-xl border border-white/10 mb-4 shrink-0 shadow-lg z-10">
                        <h3 class="text-lg font-bold mb-3 text-pink-400"><i class="fab fa-instagram mr-2"></i>IG 貼文管理</h3>
                        <div class="grid grid-cols-4 gap-3 mb-3">
                            <input type="text" id="igTopic" placeholder="主題" class="input-dark text-xs">
                            <textarea id="igFile" placeholder="檔案名稱 (可 Enter 換行)" class="input-dark text-xs h-10 py-2 resize-none leading-normal"></textarea>
                            <textarea id="igContent" placeholder="內文 (可 Enter 換行)" class="input-dark text-xs h-10 py-2 resize-none leading-normal"></textarea>
                            <input type="text" id="igHash" placeholder="#hashtag" class="input-dark text-xs">
                        </div>
                        <div class="flex items-center gap-4 mb-3">
                            <div class="flex items-center gap-2">
                                <label class="text-gray-400 text-xs whitespace-nowrap">發布日期</label>
                                <div class="date-segment-container">
                                    <input type="text" id="igDateYYYY" maxlength="4" placeholder="YYYY" style="width: 40px;">
                                    <span class="text-gray-500">/</span>
                                    <input type="text" id="igDateMM" maxlength="2" placeholder="MM" style="width: 24px;">
                                    <span class="text-gray-500">/</span>
                                    <input type="text" id="igDateDD" maxlength="2" placeholder="DD" style="width: 24px;">
                                </div>
                                <label class="flex items-center gap-1 text-xs text-gray-400 cursor-pointer ml-2 select-none">
                                    <input type="checkbox" id="igIsPlanned" class="accent-indigo-500"> 規劃發文
                                </label>
                            </div>
                            <button onclick="addIgPost()" class="btn-indigo flex-1 py-1.5 rounded font-bold text-white text-sm">新增貼文資料</button>
                        </div>
                    </div>
                    <div class="bg-[#151515] rounded-lg border border-white/5 flex-1 overflow-hidden relative shadow-xl">
                         <div class="h-full overflow-y-auto custom-scrollbar">
                            <table class="w-full text-left text-sm">
                                <thead>
                                    <tr>
                                        <th width="15%" class="sticky top-0 bg-[#202020] z-20 shadow-md">主題</th>
                                        <th width="10%" class="sticky top-0 bg-[#202020] z-20 shadow-md">日期</th>
                                        <th width="30%" class="sticky top-0 bg-[#202020] z-20 shadow-md">內文</th>
                                        <th width="20%" class="sticky top-0 bg-[#202020] z-20 shadow-md">檔案名稱</th>
                                        <th width="15%" class="sticky top-0 bg-[#202020] z-20 shadow-md">Hashtag</th>
                                        <th width="10%" class="text-center sticky top-0 bg-[#202020] z-20 shadow-md">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="igPostTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
 
            <div id="giftPostsSection" class="hidden h-full flex flex-col p-4">
                <div class="w-full max-w-6xl mx-auto flex flex-col h-full">
                    <div class="bg-[#1a1a1a] p-4 rounded-xl border border-white/10 mb-4 shrink-0 shadow-lg z-10">
                        <h3 class="text-lg font-bold mb-3 text-purple-400"><i class="fas fa-gift mr-2"></i>禮物貼文管理</h3>
                        <div class="grid grid-cols-3 gap-3 mb-3">
                            <input type="text" id="giftId" placeholder="禮物 ID" class="input-dark text-xs">
                            <textarea id="giftFile" placeholder="檔案名稱 (可 Enter 換行)" class="input-dark text-xs h-10 py-2 resize-none leading-normal"></textarea>
                            <textarea id="giftDesc" placeholder="描述 (可 Enter 換行)" class="input-dark text-xs h-10 py-2 resize-none leading-normal"></textarea>
                        </div>
                        <div class="flex items-center gap-4 mb-3">
                            <div class="flex items-center gap-2">
                                <label class="text-gray-400 text-xs whitespace-nowrap">發布日期</label>
                                <div class="date-segment-container">
                                    <input type="text" id="giftDateYYYY" maxlength="4" placeholder="YYYY" style="width: 40px;">
                                    <span class="text-gray-500">/</span>
                                    <input type="text" id="giftDateMM" maxlength="2" placeholder="MM" style="width: 24px;">
                                    <span class="text-gray-500">/</span>
                                    <input type="text" id="giftDateDD" maxlength="2" placeholder="DD" style="width: 24px;">
                                </div>
                                <label class="flex items-center gap-1 text-xs text-gray-400 cursor-pointer ml-2 select-none">
                                    <input type="checkbox" id="giftIsPlanned" class="accent-purple-500"> 規劃發文
                                </label>
                            </div>
                            <button onclick="addGiftPost()" class="btn-indigo flex-1 py-1.5 rounded font-bold text-white text-sm">新增禮物資料</button>
                        </div>
                    </div>
                    <div class="bg-[#151515] rounded-lg border border-white/5 flex-1 overflow-hidden relative shadow-xl">
                        <div class="h-full overflow-y-auto custom-scrollbar">
                            <table class="w-full text-left text-sm">
                                <thead>
                                    <tr>
                                        <th width="15%" class="sticky top-0 bg-[#202020] z-20 shadow-md">禮物 ID</th>
                                        <th width="15%" class="sticky top-0 bg-[#202020] z-20 shadow-md">日期</th>
                                        <th width="20%" class="sticky top-0 bg-[#202020] z-20 shadow-md">檔案名稱</th>
                                        <th width="40%" class="sticky top-0 bg-[#202020] z-20 shadow-md">描述</th>
                                        <th width="10%" class="text-center sticky top-0 bg-[#202020] z-20 shadow-md">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="giftPostTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
 
            <div id="heartStatsSection" class="hidden h-full flex flex-col p-8">
                <div class="w-full max-w-5xl mx-auto flex flex-col h-full bg-[#1a1a1a] p-8 rounded-2xl border border-red-500/20 shadow-2xl">
                    <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4 shrink-0">
                        <h3 class="text-2xl font-bold text-red-400">
                            <i class="fas fa-heart mr-2"></i>暖心互動紀錄表
                        </h3>
                        <div class="flex items-center gap-2">
                             <select id="heartKeySelect" class="hidden bg-[#222] border border-gray-600 rounded px-2 py-1.5 text-xs text-white focus:outline-none focus:border-emerald-500 transition-all"></select>
                             <button id="addToKeyBtn" onclick="toggleHeartKeyMode()" class="text-xs bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded transition-all border border-transparent">
                                <i class="fas fa-plus mr-1"></i>新增至鑰匙名單
                             </button>
                        </div>
                    </div>
                    <div class="bg-[#151515] rounded-lg border border-white/5 flex-1 overflow-hidden relative">
                        <div class="h-full overflow-y-auto custom-scrollbar">
                            <table class="w-full text-left text-sm">
                                <thead>
                                    <tr>
                                        <th width="5%" class="hidden sticky top-0 bg-[#202020] z-20 shadow-md text-center" id="heartCheckHeader">
                                            <input type="checkbox" onclick="toggleAllHeartChecks(this)" class="accent-emerald-500">
                                        </th>
                                        <th width="15%" class="sticky top-0 bg-[#202020] z-20 shadow-md">粉絲帳號</th>
                                        <th width="10%" class="sticky top-0 bg-[#202020] z-20 shadow-md">粉絲暱稱</th>
                                
                                        <th width="10%" class="sticky top-0 bg-[#202020] z-20 shadow-md">回應日期</th>
                                        <th width="10%" class="sticky top-0 bg-[#202020] z-20 shadow-md">回應項目</th>
                                        
                                        <th width="30%" class="sticky top-0 bg-[#202020] z-20 shadow-md">回應內容</th>
                                        <th width="8%" class="sticky top-0 bg-[#202020] z-20 shadow-md">訊息</th>
                                        <th width="7%" class="text-center sticky top-0 bg-[#202020] z-20 shadow-md">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="heartTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
 
            <div id="templatesSection" class="hidden h-full p-8 overflow-y-auto">
                <div class="max-w-3xl mx-auto">
                    <div class="bg-[#1a1a1a] p-6 rounded-xl border border-white/10 mb-8">
                        <h3 class="text-xl font-bold mb-4 text-indigo-300">訊息模板設定</h3>
                        <div class="space-y-4">
                            <input type="hidden" id="tmpId">
                            <input type="text" id="tmpTitle" placeholder="模板標題" class="input-dark">
                            <div class="relative">
                                <textarea id="tmpBody" placeholder="輸入訊息內容... &#10;提示：輸入 {link} 可自動帶入生成的加密連結" class="input-dark h-32"></textarea>
                                <div class="absolute bottom-2 right-2 text-xs text-gray-500">可用變數: {nickname}, {link}</div>
                            </div>
                            <div class="flex gap-2">
                                <button id="saveTmpBtn" onclick="addTemplate()" class="btn-indigo flex-1 py-2 rounded font-bold text-white">儲存模板</button>
                                <button id="cancelTmpBtn" onclick="cancelEditTemplate()" class="hidden bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-white">取消</button>
                            </div>
                        </div>
                    </div>
                    <div id="templateListDisplay" class="space-y-3"></div>
                </div>
            </div>
 
            <div id="decryptSection" class="hidden h-full p-8 overflow-y-auto">
                <div class="max-w-2xl mx-auto bg-[#1a1a1a] p-8 rounded-2xl border border-teal-500/30 shadow-2xl">
                    <h3 class="text-2xl font-bold mb-6 text-teal-400 border-b border-white/10 pb-4">連結解密與驗證</h3>
                    <div class="space-y-6">
                        <div>
                            <label class="block text-gray-400 text-xs mb-2">貼上完整加密連結 或 Token 亂碼</label>
                            <textarea id="decryptInput" placeholder="例如: https://.../vault/secure/eyJ..." class="input-dark h-24 font-mono text-xs"></textarea>
                        </div>
                        <button onclick="runDecryption()" class="w-full py-3 rounded-lg font-bold text-black bg-teal-500 hover:bg-teal-400 shadow-lg transition-all">開始解密</button>
                        <div id="decryptResult" class="hidden bg-black/40 p-4 rounded border border-white/10 font-mono text-sm space-y-3">
                            <div class="flex justify-between border-b border-white/10 pb-2"><span class="text-gray-500">狀態</span><span id="resStatus" class="font-bold"></span></div>
                            <div class="flex justify-between"><span class="text-gray-500">貼文 ID (PID)</span><span id="resPid" class="text-yellow-400"></span></div>
                            <div class="flex justify-between"><span class="text-gray-500">目標粉絲 (User)</span><span id="resUser" class="text-pink-400"></span></div>
                            <div class="flex justify-between"><span class="text-gray-500">生成時間</span><span id="resTime" class="text-blue-300"></span></div>
                            












<div class="flex justify-between"><span class="text-gray-500">有效期限</span><span id="resExpire" class="text-gray-300"></span></div>
                        </div>
                    </div>
                </div>
            </div>




<div id="keyManageSection" class="hidden h-full flex flex-col p-4">
                <div class="w-full max-w-full mx-auto flex flex-col h-full">
                    <div class="bg-[#1a1a1a] p-4 rounded-xl border border-emerald-500/30 mb-4 shrink-0 shadow-lg z-10">
                        <h3 class="text-lg font-bold mb-3 text-emerald-400"><i class="fas fa-key mr-2"></i>鑰匙管理系統</h3>
                        <div class="flex items-center gap-3">
                            <!-- 1. 下拉選單 -->
                            <div class="flex items-center gap-2">
                                <label class="text-xs text-gray-400 font-bold whitespace-nowrap">Gift ID:</label>
                                <select id="keyGiftSelect" onchange="renderKeyTable()" class="input-dark text-xs h-10 w-40 border-emerald-500/50 font-bold focus:border-emerald-400">
                                    <option value="">-- 請選擇 --</option>
                                </select>
                            </div>

                            <div class="h-8 w-[1px] bg-white/10 mx-1"></div>

                            <!-- 2. 編輯鑰匙名單 (主按鈕) -->
                            <button id="btnKeyMaster" onclick="toggleKeyEditMaster()" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded text-xs font-bold transition-all shadow-md whitespace-nowrap border border-white/10">
                                <i class="fas fa-cog mr-1"></i>編輯鑰匙名單
                            </button>

                            <!-- 子功能按鈕區 (隱藏) -->
                            <div id="keyModeBtns" class="hidden flex gap-2">
                                <button id="btnKeyAppend" onclick="setKeySubMode('append')" class="px-3 py-2 rounded text-xs font-bold border border-emerald-500/50 text-emerald-300 bg-emerald-900/20 transition-all whitespace-nowrap opacity-50">
                                    <i class="fas fa-plus mr-1"></i>追加並產出
                                </button>
                                <button id="btnKeyEdit" onclick="setKeySubMode('edit')" class="px-3 py-2 rounded text-xs font-bold border border-yellow-500/50 text-yellow-300 bg-yellow-900/20 transition-all whitespace-nowrap opacity-50">
                                    <i class="fas fa-edit mr-1"></i>僅編輯
                                </button>
                            </div>

                            <!-- 3. 製作清單按鈕 -->
                            <button onclick="openMakeListModal(document.getElementById('keyGiftSelect').value)" class="bg-emerald-900/80 hover:bg-emerald-800 text-emerald-100 text-xs px-4 py-2 rounded font-bold border border-emerald-500/30 transition-colors whitespace-nowrap ml-2">
                                <i class="fas fa-file-code mr-1"></i>製作清單
                            </button>

                            <!-- Spacer -->
                            <div class="flex-1"></div>

                            <!-- 4. 連結產生器 (最右邊) -->
                            <div class="flex items-center gap-2 bg-black/40 p-1 pl-3 rounded border border-white/10 max-w-[400px]">
                                <span class="text-[10px] text-gray-500 font-bold whitespace-nowrap select-none"><i class="fas fa-link mr-1"></i>入口連結</span>
                                <input type="text" id="keyLinkInput" readonly placeholder="選擇 ID 後生成..." class="bg-transparent border-none text-emerald-400 text-xs w-full focus:outline-none font-mono text-ellipsis">
                                <button onclick="copyKeyLink()" class="bg-emerald-700 hover:bg-emerald-600 text-white text-[10px] px-3 py-1.5 rounded font-bold whitespace-nowrap transition-colors">
                                    複製
                                </button>
                            </div>
                        </div>
                        <div class="text-right mt-1 h-4">
                             <span class="text-[10px] text-gray-500 italic" id="keyStatusText"></span>
                        </div>
                    </div>

                    <!-- 資料列表區 -->
                    <div class="bg-[#151515] rounded-lg border border-white/5 flex-1 overflow-hidden relative shadow-xl flex flex-col">
                         <div class="table-container custom-scrollbar flex-1" style="height: auto;">
                            <table class="w-full text-left text-sm">
                                <thead>
                                    <tr>
                                        <th width="4%" class="text-center sticky-col-1 bg-[#202020] z-30">
                                            <input type="checkbox" id="keySelectAll" onclick="handleKeySelectAll(this)" disabled class="accent-emerald-500 cursor-not-allowed">
                                        </th>
                                        <th width="15%" class="sticky-col-2 cursor-pointer select-none bg-[#202020] z-30" onmousedown="startHeaderLongPress(event, 'username')" onmouseup="cancelHeaderLongPress()" onmouseleave="cancelHeaderLongPress()" ontouchstart="startHeaderLongPress(event, 'username')" ontouchend="cancelHeaderLongPress()">
                                            帳號名稱 <i id="key_icon_filter_username" class="fas fa-filter text-[10px] text-emerald-400 ml-1 hidden"></i>
                                        </th>
                                        <th width="8%" class="bg-[#202020] z-20">暱稱</th>
                                        <th width="15%" class="text-indigo-300 cursor-pointer select-none bg-[#202020] z-20" onmousedown="startHeaderLongPress(event, 'status')" onmouseup="cancelHeaderLongPress()" onmouseleave="cancelHeaderLongPress()" ontouchstart="startHeaderLongPress(event, 'status')" ontouchend="cancelHeaderLongPress()">
                                            <i class="fas fa-history mr-1"></i>最新動態 <i id="key_icon_filter_status" class="fas fa-filter text-[10px] text-emerald-400 ml-1 hidden"></i>
                                        </th>
                                        <th width="20%" class="cursor-pointer select-none bg-[#202020] z-20" onmousedown="startHeaderLongPress(event, 'interactions')" onmouseup="cancelHeaderLongPress()" onmouseleave="cancelHeaderLongPress()" ontouchstart="startHeaderLongPress(event, 'interactions')" ontouchend="cancelHeaderLongPress()">
                                            互動標籤 <i id="key_icon_filter_interactions" class="fas fa-filter text-[10px] text-emerald-400 ml-1 hidden"></i>
                                        </th>
                                        <th width="23%" class="bg-[#202020] z-20">詳細內容</th>
                                        <th width="8%" class="cursor-pointer select-none bg-[#202020] z-20" onmousedown="startHeaderLongPress(event, 'sent')" onmouseup="cancelHeaderLongPress()" onmouseleave="cancelHeaderLongPress()" ontouchstart="startHeaderLongPress(event, 'sent')" ontouchend="cancelHeaderLongPress()">
                                            訊息 <i id="key_icon_filter_sent" class="fas fa-filter text-[10px] text-emerald-400 ml-1 hidden"></i>
                                        </th>
                                        <th width="7%" class="text-center sticky-col-last bg-[#202020] z-30">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="keyTableBody"></tbody>
                            </table>
                            <div id="keyEmptyState" class="flex flex-col items-center justify-center py-20 text-gray-500 hidden">
                                <i class="fas fa-key text-4xl mb-4 opacity-50"></i>
                                <p>請選擇上方的禮物 ID 以載入資料</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="keyListModal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-[150] backdrop-blur-sm">
                <div class="bg-[#1a1a1a] border border-emerald-500/30 w-[500px] rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
                    <div class="bg-[#202020] p-4 border-b border-white/10 flex justify-between items-center shrink-0">
                        <h3 class="text-emerald-400 font-bold text-lg"><i class="fas fa-user-lock mr-2"></i>管理鑰匙權限</h3>
                        <button onclick="closeKeyListModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-4 bg-black/20 border-b border-white/5 shrink-0">
                        <h4 id="keyListTitle" class="text-white font-bold mb-2">Gift ID</h4>
                        <input type="text" id="keyListSearch" onkeyup="filterKeyList()" placeholder="搜尋粉絲帳號..." class="input-dark text-xs">
                    </div>
                    <div id="keyListContainer" class="p-4 overflow-y-auto custom-scrollbar flex-1 space-y-2"></div>
                    <div class="p-4 bg-black/20 border-t border-white/5 flex justify-end gap-3 shrink-0">
                        <button onclick="closeKeyListModal()" class="px-4 py-2 text-gray-400 hover:text-white text-sm">取消</button>
                        <button onclick="saveKeyPermissions()" class="btn-indigo bg-emerald-700 hover:bg-emerald-600 px-6 py-2 rounded text-white font-bold">儲存變更</button>
                    </div>
                </div>
            </div>

            <div id="jsonListModal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-[150] backdrop-blur-sm">
                <div class="bg-[#1a1a1a] border border-emerald-500/30 w-[500px] rounded-xl shadow-2xl overflow-hidden">
                    <div class="bg-[#202020] p-4 border-b border-white/10 flex justify-between items-center">
                        <h3 class="text-emerald-400 font-bold text-lg"><i class="fas fa-code mr-2"></i>製作清單 (JSON)</h3>
                        <button onclick="document.getElementById('jsonListModal').classList.add('hidden')" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-400 text-xs mb-2">請複製以下內容：</p>
                        <textarea id="jsonOutput" class="w-full bg-black border border-emerald-500/30 p-4 rounded h-40 text-sm font-mono text-emerald-300 focus:outline-none" readonly></textarea>
                    </div>
                    <div class="p-4 bg-black/20 border-t border-white/5 flex justify-end gap-3">
                        <button onclick="document.getElementById('jsonListModal').classList.add('hidden')" class="px-4 py-2 text-gray-400 hover:text-white text-sm">關閉</button>
                        <button onclick="copyJsonOutput()" class="btn-indigo bg-emerald-700 hover:bg-emerald-600 px-6 py-2 rounded text-white font-bold"><i class="fas fa-copy mr-1"></i>複製</button>
                    </div>
                </div>
            </div>




            <div id="historySection" class="hidden h-full flex flex-col p-8">
                <div class="w-full max-w-5xl mx-auto flex flex-col h-full bg-[#1a1a1a] p-8 rounded-2xl border border-cyan-500/20 shadow-2xl">
                    <h3 class="text-2xl font-bold mb-6 text-cyan-400 border-b border-white/10 pb-4 flex justify-between items-center">
                        <span><i class="fas fa-history mr-2"></i>動態紀錄</span>
                        <button onclick="openHistoryModal()" class="text-sm bg-cyan-900/30 hover:bg-cyan-700 px-3 py-1 rounded text-cyan-200 border border-cyan-500/30">
                            <i class="fas fa-plus mr-1"></i>手動新增
                        </button>
                    </h3>
                    <div class="bg-[#151515] rounded-lg border border-white/5 flex-1 overflow-hidden relative">
                        <div class="h-full overflow-y-auto custom-scrollbar">
                            <table class="w-full text-left text-sm">
                                <thead>
                                    <tr>
                                        <th width="12%" class="sticky top-0 bg-[#202020] z-20 shadow-md">日期</th>
                                        <th width="15%" class="sticky top-0 bg-[#202020] z-20 shadow-md">帳號</th>
                                        <th width="12%" class="sticky top-0 bg-[#202020] z-20 shadow-md">暱稱</th>
                                        <th width="20%" class="sticky top-0 bg-[#202020] z-20 shadow-md">類型</th>
                                        <th width="30%" class="sticky top-0 bg-[#202020] z-20 shadow-md">詳細內容</th>
                                        <th width="11%" class="text-center sticky top-0 bg-[#202020] z-20 shadow-md">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>




            <div id="compareSection" class="hidden h-full flex flex-col p-8 overflow-y-auto">
                <div class="w-full max-w-6xl mx-auto space-y-6">
                    <div class="bg-[#1a1a1a] p-6 rounded-xl border border-orange-500/30 shadow-lg">
                        <h3 class="text-xl font-bold mb-4 text-orange-400"><i class="fab fa-instagram mr-2"></i>官方資料比對 (JSON)</h3>
                        <div class="flex items-center gap-4">
                            <input type="file" id="igJsonFile" accept=".json" class="hidden" onchange="handleIGJsonImport(event)">
                            <button onclick="document.getElementById('igJsonFile').click()" class="btn-indigo bg-orange-700 hover:bg-orange-600 text-white px-6 py-2 rounded font-bold">
                                <i class="fas fa-file-upload mr-2"></i>匯入 followers.json
                            </button>
                            <div class="text-xs text-gray-400">
                                請匯入 IG 官方下載資料中的 <code class="bg-black/30 px-1 rounded">followers_1.json</code>
                            </div>
                        </div>
                    </div>




                    <div id="newFansResult" class="hidden bg-[#1a1a1a] p-6 rounded-xl border border-green-500/30 shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-bold text-green-400">發現新粉絲 (<span id="newFansCount">0</span>)</h4>
                            <button onclick="confirmNewFans()" class="bg-green-700 hover:bg-green-600 text-white px-4 py-1.5 rounded text-sm font-bold shadow-lg">
                                <i class="fas fa-check mr-1"></i>確認加入列表
                            </button>
                        </div>
                        <div class="max-h-64 overflow-y-auto custom-scrollbar bg-[#151515] rounded border border-white/5">
                            <table class="w-full text-left text-sm">
                                <thead>
                                    <tr>
                                        <th class="sticky top-0 bg-[#202020] z-20">帳號名稱</th>
                                        <th class="sticky top-0 bg-[#202020] z-20">設定暱稱</th>
                                        <th class="sticky top-0 bg-[#202020] z-20">語系</th>
                                        <th class="sticky top-0 bg-[#202020] z-20">狀態</th>
                                    </tr>
                                </thead>
                                <tbody id="newFansBody"></tbody>
                            </table>
                        </div>
                    </div>




                    <div id="unfollowedResult" class="hidden bg-[#1a1a1a] p-6 rounded-xl border border-red-500/30 shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-bold text-red-400">疑似退追粉絲 (<span id="unfollowedCount">0</span>)</h4>
                            <button onclick="confirmUnfollowed()" class="bg-red-900/50 hover:bg-red-700 text-red-200 px-4 py-1.5 rounded text-sm font-bold shadow-lg">
                                <i class="fas fa-user-minus mr-1"></i>確認更新狀態
                            </button>
                        </div>
                        <div class="max-h-64 overflow-y-auto custom-scrollbar bg-[#151515] rounded border border-white/5">
                            <table class="w-full text-left text-sm">
                                <thead>
                                    <tr>
                                        <th class="sticky top-0 bg-[#202020] z-20">帳號名稱</th>
                                        <th class="sticky top-0 bg-[#202020] z-20">目前暱稱</th>
                                        <th class="sticky top-0 bg-[#202020] z-20">最後互動</th>
                                        <th class="sticky top-0 bg-[#202020] z-20">處理方式</th>
                                    </tr>
                                </thead>
                                <tbody id="unfollowedBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>




        <div id="historyModal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-[110] backdrop-blur-sm">
        <div class="bg-[#1a1a1a] border border-cyan-500/30 w-[700px] rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-[#202020] p-4 border-b border-white/10 flex justify-between items-center shrink-0">
                <h3 class="text-cyan-400 font-bold text-lg"><i class="fas fa-history mr-2"></i><span id="historyModalTitle">新增動態紀錄</span></h3>
                <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-5 overflow-y-auto custom-scrollbar flex-1">
                <input type="hidden" id="historyId">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-400 text-xs mb-2">帳號名稱 (@Username)</label>
                        <input type="text" id="histUsername" list="usernameOptions" class="input-dark" placeholder="輸入帳號">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-xs mb-2">暱稱</label>
                        <input type="text" id="histNickname" class="input-dark" placeholder="粉絲暱稱">
                    </div>
                </div>
                
                <div class="bg-black/20 p-4 rounded border border-white/5">
                    <label class="block text-gray-400 text-xs mb-2">互動類型 (可多選)</label>
                    <div class="grid grid-cols-4 gap-3" id="histCheckboxes">
                        <label class="flex items-center gap-2 cursor-pointer hover:text-cyan-300 text-pink-400 font-bold"><input type="checkbox" value="粉絲" class="accent-cyan-500"> 粉絲</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-[#763BE3] font-bold text-[#763BE3]"><input type="checkbox" value="前帳粉" class="accent-[#763BE3]"> 前帳粉</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-amber-300 
 font-bold text-amber-500"><input type="checkbox" value="高互動" class="accent-amber-500"> 高互動</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-white text-gray-300 font-bold bg-black/40 rounded px-1"><input type="checkbox" value="Thread粉" class="accent-gray-500"> Thread粉</label>
                        
                        <label class="flex items-center gap-2 cursor-pointer hover:text-cyan-300"><input type="checkbox" value="留言" class="accent-cyan-500"> 留言</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-cyan-300"><input type="checkbox" value="讚" class="accent-cyan-500"> 讚</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-cyan-300"><input type="checkbox" value="投票" class="accent-cyan-500"> 投票</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-cyan-300"><input type="checkbox" value="分享" class="accent-cyan-500"> 分享</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-cyan-300"><input type="checkbox" value="回覆" class="accent-cyan-500"> 回覆</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-cyan-300"><input type="checkbox" value="提及" class="accent-cyan-500"> 提及</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-cyan-300"><input type="checkbox" value="轉發" class="accent-cyan-500"> 轉發</label>
                    </div>
                </div>


                <div>
                    <label class="block text-gray-400 text-xs mb-2">活動日期 (YYYY/MM/DD)</label>
                    <div class="date-segment-container w-full bg-black/40">
                        <input type="text" id="histDateYYYY" maxlength="4" placeholder="YYYY" style="width: 60px;" class="text-center bg-transparent text-white outline-none">
                        <span class="text-gray-500">/</span>
                        <input type="text" id="histDateMM" maxlength="2" placeholder="MM" style="width: 40px;" class="text-center bg-transparent text-white outline-none">
                        <span class="text-gray-500">/</span>
                        <input type="text" id="histDateDD" maxlength="2" placeholder="DD" style="width: 40px;" class="text-center bg-transparent text-white outline-none">
                    </div>
                </div>


                <div>
                    <label class="block text-gray-400 text-xs mb-2">詳細內容</label>
                    <textarea id="histDetails" class="input-dark h-24" placeholder="詳細內容..."></textarea>
                </div>
            </div>
            <div class="p-4 bg-black/20 border-t border-white/5 flex justify-end gap-3">
                <button onclick="closeHistoryModal()" class="px-4 py-2 text-gray-400 hover:text-white text-sm">取消</button>
                <button onclick="saveHistoryData()" class="btn-indigo bg-cyan-700 hover:bg-cyan-600 px-6 py-2 rounded text-white font-bold">儲存紀錄</button>
            </div>
        </div>
    </div>


















 
    <div id="msgModal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-[100] backdrop-blur-sm">
        <div class="bg-[#1a1a1a] border border-indigo-500/50 w-[600px] rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-indigo-900/20 p-4 border-b border-indigo-500/30 flex justify-between items-center">
                <h3 class="text-indigo-300 font-bold text-lg">發送訊息</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex items-center justify-between text-sm text-gray-400 bg-black/40 p-2 rounded">
                    <span>目標帳號：<span id="targetUser" class="text-white font-mono"></span></span>
                    <span>稱呼：<span id="targetNickname" class="text-indigo-300"></span></span>
                </div>
                <div class="bg-indigo-900/10 p-3 rounded border border-indigo-500/20">
                    <label class="text-[10px] uppercase tracking-wider text-indigo-400 font-bold mb-2 block flex justify-between">
                        <span><i class="fas fa-shield-alt mr-1"></i>安全追蹤連結 (Next.js)</span>
                        <span class="text-gray-500 font-normal normal-case">請選擇時效</span>
                    </label>
                    <div class="flex gap-2 items-center">
                        <select id="targetLinkInput" class="input-dark text-xs h-9 w-3/5">
                            <option value="">-- 選擇禮物 --</option>
                        </select>
                                           <div class="flex items-center gap-2 text-[10px] text-gray-400 whitespace-nowrap px-1">
                        <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="linkExpiry" value="24" checked class="accent-indigo-500"> 24h</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="linkExpiry" value="168" class="accent-indigo-500"> 7day</label>
                                               <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="linkExpiry" value="0" class="accent-red-500"> 永久</label>
                    </div>
                    <div class="flex items-center px-1">
                        <label class="flex items-center gap-1 text-[10px] text-indigo-300 font-bold cursor-pointer bg-indigo-900/30 px-2 py-1 rounded border border-indigo-500/30 hover:bg-indigo-900/50 transition-all" title="透過 TinyURL 生成短網址">
                            <input type="checkbox" id="useShortUrl" class="accent-indigo-500" checked> 轉短網址
                        </label>
                    </div>
                    <button onclick="generateHashLink()" id="genLinkBtn" class="btn-indigo px-3 py-1 rounded text-xs whitespace-nowrap font-bold h-9 flex-1"><i class="fas fa-lock mr-1"></i>生成</button>
                </div>


                    <input type="hidden" id="finalGeneratedLink">
                    <p class="text-[10px] text-gray-500 mt-1 italic">* 系統將「粉絲帳號+目前時間」打包加密成亂碼參數，Next.js 端需解碼驗證。</p>
                </div>
                <select id="modalTempSelect" onchange="applyTemplate()" class="input-dark"><option value="">-- 選擇模板 --</option></select>
                <textarea id="modalText" class="w-full bg-black border border-indigo-500/30 p-4 rounded h-40 text-sm leading-relaxed text-gray-200 focus:border-indigo-500 focus:outline-none"></textarea>
             </div>
            <div class="p-4 bg-black/20 border-t border-white/5 flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-400 hover:text-white text-sm">取消</button>
                <button onclick="confirmSend()" class="btn-indigo px-6 py-2 rounded text-white font-bold flex items-center gap-2"><i class="fas fa-copy"></i> 複製並開啟 IG</button>
            </div>
        </div>
    </div>
 
    <div id="editFanModal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-[110] backdrop-blur-sm">
        <div class="bg-[#1a1a1a] border border-indigo-500/30 w-[650px] rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-[#202020] p-4 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-indigo-400 font-bold text-lg"><i class="fas fa-edit mr-2"></i>編輯粉絲資料</h3>
                <button onclick="closeEditFanModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
             </div>
            <div class="p-6 space-y-5">
                <input type="hidden" id="editFanId">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-400 text-xs mb-2">帳號名稱 (@Username)</label>
                        <input type="text" id="editFanUsername" class="input-dark" oninput="validateInput(this)">
                        <p class="text-[10px] text-red-500 mt-1 hidden" id="editFanUsernameErr">格式錯誤</p>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-xs mb-2">暱稱 (Nickname)</label>
                        <input type="text" id="editFanNickname" class="input-dark">
                    </div>
                </div>
                 <div class="bg-black/20 p-4 rounded border border-white/5">
                    <label class="block text-gray-400 text-xs mb-2">編輯互動標籤</label>
                    <div class="grid grid-cols-4 gap-3" id="editFanCheckboxes">
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300 text-pink-400 font-bold"><input type="checkbox" value="粉絲" class="accent-indigo-500"> 粉絲</label>
                        <label class="flex items-center gap-2 
 cursor-pointer hover:text-[#763BE3] text-[#763BE3] font-bold"><input type="checkbox" value="前帳粉" class="accent-[#763BE3]"> 前帳粉</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-amber-300 text-amber-500 font-bold"><input type="checkbox" value="高互動" class="accent-amber-500"> 高互動</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-white text-gray-300 font-bold bg-black/40 rounded px-1"><input type="checkbox" value="Thread粉" class="accent-gray-500"> Thread粉</label>


                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="留言" class="accent-indigo-500"> 留言</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="讚" class="accent-indigo-500"> 讚</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="投票" class="accent-indigo-500"> 投票</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="分享" class="accent-indigo-500"> 分享</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="回覆" class="accent-indigo-500"> 回覆</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="提及" class="accent-indigo-500"> 提及</label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-300"><input type="checkbox" value="轉發" class="accent-indigo-500"> 轉發</label>
                    </div>
                    <div id="editFanExtraTags" class="mt-3 flex flex-wrap gap-2 text-xs"></div>
                </div>
                <div>
                    <label class="block text-gray-400 text-xs mb-2">詳細內容</label>
                    <textarea id="editFanDetails" class="input-dark h-24"></textarea>
                </div>
            </div>
            <div class="p-4 bg-black/20 border-t border-white/5 flex justify-end gap-3">
                <button onclick="closeEditFanModal()" class="px-4 py-2 text-gray-400 hover:text-white text-sm">取消</button>
                <button onclick="saveFanEdit()" class="btn-indigo px-6 py-2 rounded text-white font-bold">儲存變更</button>
            </div>
        </div>
    </div>
 
    <div id="editIgModal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-[110] backdrop-blur-sm">
        <div class="bg-[#1a1a1a] border border-pink-500/30 w-[600px] rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-[#202020] p-4 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-pink-400 font-bold text-lg"><i class="fas fa-edit mr-2"></i>編輯 IG 貼文</h3>
                <button onclick="document.getElementById('editIgModal').classList.add('hidden')" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="editIgIndex">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-gray-400 text-xs mb-2">主題</label><input type="text" id="editIgTopic" class="input-dark"></div>
                    <div>
                        <label class="block text-gray-400 text-xs mb-2">日期 (YYYY/MM/DD)</label>
                        <div class="flex gap-2 items-center">
                            <input type="text" id="editIgDate" class="input-dark">
                            <label class="whitespace-nowrap text-xs text-gray-400 flex items-center gap-1"><input type="checkbox" id="editIgIsPlanned" class="accent-pink-500"> 規劃發文</label>
                        </div>
                    </div>
                </div>
                <div><label class="block text-gray-400 text-xs mb-2">檔案名稱 (可換行)</label><textarea id="editIgFile" class="input-dark h-20"></textarea></div>
                <div><label class="block text-gray-400 text-xs mb-2">內文 (可換行)</label><textarea id="editIgContent" class="input-dark h-24"></textarea></div>
                <div><label class="block text-gray-400 text-xs mb-2">Hashtag</label><input type="text" id="editIgHash" class="input-dark"></div>
            </div>
            <div class="p-4 bg-black/20 border-t border-white/5 flex justify-end gap-3">
                <button onclick="document.getElementById('editIgModal').classList.add('hidden')" class="px-4 py-2 text-gray-400 hover:text-white text-sm">取消</button>
                <button onclick="saveIgPostEdit()" class="btn-indigo px-6 py-2 rounded text-white font-bold">儲存變更</button>
            </div>
        </div>
    </div>
 
    <div id="editGiftModal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-[110] backdrop-blur-sm">
        <div class="bg-[#1a1a1a] border border-purple-500/30 w-[600px] rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-[#202020] p-4 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-purple-400 font-bold text-lg"><i class="fas fa-edit mr-2"></i>編輯禮物貼文</h3>
                <button onclick="document.getElementById('editGiftModal').classList.add('hidden')" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="editGiftIndex">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-gray-400 text-xs mb-2">禮物 ID</label><input type="text" id="editGiftId" class="input-dark"></div>
                    <div>
                        <label class="block text-gray-400 text-xs mb-2">日期 (YYYY/MM/DD)</label>
                        <div class="flex gap-2 items-center">
                            <input type="text" id="editGiftDate" class="input-dark">
                            <label class="whitespace-nowrap text-xs text-gray-400 flex items-center gap-1"><input type="checkbox" id="editGiftIsPlanned" class="accent-purple-500"> 規劃發文</label>
                        </div>
                    </div>
                </div>
                <div><label class="block text-gray-400 text-xs mb-2">檔案名稱 (可換行)</label><textarea id="editGiftFile" class="input-dark h-20"></textarea></div>
                <div><label class="block text-gray-400 text-xs mb-2">描述 (可換行)</label><textarea id="editGiftDesc" class="input-dark h-24"></textarea></div>
            </div>
            <div class="p-4 bg-black/20 border-t border-white/5 flex justify-end gap-3">
                <button onclick="document.getElementById('editGiftModal').classList.add('hidden')" class="px-4 py-2 text-gray-400 hover:text-white text-sm">取消</button>
                <button onclick="saveGiftPostEdit()" class="btn-indigo px-6 py-2 rounded text-white font-bold">儲存變更</button>
            </div>
        </div>
    </div>
 
    <div id="editHeartModal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-[110] backdrop-blur-sm">
        <div class="bg-[#1a1a1a] border border-red-500/30 w-[600px] rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-[#202020] p-4 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-red-400 font-bold text-lg"><i class="fas fa-edit mr-2"></i>編輯暖心紀錄</h3>
                <button onclick="document.getElementById('editHeartModal').classList.add('hidden')" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="editHeartIndex">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-gray-400 text-xs mb-2">粉絲帳號</label><input type="text" id="editHeartUser" class="input-dark"></div>
                    <div><label class="block text-gray-400 text-xs mb-2">粉絲暱稱</label><input type="text" id="editHeartNick" class="input-dark"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-gray-400 text-xs mb-2">回應日期</label><input type="text" id="editHeartDate" class="input-dark"></div>
                    <div>
                        <label class="block text-gray-400 text-xs mb-2">回應項目</label>
                        <select id="editHeartItem" class="input-dark py-2">
                            <option value="DM">DM (私訊)</option>
                             <optgroup label="IG 貼文" id="editHeartItemIg"></optgroup>
                             <optgroup label="禮物 ID" id="editHeartItemGift"></optgroup>
                        </select>
                    </div>
                </div>
                <div><label class="block text-gray-400 text-xs mb-2">回應內容 (可換行)</label><textarea id="editHeartContent" class="input-dark h-24"></textarea></div>
            </div>
            <div class="p-4 bg-black/20 border-t border-white/5 flex justify-end gap-3">
                <button onclick="document.getElementById('editHeartModal').classList.add('hidden')" class="px-4 py-2 text-gray-400 hover:text-white text-sm">取消</button>
                <button onclick="saveHeartEdit()" class="btn-indigo px-6 py-2 rounded text-white font-bold">儲存變更</button>
            </div>
        </div>
    </div>
 
    <div id="toast" class="fixed bottom-8 right-8 bg-indigo-600 text-white px-6 py-3 rounded shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-[200]">操作成功</div>

    <!-- 疑似重複篩選 Modal -->
    <div id="duplicateModal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-[150] backdrop-blur-sm">
        <div class="bg-[#1a1a1a] border border-cyan-500/30 w-[400px] rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-[#202020] p-4 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-cyan-400 font-bold text-lg"><i class="fas fa-clone mr-2"></i>篩選疑似重複</h3>
                <button onclick="document.getElementById('duplicateModal').classList.add('hidden')" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-gray-400 text-sm">請選擇要比對的時間範圍 (篩選前先過濾資料量)：</p>
                <div class="grid grid-cols-1 gap-2">
                    <button onclick="runDuplicateAnalysis(7)" class="w-full py-2 bg-black/40 hover:bg-cyan-900/30 text-cyan-100 border border-white/10 rounded text-sm transition-colors text-left px-4">最近 7 天</button>
                    <button onclick="runDuplicateAnalysis(30)" class="w-full py-2 bg-black/40 hover:bg-cyan-900/30 text-cyan-100 border border-white/10 rounded text-sm transition-colors text-left px-4">最近 1 個月</button>
                    <button onclick="runDuplicateAnalysis(90)" class="w-full py-2 bg-black/40 hover:bg-cyan-900/30 text-cyan-100 border border-white/10 rounded text-sm transition-colors text-left px-4">最近 3 個月</button>
                    <button onclick="runDuplicateAnalysis(180)" class="w-full py-2 bg-black/40 hover:bg-cyan-900/30 text-cyan-100 border border-white/10 rounded text-sm transition-colors text-left px-4">3 個月 ~ 6 個月</button>
                    <button onclick="runDuplicateAnalysis(999)" class="w-full py-2 bg-black/40 hover:bg-cyan-900/30 text-cyan-100 border border-white/10 rounded text-sm transition-colors text-left px-4">6 個月以上 (全範圍)</button>
                </div>
                <div class="text-[10px] text-gray-500 mt-2 border-t border-white/5 pt-2">
                    <p><i class="fas fa-info-circle mr-1"></i> 比對邏輯：</p>
                    <p class="ml-4">• 粉絲列表：帳號外型相似 (如 0/o, 1/l) 或 暱稱重複</p>
                    <p class="ml-4">• 暖心/動態：同一人 + 同一日 + 內容相似度 > 80%</p>
                </div>
            </div>
        </div>
    </div>
 
    <div id="filterMenu" class="fixed z-[600] hidden bg-[#1a1a1a] border border-indigo-500/50 rounded-lg shadow-2xl flex-col w-64 max-h-[450px]" onclick="event.stopPropagation()">
        <div class="p-3 border-b border-white/10 flex justify-between items-center bg-[#252525]">
            <span class="text-indigo-400 font-bold text-sm"><i class="fas fa-sort-amount-down mr-2"></i>欄位操作</span>
            <button onclick="closeFilterMenu()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        <div id="sortSection" class="p-4 bg-[#2a2a2a]">
            <div id="filterContentContainer" class="space-y-3"></div>
        </div>
        <div class="p-3 border-t border-white/10 flex justify-end bg-[#252525]"><p class="text-[10px] text-gray-500">提示：點擊 X 關閉視窗</p></div>
    </div>
 
    <script>
























let fans = JSON.parse(localStorage.getItem('fans')) || [];
        let templates = JSON.parse(localStorage.getItem('templates')) || [{ id: 1, title: "感謝支持", body: "嗨 {nickname}，感謝你之前的支持！這裡有給你的專屬禮物：\n{link}" }];
        let igPosts = JSON.parse(localStorage.getItem('igPosts')) || [];
        let giftPosts = JSON.parse(localStorage.getItem('giftPosts')) || [];
        let heartData = JSON.parse(localStorage.getItem('heartData')) || [];
        let historyData = JSON.parse(localStorage.getItem('historyData')) || [];
        let keyPermissions = JSON.parse(localStorage.getItem('keyPermissions')) || {}; // { "giftId": ["user1", "user2"] }
        let isHeartKeyMode = false; // 暖心互動選擇模式狀態

        // [新增] 疑似重複篩選變數
        let isDuplicateMode = false;
        let duplicateResults = []; // 存放篩選出的資料

        // [新增] Levenshtein Distance 演算法 (計算字串相似度)
        function levenshteinDistance(a, b) {
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;
            const matrix = [];
            for (let i = 0; i <= b.length; i++) { matrix[i] = [i]; }
            for (let j = 0; j <= a.length; j++) { matrix[0][j] = j; }
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1));
                    }
                }
            }
            return matrix[b.length][a.length];
        }

        // [新增] 計算相似度百分比
        function calculateSimilarity(s1, s2) {
            if (!s1 || !s2) return 0;
            const longer = s1.length > s2.length ? s1 : s2;
            if (longer.length === 0) return 1.0;
            return (longer.length - levenshteinDistance(s1, s2)) / longer.length;
        }

        // [新增] 帳號正規化 (處理 AI 誤判形狀)
        function normalizeUsername(u) {
            if (!u) return '';
            return u.toLowerCase()
                .replace(/0/g, 'o')
                .replace(/1/g, 'l')
                .replace(/_/g, '')
                .replace(/\./g, '');
        }

        // [新增] 開啟篩選 Modal
        function openDuplicateModal() {
            // 判斷目前在哪個 Section
            const sections = ['fans', 'heartStats', 'history'];
            const active = sections.find(s => !document.getElementById(s + 'Section').classList.contains('hidden'));
            
            if (!active) {
                alert("此功能僅支援：粉絲列表、暖心互動、動態紀錄");
                return;
            }
            document.getElementById('duplicateModal').classList.remove('hidden');
        }

        // [新增] 執行篩選分析
        function runDuplicateAnalysis(days) {
            document.getElementById('duplicateModal').classList.add('hidden');
            const sections = ['fans', 'heartStats', 'history'];
            const activeSection = sections.find(s => !document.getElementById(s + 'Section').classList.contains('hidden'));
            
            duplicateResults = []; // 清空舊結果
            const now = Date.now();
            const timeLimit = days * 24 * 60 * 60 * 1000;
            
            let sourceData = [];
            
            // 1. 準備資料與初步時間過濾
            if (activeSection === 'fans') {
                sourceData = fans.filter(f => {
                    if (days === 999) return true;
                    const d = parseDate(f.latestDate);
                    // 若無日期視為久遠資料，不列入短期比對，除非選全範圍
                    if (!d) return false; 
                    return (now - d) <= timeLimit;
                });
            } else if (activeSection === 'heartStats') {
                sourceData = heartData.filter(h => {
                    if (days === 999) return true;
                    const d = parseDate(h.date);
                    return (now - d) <= timeLimit;
                });
            } else if (activeSection === 'history') {
                // [修正] 動態紀錄需合併「系統紀錄」與「暖心互動」才能抓出跨類型的重複
                const sysLogs = historyData.filter(h => {
                    // 過濾掉舊的標籤以免混淆，這部分與 renderHistory 保持一致
                    return h.type !== '留言' && h.type !== 'DM'; 
                });

                // 將暖心紀錄轉換為動態紀錄格式
                const heartLogs = heartData.map(h => ({
                    id: h.id, 
                    // 加上前綴避免 ID 衝突 (雖然機率極低)
                    originalId: h.id, 
                    source: 'heart',
                    date: h.date,
                    username: h.username,
                    nickname: h.nickname,
                    type: h.responseItem === 'DM' ? 'DM' : '留言',
                    details: h.responseItem === 'DM' ? h.content : `已回應：${h.content}`
                }));

                const allLogs = [...sysLogs, ...heartLogs];

                sourceData = allLogs.filter(h => {
                    if (days === 999) return true;
                    const d = parseDate(h.date);
                    return (now - d) <= timeLimit;
                });
            }

            if (sourceData.length < 2) return showToast("篩選範圍內資料不足，無法比對");

            // 2. 執行比對演算法
            let groups = [];
            let visited = new Set();

            if (activeSection === 'fans') {
                // A. 粉絲列表比對邏輯
                // 優化：先依「正規化帳號」分組，再比對暱稱
                for (let i = 0; i < sourceData.length; i++) {
                    if (visited.has(sourceData[i].id)) continue;
                    let currentGroup = [sourceData[i]];
                    const normA = normalizeUsername(sourceData[i].username);
                    const nickA = (sourceData[i].nickname || '').trim().toLowerCase();

                    for (let j = i + 1; j < sourceData.length; j++) {
                        if (visited.has(sourceData[j].id)) continue;
                        const itemB = sourceData[j];
                        const normB = normalizeUsername(itemB.username);
                        const nickB = (itemB.nickname || '').trim().toLowerCase();

                        // 判斷條件：帳號形狀極似 OR (帳號不同但暱稱完全相同且非空)
                        const isUserSimilar = calculateSimilarity(normA, normB) > 0.95; // 正規化後極高相似
                        const isNickSame = nickA && nickB && nickA === nickB; // 暱稱完全相同

                        if (isUserSimilar || isNickSame) {
                            currentGroup.push(itemB);
                            visited.add(itemB.id);
                        }
                    }
                    if (currentGroup.length > 1) {
                        currentGroup.forEach(item => {
                            // 標記群組 ID，用於渲染顏色
                            item.dupGroupId = i; 
                            groups.push(item);
                        });
                    }
                }

            } else {
                // B. 暖心/動態 比對邏輯
                // 條件：同一人 + 同一日 + 內容相似度 > 80%
                for (let i = 0; i < sourceData.length; i++) {
                    if (visited.has(sourceData[i].id)) continue;
                    let currentGroup = [sourceData[i]];
                    const userA = sourceData[i].username.toLowerCase();
                    const dateA = sourceData[i].date || ''; // YYYY/MM/DD
                    const contentA = activeSection === 'heartStats' ? (sourceData[i].content || '') : (sourceData[i].details || '');

                    for (let j = i + 1; j < sourceData.length; j++) {
                        if (visited.has(sourceData[j].id)) continue;
                        const itemB = sourceData[j];
                        const userB = itemB.username.toLowerCase();
                        const dateB = itemB.date || '';
                        
                        // 初步篩選：人與日期必須相同
                        if (userA !== userB || dateA !== dateB) continue;

                        const contentB = activeSection === 'heartStats' ? (itemB.content || '') : (itemB.details || '');
                        // 內容相似度檢查
                        if (calculateSimilarity(contentA, contentB) > 0.8) {
                            currentGroup.push(itemB);
                            visited.add(itemB.id);
                        }
                    }
                    if (currentGroup.length > 1) {
                        currentGroup.forEach(item => {
                            item.dupGroupId = i;
                            groups.push(item);
                        });
                    }
                }
            }

            if (groups.length === 0) {
                showToast("未發現疑似重複資料");
                return;
            }

            // 3. 設定狀態並重新渲染
            duplicateResults = groups;
            isDuplicateMode = true;
            document.getElementById('btnDuplicateCheck').classList.add('hidden');
            document.getElementById('btnDuplicateExit').classList.remove('hidden');
            
            // [修正] 立即同步狀態到 localStorage，確保後續操作(如刪除)能捕捉到正確的「當前模式」
            saveData(false); 

            if (activeSection === 'fans') renderTable();
            else if (activeSection === 'heartStats') renderHeartData();
            else if (activeSection === 'history') renderHistory();
            
            showToast(`發現 ${groups.length} 筆疑似重複資料`);
        }

        // [新增] 退出篩選模式
        function exitDuplicateMode() {
            isDuplicateMode = false;
            duplicateResults = [];
            document.getElementById('btnDuplicateCheck').classList.remove('hidden');
            document.getElementById('btnDuplicateExit').classList.add('hidden');
            
            // [修正] 立即同步狀態到 localStorage
            saveData(false);

            const sections = ['fans', 'heartStats', 'history'];
            const active = sections.find(s => !document.getElementById(s + 'Section').classList.contains('hidden'));
            
            if (active === 'fans') renderTable();
            else if (active === 'heartStats') renderHeartData();
            else if (active === 'history') renderHistory();
        }

        // 自動為舊資料補上 ID
        heartData = heartData.map(d => ({ ...d, id: d.id || Date.now() + Math.random() }));
        historyData = historyData.map(d => ({ ...d, id: d.id || Date.now() + Math.random() }));




        let activeFanId = null;
        // [修正] 篩選變數改為陣列以支援多選 Checkbox
        let activeDateFilters = []; // 存放: '1', '3', '7', '30', 'over30'
        let activeKeyStatusFilters = []; // 存放: 'inList', 'notInList'

        // 移除 cycleDateFilter 函式，改用 toggleFilter 處理

        let headerLongPressTimer;
        let activeSourceType = 'fan'; // 用於區分來源: 'fan' 或 'heart'
        let currentFilterCol = null;
        let activeSort = { col: 'status', order: 'new' }; // 預設排序
        let activeFilters = { pending: false, oldSent: false, tags: [] };
        let historyStack = [];
        let redoStack = [];
        const MAX_HISTORY = 50;
        let isUndoRedoAction = false;
 
        // 紀錄狀態到歷史 (全面升級：紀錄所有資料表狀態)
        function saveData(recordHistory = true) {
            if (recordHistory) {
                // 建立快照：讀取 LocalStorage 中的「操作前狀態」
                const snapshot = {
                    fans: localStorage.getItem('fans') || '[]',
                    igPosts: localStorage.getItem('igPosts') || '[]',
                    giftPosts: localStorage.getItem('giftPosts') || '[]',
                    heartData: localStorage.getItem('heartData') || '[]',
                    historyData: localStorage.getItem('historyData') || '[]',
                    keyPermissions: localStorage.getItem('keyPermissions') || '{}',
                    // [關鍵修復] 必須將篩選狀態也存入快照，Undo 時才能還原篩選列表
                    isDuplicateMode: localStorage.getItem('isDuplicateMode') || 'false',
                    duplicateResults: localStorage.getItem('duplicateResults') || '[]'
                };
                historyStack.push(snapshot);
                if (historyStack.length > MAX_HISTORY) historyStack.shift();
                redoStack = [];
            }
            // 將「操作後狀態」寫入 LocalStorage
            localStorage.setItem('fans', JSON.stringify(fans));
            localStorage.setItem('igPosts', JSON.stringify(igPosts));
            localStorage.setItem('giftPosts', JSON.stringify(giftPosts));
            localStorage.setItem('heartData', JSON.stringify(heartData));
            localStorage.setItem('historyData', JSON.stringify(historyData));
            localStorage.setItem('keyPermissions', JSON.stringify(keyPermissions));
            // [關鍵修復] 同步寫入篩選狀態
            localStorage.setItem('isDuplicateMode', isDuplicateMode);
            localStorage.setItem('duplicateResults', JSON.stringify(duplicateResults));
        }
 
        function undo() {
            if (historyStack.length === 0) return showToast("沒有可復原的動作");
            isUndoRedoAction = true;
            
            // 復原前，將當前狀態 Snapshot 推入 Redo
            // 使用 JSON.stringify 確保 duplicateResults 是當下狀態的快照 (深層複製)
            const currentSnapshot = {
                fans: JSON.stringify(fans),
                igPosts: JSON.stringify(igPosts),
                giftPosts: JSON.stringify(giftPosts),
                heartData: JSON.stringify(heartData),
                historyData: JSON.stringify(historyData),
                keyPermissions: JSON.stringify(keyPermissions),
                isDuplicateMode: String(isDuplicateMode),
                duplicateResults: JSON.stringify(duplicateResults)
            };
            redoStack.push(currentSnapshot);

            const prevSnapshot = historyStack.pop();
            applySnapshot(prevSnapshot);
            
            showToast("已復原");
            isUndoRedoAction = false;
        }
 
        function redo() {
            if (redoStack.length === 0) return showToast("沒有可重作的動作");
            isUndoRedoAction = true;
            
            // 重作前，將當前狀態 Snapshot 推入 History
            const currentSnapshot = {
                fans: JSON.stringify(fans),
                igPosts: JSON.stringify(igPosts),
                giftPosts: JSON.stringify(giftPosts),
                heartData: JSON.stringify(heartData),
                historyData: JSON.stringify(historyData),
                keyPermissions: JSON.stringify(keyPermissions),
                isDuplicateMode: String(isDuplicateMode),
                duplicateResults: JSON.stringify(duplicateResults)
            };
            historyStack.push(currentSnapshot);

            const nextSnapshot = redoStack.pop();
            applySnapshot(nextSnapshot);

            showToast("已重作");
            isUndoRedoAction = false;
        }


        function applySnapshot(snap) {
            fans = JSON.parse(snap.fans || '[]');
            igPosts = JSON.parse(snap.igPosts || '[]');
            giftPosts = JSON.parse(snap.giftPosts || '[]');
            heartData = JSON.parse(snap.heartData || '[]');
            historyData = JSON.parse(snap.historyData || '[]');
            keyPermissions = JSON.parse(snap.keyPermissions || '{}');

            // [新增] 還原篩選狀態
            isDuplicateMode = (snap.isDuplicateMode === 'true');
            // [關鍵] 這裡會將 snapshot 中的 duplicateResults 還原回變數
            duplicateResults = JSON.parse(snap.duplicateResults || '[]');

            // [新增] 根據還原的模式，更新 Header 按鈕的顯示狀態
            const btnCheck = document.getElementById('btnDuplicateCheck');
            const btnExit = document.getElementById('btnDuplicateExit');
            if (btnCheck && btnExit) {
                if (isDuplicateMode) {
                    btnCheck.classList.add('hidden');
                    btnExit.classList.remove('hidden');
                } else {
                    btnCheck.classList.remove('hidden');
                    btnExit.classList.add('hidden');
                }
            }

            // 將還原後的狀態寫回 LocalStorage (不記歷史)
            saveData(false);
            
            // 重新渲染所有畫面
            renderTable();
            renderIgPosts();
            renderGiftPosts();
            renderHeartData();
            // 確保動態紀錄頁面存在才渲染
            if(document.getElementById('historySection') && !document.getElementById('historySection').classList.contains('hidden')) {
                renderHistory();
            }
        }
 
        function loadProfile() {
            const profile = JSON.parse(localStorage.getItem('userProfile')) || { name: 'Brand Name', avatar: 'https://ui-avatars.com/api/?name=Brand&background=4B0082&color=fff' };
            document.getElementById('userName').value = profile.name;
            document.getElementById('userAvatar').src = profile.avatar;
        }
        function saveProfile() {
            const name = document.getElementById('userName').value;
            const avatar = document.getElementById('userAvatar').src;
            localStorage.setItem('userProfile', JSON.stringify({ name, avatar }));
            showToast('個人品牌設定已儲存');
        }
        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { document.getElementById('userAvatar').src = e.target.result; saveProfile(); };
            reader.readAsDataURL(file);
        }
 
        function validateInput(input) {
            const regex = /^[a-zA-Z0-9._]+$/;
            const errId = input.id + "Err";
            const errEl = document.getElementById(errId);
            if (input.value && !regex.test(input.value)) {
                input.classList.add('input-error');
                if(errEl) errEl.classList.remove('hidden'); return false;
            } else {
                input.classList.remove('input-error');
                if(errEl) errEl.classList.add('hidden'); return true;
            }
        }
 
        function parseDate(str) { if (!str) return 0;
            const d = new Date(str); return isNaN(d.getTime()) ? 0 : d.getTime();
        }
       
        function parseDate2(str) {
            if (!str) return 0;
            const now = new Date();
            const parts = str.split(' ');
            if(parts.length < 2) return 0;
            const [m, d] = parts[0].split('/').map(Number);
            const [h, min] = parts[1].split(':').map(Number);
            const date = new Date(now.getFullYear(), m - 1, d, h, min);
            return date.getTime();
        }
 
        function excelDateToJSDate(serial) {
           var utc_days  = Math.floor(serial - 25569);
           var utc_value = utc_days * 86400;
           var date_info = new Date(utc_value * 1000);
           return date_info.toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'});
        }




         function handleGlobalSearch() {
            const input = document.getElementById('globalSearch');
            const clearBtn = document.getElementById('clearSearchBtn');
            
            if (input.value.length > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }

            // [修正] 加入 keyManageSection 的判斷，讓搜尋框在鑰匙頁面生效
            if (!document.getElementById('fansSection').classList.contains('hidden')) {
                renderTable();
            } else if (!document.getElementById('heartStatsSection').classList.contains('hidden')) {
                renderHeartData();
            } else if (!document.getElementById('historySection').classList.contains('hidden')) {
                renderHistory();
            } else if (!document.getElementById('keyManageSection').classList.contains('hidden')) {
                renderKeyTable(); // 關鍵修正：觸發鑰匙列表渲染
            }
        }


        function clearSearch() {
            const input = document.getElementById('globalSearch');
            input.value = '';
            handleGlobalSearch(); // 觸發重繪與隱藏按鈕
        }




        function renderTable() {
            const tbody = document.getElementById('fanTableBody');
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
            const emptyState = document.getElementById('emptyState');
            tbody.innerHTML = '';
           
            const totalFanCount = fans.filter(f => f.interactions && f.interactions.includes('粉絲')).length;
            const countBadge = document.getElementById('fanCountBadge');
            if(countBadge) countBadge.innerText = `粉絲人數: ${totalFanCount}`;

            // 更新表頭圖示狀態 (Fans)
            const setIcon = (id, condition) => {
                const el = document.getElementById(id);
                if(el) condition ? el.classList.remove('hidden') : el.classList.add('hidden');
            };
            // [修正] 預設排序 (status) 不顯示漏斗，只有在有日期篩選時才顯示
            setIcon('icon_filter_status', activeDateFilters.length > 0);
            setIcon('icon_filter_interactions', activeFilters.tags.length > 0);
            setIcon('icon_filter_sent', activeFilters.pending || activeFilters.oldSent || (activeSort && activeSort.col === 'sent'));
            setIcon('icon_filter_username', activeSort && activeSort.col === 'username');
 
            // [修改] 決定資料來源 (正常 OR 重複篩選)
            let filteredFans = [];
            
            if (isDuplicateMode) {
                // 重複模式：直接使用篩選結果，不套用其他過濾器 (除了搜尋)
                filteredFans = duplicateResults.filter(f => {
                    return (f.username || '').toLowerCase().includes(searchTerm) ||
                           (f.nickname || '').toLowerCase().includes(searchTerm);
                });
            } else {
                // 正常模式：原本的篩選邏輯
                filteredFans = fans.filter(f => {
                    const matchesSearch = (f.username || '').toLowerCase().includes(searchTerm) ||
                                          (f.nickname || '').toLowerCase().includes(searchTerm) ||
                                          (f.interactions || []).join('').toLowerCase().includes(searchTerm) ||
                                          (f.details || '').toLowerCase().includes(searchTerm);
                    if (!matchesSearch) return false;
                    if (activeFilters.pending && f.sent) return false;
    
                    const DAYS_14_MS = 1209600000;
                    if (activeFilters.oldSent) {
                        const isOld = f.sent && f.sentDate && (Date.now() - parseDate2(f.sentDate) > DAYS_14_MS);
                        if (!isOld) return false;
                    }

                    // [修正] 新版日期篩選 (多選 OR 邏輯)
                    if (activeDateFilters.length > 0) {
                        if (!f.latestDate) return false;
                        const d = parseDate(f.latestDate);
                        const diffDays = (Date.now() - d) / 86400000;
                        
                        // 只要符合任一選中條件即可
                        const matchDate = activeDateFilters.some(filter => {
                            if (filter === 'over30') return diffDays > 30;
                            if (filter === 'over7') return diffDays > 7;
                            return diffDays <= parseInt(filter);
                        });
                        if (!matchDate) return false;
                    }
    
                    if (activeFilters.tags.length > 0) {
                        const matchAll = activeFilters.tags.every(tag => {
                            if (tag === '非粉絲') return !f.interactions.includes('粉絲');
                            return f.interactions.includes(tag);
                        });
                        if (!matchAll) return false;
                    }
                    return true;
                });

                if (filteredFans.length > 0) {
                    const sorter = (a, b) => {
                        if (activeSort) {
                            const { col, order } = activeSort;
                            if (col === 'username') return order === 'az' ? a.username.localeCompare(b.username) : b.username.localeCompare(a.username);
                            if (col === 'status') {
                                const dateA = parseDate(a.latestDate);
                                const dateB = parseDate(b.latestDate);
                                return order === 'new' ? dateB - dateA : dateA - dateB;
                            }
                            if (col === 'sent') {
                                const getSentValue = (fan) => {
                                    if (!fan.sent) return 9999999999999;
                                    return fan.sentDate ? parseDate2(fan.sentDate) : 0;
                                };
                                const valA = getSentValue(a);
                                const valB = getSentValue(b);
                                return order === 'date_new' ? valB - valA : valA - valB;
                            }
                        }
                        return a.username.toLowerCase().localeCompare(b.username.toLowerCase());
                    };
                    const starredFans = filteredFans.filter(f => f.isCloseFriend);
                    const otherFans = filteredFans.filter(f => !f.isCloseFriend);
                    starredFans.sort(sorter); otherFans.sort(sorter);
                    filteredFans = [...starredFans, ...otherFans];
                }
            }
           
            if (filteredFans.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                const DAYS_14 = 1209600000; // 14 days in ms

                // [新增] 用於切換重複群組顏色的變數
                let lastGroupId = -1;
                let useGroupColorA = true;
 
                filteredFans.forEach(fan => {
                    const row = document.createElement('tr'); row.className = 'table-row';
                    
                    // [新增] 套用重複群組樣式
                    if (isDuplicateMode && fan.dupGroupId !== undefined) {
                        if (fan.dupGroupId !== lastGroupId) {
                            useGroupColorA = !useGroupColorA; // 切換顏色
                            lastGroupId = fan.dupGroupId;
                        }
                        row.classList.add(useGroupColorA ? 'duplicate-group-a' : 'duplicate-group-b');
                    }
                    
                    // [修正邏輯] 跨表比對：找出該粉絲在所有紀錄中「最新」的發送狀態
                    let finalSent = fan.sent;
                    let finalSentDate = fan.sentDate;
                    let finalTimestamp = parseDate2(fan.sentDate);


                    // 掃描 HeartData 中是否有該粉絲的已發送紀錄，並比對時間
                    const userHearts = heartData.filter(h => h.username === fan.username);
                    userHearts.forEach(h => {
                        if (h.sent) {
                            finalSent = true; // 只要有任何一筆是 Sent，就視為已發送
                            const hTime = parseDate2(h.sentDate);
                            if (hTime > finalTimestamp) {
                                finalTimestamp = hTime;
                                finalSentDate = h.sentDate; // 更新為最新的日期
                            }
                        }
                    });


                    // 使用計算後的 finalSentDate 進行判斷
                    const isOldSent = finalSentDate && (Date.now() - parseDate2(finalSentDate)) > DAYS_14;
                    const sentStyle = isOldSent ? 'text-[#4B0082] border-[#4B0082]/30' : 'text-green-400 border-green-400/30';
                    const statusHtml = finalSent
                        ? `<div class="flex flex-col"><span class="${sentStyle} text-xs font-bold border px-2 py-0.5 rounded w-fit">✓ 已發送</span><span class="text-[10px] text-gray-500 mt-1">${finalSentDate || ''}</span></div>`
                        : `<span class="text-amber-500 text-xs font-bold border border-amber-500/30 px-2 py-0.5 rounded w-fit">● 待處理</span>`;
                    
                    const isOldActivity = (Date.now() - parseDate(fan.latestDate)) > DAYS_14;
                    const actColor = isOldActivity ? 'text-[#4B0082]' : 'text-white';
                    const latestInfo = (fan.latestDate || fan.latestType) ? `<div class="flex flex-col"><span class="${actColor} font-bold text-xs">${fan.latestType ||
                        '無'}</span><span class="text-[10px] text-gray-500">${fan.latestDate || '未知日期'}</span></div>` : `<span class="text-gray-600 text-xs">-</span>`;
                    
                    const isValidAccount = /^[a-zA-Z0-9._]+$/.test(fan.username);
                    const nameClass = isValidAccount ?
                        "text-indigo-300 hover:text-indigo-100 hover:underline" : "text-red-800 font-bold hover:text-red-600 hover:underline";
                    
                    const langBadge = `<span class="ml-2 inline-flex items-center justify-center w-5 h-5 bg-[#4B0082] text-[#D8BFD8] text-[10px] font-bold rounded-[2px]">${fan.language ||
                        '中'}</span>`;
                    const accountLink = `<span class="${nameClass} cursor-pointer select-none" onmousedown="startFanLongPress(event, '${fan.username}')" onmouseup="cancelFanLongPress(this, '${fan.username}')" ontouchstart="startFanLongPress(event, '${fan.username}')" ontouchend="cancelFanLongPress(this, '${fan.username}')">@${fan.username}</span>${langBadge}`;
                    
                    const tagsHtml = fan.interactions.map(tag => {
                        let style = 'bg-white/5 text-gray-300 border-white/10'; 
                        if (tag === '粉絲') style = 'bg-pink-900/40 text-pink-200 border-pink-500/30';
                        else if (tag === '前帳粉') style = 'bg-[#763BE3]/20 text-[#763BE3] border-[#763BE3]/30';
                        else if (tag === '高互動') style = 'bg-amber-900/20 text-amber-500 border-amber-500/30';
                        else if (tag === 'Thread粉') style = 'thread-badge';
                        else if (tag === 'DM') style = 'bg-indigo-900/40 text-indigo-200 border-indigo-500/30';
                        return `<span class="px-2 py-0.5 rounded text-xs border whitespace-nowrap ${style}">${tag}</span>`;
                    }).join('');
                    
                    const starClass = fan.isCloseFriend ? 'star-active' : 'star-inactive';
                    row.innerHTML = `
                        <td class="text-center sticky-col-1"><i class="fas fa-star ${starClass} star-btn" onclick="toggleStar(${fan.id})"></i></td>
                        <td class="font-medium sticky-col-2">${accountLink}</td>
                        <td class="text-gray-300 text-xs">${fan.nickname || '-'}</td>
                        <td class="bg-indigo-900/10 border-l border-r border-indigo-900/30">${latestInfo}</td>
                        <td><div class="flex flex-wrap gap-1">${tagsHtml}</div></td>
                        <td><div class="text-xs text-gray-400 line-clamp-2 hover:line-clamp-none transition-all cursor-help" title="${fan.details}">${fan.details.split('/').map(d => `<span class="block border-b border-dashed border-white/10 pb-0.5 mb-0.5 last:border-0">${d.trim()}</span>`).join('')}</div></td>
                        <td>${statusHtml}</td>
                        <td class="text-center sticky-col-last">
                            <div class="flex justify-center gap-1">
                                <button 
                                    onmousedown="startMsgBtnPress(event, '${fan.username}', ${fan.id})" 
                                    ontouchstart="startMsgBtnPress(event, '${fan.username}', ${fan.id})" 
                                    onmouseup="endMsgBtnPress(event, ${fan.id})" 
                                    ontouchend="endMsgBtnPress(event, ${fan.id})" 
                                    class="group btn-indigo px-2 py-1.5 rounded text-xs text-white font-bold select-none" 
                                    title="點擊:發送訊息 / 長按:開啟Threads">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                                <button onclick="openEditFanModal(${fan.id})" class="bg-gray-700 hover:bg-gray-600 text-white px-2 py-1.5 rounded text-xs transition-colors" title="編輯資料"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteFan(${fan.id})" class="bg-red-900/30 hover:bg-red-600 text-red-400 hover:text-white px-2 py-1.5 rounded text-xs transition-colors" title="刪除"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>`;
                    tbody.appendChild(row);
                });
            }
        }
 
        // --- New Render Functions ---
        function renderIgPosts() {
            const tbody = document.getElementById('igPostTableBody');
            tbody.innerHTML = igPosts.map((p, idx) => `
                <tr class="table-row">
                    <td class="font-bold text-pink-200">${p.topic}</td>
                    <td class="text-gray-500 text-xs">${p.isPlanned ? '<span class="text-yellow-400 font-bold border border-yellow-400/30 px-2 py-0.5 rounded text-[10px]">規劃中</span>' : (p.date || '-')}</td>
                    <td class="text-gray-400 text-xs whitespace-pre-wrap">${p.content}</td>
                    <td class="text-gray-400 text-xs whitespace-pre-wrap">${p.fileName}</td>
                    <td class="text-blue-300 text-xs">${p.hashtag}</td>
                    <td class="text-center">
                        <button onclick="openEditIgPostModal(${idx})" class="bg-gray-700 hover:bg-gray-600 text-white px-2 py-1.5 rounded text-xs transition-colors mr-2"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteIgPost(${idx})" class="bg-red-900/30 hover:bg-red-600 text-red-400 hover:text-white px-2 py-1.5 rounded text-xs transition-colors"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
            `).join('');
        }
 
        function renderGiftPosts() {
            const tbody = document.getElementById('giftPostTableBody');
            tbody.innerHTML = giftPosts.map((p, idx) => `
                <tr class="table-row">
                    <td class="font-bold text-purple-200">${p.giftId}</td>
                    <td class="text-gray-400 text-xs">${p.isPlanned ? '<span class="text-yellow-400 font-bold border border-yellow-400/30 px-2 py-0.5 rounded text-[10px]">規劃中</span>' : (p.date || '-')}</td>
                    <td class="text-gray-400 text-xs whitespace-pre-wrap">${p.fileName}</td>
                    <td class="text-gray-300 text-xs whitespace-pre-wrap">${p.desc}</td>
                    <td class="text-center">
                        <button onclick="openEditGiftPostModal(${idx})" class="bg-gray-700 hover:bg-gray-600 text-white px-2 py-1.5 rounded text-xs transition-colors mr-2"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteGiftPost(${idx})" class="bg-red-900/30 hover:bg-red-600 text-red-400 hover:text-white px-2 py-1.5 rounded text-xs transition-colors"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
            `).join('');
        }
 
        
        // [新增] 輔助函式：確保取得最新暱稱
        function getFanNickname(username) {
            const fan = fans.find(f => f.username.toLowerCase() === username.toLowerCase());
            return fan ? (fan.nickname || '-') : '-';
        }

        function renderHeartData() {
            const tbody = document.getElementById('heartTableBody');
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
            const DAYS_14 = 1209600000; // 14 days

            // [修改] 決定資料來源
            let displayData = isDuplicateMode ? [...duplicateResults] : [...heartData];
            
            if (searchTerm) {
                displayData = displayData.filter(d => 
                    (d.username || '').toLowerCase().includes(searchTerm) ||
                    (d.nickname || '').toLowerCase().includes(searchTerm) ||
                    (d.content || '').toLowerCase().includes(searchTerm) ||
                    (d.responseItem || '').toLowerCase().includes(searchTerm)
                );
            }

            // [修改] 重複模式下不以時間排序，而是維持群組排序 (dupGroupId)
            if (!isDuplicateMode) {
                displayData.sort((a, b) => parseDate(b.date) - parseDate(a.date));
            }

            // [新增] 用於切換重複群組顏色的變數
            let lastGroupId = -1;
            let useGroupColorA = true;
            
            tbody.innerHTML = displayData.map((d) => {
                // [新增] 套用重複群組樣式Class
                let rowClass = 'table-row';
                if (isDuplicateMode && d.dupGroupId !== undefined) {
                    if (d.dupGroupId !== lastGroupId) {
                        useGroupColorA = !useGroupColorA;
                        lastGroupId = d.dupGroupId;
                    }
                    rowClass += useGroupColorA ? ' duplicate-group-a' : ' duplicate-group-b';
                }

                // --- [關鍵修正] 讀取時強制同步狀態 ---
                const targetUser = (d.username || '').trim().toLowerCase();
                
                // [新增] 強制取得最新暱稱 (取代原本的 d.nickname)
                const currentNick = getFanNickname(d.username);

                // 1. 預設使用該筆紀錄的狀態
                let finalSent = d.sent;
                let finalSentDate = d.sentDate;
                let maxTimestamp = parseDate2(d.sentDate);

                // 2. 檢查 [粉絲管理列表] 主檔 (Master) 是否已發送且時間更新
                const masterFan = fans.find(f => f.username.trim().toLowerCase() === targetUser);
                if (masterFan && masterFan.sent) {
                    const fanTime = parseDate2(masterFan.sentDate);
                    // 如果主檔有發送，且 (目前沒發送 OR 主檔時間比較新)，就採用主檔狀態
                    if (!finalSent || fanTime > maxTimestamp) {
                        finalSent = true;
                        finalSentDate = masterFan.sentDate;
                        maxTimestamp = fanTime;
                    }
                }

                // 3. 檢查 [其他暖心紀錄] 是否有更新的發送時間 (Siblings)
                heartData.forEach(h => {
                    if (h.username.trim().toLowerCase() === targetUser && h.sent) {
                        const hTime = parseDate2(h.sentDate);
                        if (hTime > maxTimestamp) {
                            finalSent = true;
                            finalSentDate = h.sentDate;
                            maxTimestamp = hTime;
                        }
                    }
                });
                // ------------------------------------

                const isOldSent = finalSentDate && (Date.now() - parseDate2(finalSentDate)) > DAYS_14;
                const sentStyle = isOldSent ? 'text-[#4B0082] border-[#4B0082]/30' : 'text-green-400 border-green-400/30';
                
                // 使用計算後的 finalSent 與 finalSentDate 顯示
                const statusHtml = finalSent
                    ? `<div class="flex flex-col"><span class="${sentStyle} text-xs font-bold border px-2 py-0.5 rounded w-fit">✓ 已發送</span><span class="text-[10px] text-gray-500 mt-1">${finalSentDate || ''}</span></div>`
                    : `<span class="text-amber-500 text-xs font-bold border border-amber-500/30 px-2 py-0.5 rounded w-fit">● 待處理</span>`;

                // 新增：根據模式決定是否顯示 checkbox
                const checkHtml = (typeof isHeartKeyMode !== 'undefined' && isHeartKeyMode) ? 
                    `<td class="text-center"><input type="checkbox" value="${d.username}" class="heart-key-checkbox accent-emerald-500 w-4 h-4"></td>` : 
                    '';

                return `
                <tr class="${rowClass}">
                    ${checkHtml}
                    <td class="font-bold">
                        <span class="text-indigo-300 cursor-pointer hover:text-indigo-100 hover:underline select-none" 
                              onmousedown="startFanLongPress(event, '${d.username}')" 
                              onmouseup="cancelFanLongPress(this, '${d.username}')" 
                              ontouchstart="startFanLongPress(event, '${d.username}')" 
                              ontouchend="cancelFanLongPress(this, '${d.username}')">
                            @${d.username}
                        </span>
                    </td>
                    <td class="text-gray-400">${currentNick}</td>
                    <td class="text-gray-400 text-xs">${d.date}</td>
                    <td class="text-pink-300 text-xs border border-pink-900/50 bg-pink-900/20 px-2 rounded w-fit">${d.responseItem || '-'}</td>
                    <td class="text-gray-300 text-xs whitespace-pre-wrap">${d.content}</td>
                    <td>${statusHtml}</td>
                    <td class="text-center">
                        <div class="flex items-center justify-center gap-1">
                            <button 
                                 onmousedown="startMsgBtnPress(event, '${d.username}', ${d.id}, 'heart')" 
                                 ontouchstart="startMsgBtnPress(event, '${d.username}', ${d.id}, 'heart')" 
                                 onmouseup="endMsgBtnPress(event, ${d.id})" 
                                 ontouchend="endMsgBtnPress(event, ${d.id})" 
                                 class="group btn-indigo px-2 py-1.5 rounded text-xs text-white font-bold select-none" 
                                 title="點擊:發送訊息 / 長按:開啟Threads">
                                 <i class="fas fa-paper-plane"></i>
                            </button>
                            <button onclick="openEditHeartModal(${d.id})" class="bg-gray-700 hover:bg-gray-600 text-white px-2 py-1.5 rounded text-xs transition-colors" title="編輯"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteHeartData(${d.id})" class="bg-red-900/30 hover:bg-red-600 text-red-400 hover:text-white px-2 py-1.5 rounded text-xs transition-colors" title="刪除"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
            
            // 更新計數 (若有此元素)
            const countEl = document.getElementById('heartCount');
            if(countEl) countEl.innerText = displayData.length;
        }
 
        // --- Add/Delete/Edit Logic ---
 
        function openEditIgPostModal(idx) {
            const p = igPosts[idx];
            document.getElementById('editIgIndex').value = idx;
            document.getElementById('editIgTopic').value = p.topic;
            document.getElementById('editIgDate').value = p.date || '';
            document.getElementById('editIgIsPlanned').checked = p.isPlanned || false;
            document.getElementById('editIgFile').value = p.fileName;
            document.getElementById('editIgContent').value = p.content;
            document.getElementById('editIgHash').value = p.hashtag;
            document.getElementById('editIgModal').classList.remove('hidden');
        }
        function saveIgPostEdit() {
            const idx = document.getElementById('editIgIndex').value;
            igPosts[idx] = {
                topic: document.getElementById('editIgTopic').value,
                date: document.getElementById('editIgDate').value,
                isPlanned: document.getElementById('editIgIsPlanned').checked,
                fileName: document.getElementById('editIgFile').value,
                content: document.getElementById('editIgContent').value,
                hashtag: document.getElementById('editIgHash').value
            };
            localStorage.setItem('igPosts', JSON.stringify(igPosts));
            renderIgPosts();
            updateResponseOptions();
            document.getElementById('editIgModal').classList.add('hidden');
        }
 
        function addIgPost() {
            const topic = document.getElementById('igTopic').value.trim();
            const content = document.getElementById('igContent').value.trim();
            const fileName = document.getElementById('igFile').value.trim();
            const hashtag = document.getElementById('igHash').value.trim();
            const dateStr = `${document.getElementById('igDateYYYY').value}/${document.getElementById('igDateMM').value}/${document.getElementById('igDateDD').value}`;
            const isPlanned = document.getElementById('igIsPlanned').checked;
           
            if(!topic) return alert("請輸入主題");
            igPosts.push({ topic, content, fileName, hashtag, date: dateStr, isPlanned });
            localStorage.setItem('igPosts', JSON.stringify(igPosts));
            renderIgPosts();
           
            document.getElementById('igTopic').value = '';
            document.getElementById('igIsPlanned').checked = false; // 重置勾選框
            document.getElementById('igContent').value = '';
            document.getElementById('igFile').value = '';
            document.getElementById('igHash').value = '';
            showToast('IG 貼文已新增');
            updateResponseOptions();
        }
        function deleteIgPost(idx) {
            if(confirm("確定刪除?")) {
                igPosts.splice(idx, 1);
                localStorage.setItem('igPosts', JSON.stringify(igPosts));
                renderIgPosts();
                updateResponseOptions();
            }
        }
 
        function openEditGiftPostModal(idx) {
            const p = giftPosts[idx];
            document.getElementById('editGiftIndex').value = idx;
            document.getElementById('editGiftId').value = p.giftId;
            document.getElementById('editGiftDate').value = p.date;
            document.getElementById('editGiftIsPlanned').checked = p.isPlanned || false;
            document.getElementById('editGiftFile').value = p.fileName;
            document.getElementById('editGiftDesc').value = p.desc;
            document.getElementById('editGiftModal').classList.remove('hidden');
        }
        function saveGiftPostEdit() {
            const idx = document.getElementById('editGiftIndex').value;
            giftPosts[idx] = {
                giftId: document.getElementById('editGiftId').value,
                date: document.getElementById('editGiftDate').value,
                isPlanned: document.getElementById('editGiftIsPlanned').checked,
                fileName: document.getElementById('editGiftFile').value,
                desc: document.getElementById('editGiftDesc').value
            };
            localStorage.setItem('giftPosts', JSON.stringify(giftPosts));
            renderGiftPosts();
            updateResponseOptions();
            document.getElementById('editGiftModal').classList.add('hidden');
        }
 
        function addGiftPost() {
            const giftId = document.getElementById('giftId').value.trim();
            const fileName = document.getElementById('giftFile').value.trim();
            const desc = document.getElementById('giftDesc').value.trim();
            const dateStr = `${document.getElementById('giftDateYYYY').value}/${document.getElementById('giftDateMM').value}/${document.getElementById('giftDateDD').value}`;
            const isPlanned = document.getElementById('giftIsPlanned').checked;
           
            if(!giftId) return alert("請輸入禮物 ID");
            giftPosts.push({ giftId, date: dateStr, fileName, desc, isPlanned });
            localStorage.setItem('giftPosts', JSON.stringify(giftPosts));
            renderGiftPosts();
           
            document.getElementById('giftId').value = '';
            document.getElementById('giftIsPlanned').checked = false; // 重置
            document.getElementById('giftFile').value = '';
            document.getElementById('giftDesc').value = '';
            showToast('禮物貼文已新增');
            updateResponseOptions();
        }
        function deleteGiftPost(idx) {
            if(confirm("確定刪除?")) {
                giftPosts.splice(idx, 1);
                localStorage.setItem('giftPosts', JSON.stringify(giftPosts));
                renderGiftPosts();
                updateResponseOptions();
            }
        }
 
        function switchManualTab(tab) {
            const stdForm = document.getElementById('manualStandardForm');
            const heartForm = document.getElementById('manualHeartForm');
            const btnStd = document.getElementById('tabBtnStd');
            const btnHeart = document.getElementById('tabBtnHeart');
            if (tab === 'standard') {
                stdForm.classList.remove('hidden');
                heartForm.classList.add('hidden');
                btnStd.className = "flex-1 py-4 text-center font-bold text-indigo-400 border-b-2 border-indigo-500 bg-[#1a1a1a]";
                btnHeart.className = "flex-1 py-4 text-center font-bold text-gray-500 hover:text-red-400 hover:bg-[#2a1a1a] transition-all";
            } else {
                stdForm.classList.add('hidden');
                heartForm.classList.remove('hidden');
                btnStd.className = "flex-1 py-4 text-center font-bold text-gray-500 hover:text-indigo-400 hover:bg-[#2a1a1a] transition-all";
                btnHeart.className = "flex-1 py-4 text-center font-bold text-red-400 border-b-2 border-red-500 bg-[#1a1a1a]";
                updateResponseOptions();
            }
        }
 
        function autoFillHeartNickname() {
            const user = document.getElementById('heartUser').value.trim();
            const fan = fans.find(f => f.username === user);
            if(fan) document.getElementById('heartNick').value = fan.nickname || '';
        }




        // 新增：手動紀錄自動帶入暱稱
        function autoFillManualNickname() {
            const user = document.getElementById('manualUsername').value.trim();
            const fan = fans.find(f => f.username === user);
            if(fan && fan.nickname) document.getElementById('manualNickname').value = fan.nickname;
        }
 
        function updateResponseOptions() {
            const select = document.getElementById('heartResponseItem');
            const editSelect = document.getElementById('editHeartItem');
            const editGroupIg = document.getElementById('editHeartItemIg');
            const editGroupGift = document.getElementById('editHeartItemGift');
            
            // Basic options [修正文字] - 加入預設空白選項
            select.innerHTML = '<option value="">-- 請選擇 --</option><option value="DM">DM私訊內容</option>';
            editGroupIg.innerHTML = '';
            editGroupGift.innerHTML = '';
           
            if(igPosts.length > 0) {
                const group = document.createElement('optgroup');
                group.label = "IG 貼文留言";
                igPosts.forEach(p => {
                    const opt = `<option value="貼文: ${p.topic}">${p.topic}</option>`;
                    group.innerHTML += opt;
                    editGroupIg.innerHTML += opt;
                });
                select.appendChild(group);
            }
            if(giftPosts.length > 0) {
                const group = document.createElement('optgroup');
                group.label = "禮物 ID";
                giftPosts.forEach(g => {
                    const opt = `<option value="禮物: ${g.giftId}">${g.giftId}</option>`;
                    group.innerHTML += opt;
                    editGroupGift.innerHTML += opt;
                });
                select.appendChild(group);
            }
        }
 
        function startHeaderLongPress(e, key) {
            if(e.button !== 0 && e.type !== 'touchstart') return;
            if(!['username', 'status', 'sent', 'interactions'].includes(key)) return;
            headerLongPressTimer = setTimeout(() => { openFilterMenu(e, key); }, 600);
        }
        function cancelHeaderLongPress() { clearTimeout(headerLongPressTimer); }
 
        function openFilterMenu(e, key) {
            const menu = document.getElementById('filterMenu');
            currentFilterCol = key;
            const container = document.getElementById('filterContentContainer');
            container.innerHTML = '';
            
            // 判斷當前是否在鑰匙管理頁面
            const isKeyPage = !document.getElementById('keyManageSection').classList.contains('hidden');

            if (key === 'username') {
                if (isKeyPage) {
                    // 鑰匙管理模式：顯示「未加入/已加入」篩選
                    container.innerHTML = `<div class="text-xs text-emerald-400 mb-2 font-bold">名單狀態篩選：</div>`;
                    const opts = [
                        { val: 'notInList', txt: '未加入名單' },
                        { val: 'inList', txt: '已加入名單' }
                    ];
                    opts.forEach(o => {
                        const checked = activeKeyStatusFilters.includes(o.val) ? 'checked' : '';
                        container.innerHTML += `<label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer hover:bg-white/5 p-1 rounded"><input type="checkbox" value="${o.val}" ${checked} onchange="toggleFilter('keyStatus', this.value)" class="accent-emerald-500"> ${o.txt}</label>`;
                    });
                } else {
                    // 粉絲管理模式：顯示排序
                    container.innerHTML = `<label class="text-xs text-gray-400 block mb-2">排序方式：</label><select id="filterSortSelect" onchange="applySort(this.value)" class="bg-black/40 border border-gray-600 text-gray-300 text-xs rounded w-full p-2 focus:border-indigo-500 outline-none"></select>`;
                    const sortSelect = document.getElementById('filterSortSelect');
                    sortSelect.innerHTML = '<option value="">(預設)</option>';
                    const opts = [{val:'az', txt:'字母順序 (A-Z)'}, {val:'za', txt:'字母順序 (Z-A)'}];
                    opts.forEach(o => {
                        const selected = (activeSort && activeSort.col === key && activeSort.order === o.val) ? 'selected' : '';
                        sortSelect.innerHTML += `<option value="${o.val}" ${selected}>${o.txt}</option>`;
                    });
                }
            } else if (key === 'status') {
                // 通用：排序 + 日期篩選
                container.innerHTML = `<label class="text-xs text-gray-400 block mb-2">排序方式：</label><select id="filterSortSelect" onchange="applySort(this.value)" class="bg-black/40 border border-gray-600 text-gray-300 text-xs rounded w-full p-2 focus:border-indigo-500 outline-none"></select>`;
                const sortSelect = document.getElementById('filterSortSelect');
                sortSelect.innerHTML = '<option value="">(預設)</option>';
                const sOpts = [{val:'new', txt:'活動日期 (新-舊)'}, {val:'old', txt:'活動日期 (舊-新)'}];
                sOpts.forEach(o => {
                    const selected = (activeSort && activeSort.col === key && activeSort.order === o.val) ? 'selected' : '';
                    sortSelect.innerHTML += `<option value="${o.val}" ${selected}>${o.txt}</option>`;
                });

                // 新版日期篩選 (Checkbox)
                // 新版日期篩選 (Checkbox)
                container.innerHTML += `<div class="mt-3 border-t border-white/10 pt-2"><label class="text-xs text-gray-400 block mb-1">日期篩選 (多選/OR)：</label></div>`;
                const dateOpts = [
                    { val: '1', txt: '最近 1 天' },
                    { val: '3', txt: '最近 3 天' },
                    { val: '7', txt: '最近 7 天' },
                    { val: 'over7', txt: '超過 7 天' },
                    { val: 'over30', txt: '超過 30 天' }
                ];
                dateOpts.forEach(d => {
                    const checked = activeDateFilters.includes(d.val) ? 'checked' : '';
                    container.innerHTML += `<label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer hover:bg-white/5 p-1 rounded"><input type="checkbox" value="${d.val}" ${checked} onchange="toggleFilter('date', this.value)" class="accent-indigo-500"> ${d.txt}</label>`;
                });

            } else if (key === 'interactions') {
                container.innerHTML = `<div class="text-xs text-gray-400 mb-2 font-bold">篩選標籤 (需同時滿足/AND)：</div>`;
                ['粉絲', '非粉絲', '前帳粉', 'Thread粉', '高互動', '留言', '轉發', '分享', 'DM'].forEach(tag => {
                    const checked = activeFilters.tags.includes(tag) ? 'checked' : '';
                    let colorClass = "text-gray-300";
                    if(tag==='粉絲') colorClass = "text-pink-200";
                    if(tag==='前帳粉') colorClass = "text-[#763BE3]";
                    if(tag==='Thread粉') colorClass = "text-white";
                    if(tag==='高互動') colorClass = "text-amber-400";
                    if(tag==='DM') colorClass = "text-indigo-300";
                    
                    container.innerHTML += `<label class="flex items-center gap-2 text-sm ${colorClass} cursor-pointer hover:bg-white/5 p-1 rounded"><input type="checkbox" value="${tag}" ${checked} onchange="toggleFilter('tag', this.value)" class="accent-indigo-500"> ${tag}</label>`;
                });
            } else if (key === 'sent') {
                const pendingChecked = activeFilters.pending ? 'checked' : '';
                const oldSentChecked = activeFilters.oldSent ? 'checked' : '';
                let html = `<label class="flex items-center gap-2 text-sm text-amber-400 font-bold cursor-pointer mb-2"><input type="checkbox" ${pendingChecked} onchange="toggleFilter('pending')" class="accent-amber-500"> 顯示「待處理」</label>`;
                html += `<label class="flex items-center gap-2 text-sm text-[#4B0082] font-bold cursor-pointer border-b border-white/10 pb-2 mb-2"><input type="checkbox" ${oldSentChecked} onchange="toggleFilter('oldSent')" class="accent-indigo-900"> 超過14天</label>`;
                html += `<label class="text-xs text-gray-400 block mb-2">排序方式：</label><select onchange="applySort(this.value)" class="bg-black/40 border border-gray-600 text-gray-300 text-xs rounded w-full p-2 focus:border-indigo-500 outline-none"><option value="">(預設)</option>`;
                const opts = [{val: 'date_new', txt: '發送日期 (新-舊)'}, {val: 'date_old', txt: '發送日期 (舊-新)'}];
                opts.forEach(o => {
                    const selected = (activeSort && activeSort.col === key && activeSort.order === o.val) ? 'selected' : '';
                    html += `<option value="${o.val}" ${selected}>${o.txt}</option>`;
                });
                html += `</select>`;
                container.innerHTML = html;
            }
            const posX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const posY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
            menu.style.left = Math.min(posX, window.innerWidth - 270) + 'px';
            menu.style.top = Math.min(posY, window.innerHeight - 200) + 'px';
            menu.classList.remove('hidden'); menu.classList.add('flex');
        }
 
        function toggleFilter(type, value) {
            if (type === 'pending') { activeFilters.pending = !activeFilters.pending; }
            else if (type === 'oldSent') { activeFilters.oldSent = !activeFilters.oldSent; }
            else if (type === 'tag') {
                if (activeFilters.tags.includes(value)) activeFilters.tags = activeFilters.tags.filter(t => t !== value);
                else activeFilters.tags.push(value);
            }
            else if (type === 'date') {
                if (activeDateFilters.includes(value)) activeDateFilters = activeDateFilters.filter(v => v !== value);
                else activeDateFilters.push(value);
            }
            else if (type === 'keyStatus') {
                if (activeKeyStatusFilters.includes(value)) activeKeyStatusFilters = activeKeyStatusFilters.filter(v => v !== value);
                else activeKeyStatusFilters.push(value);
            }

            // 判斷要刷新哪個表格
            if (!document.getElementById('fansSection').classList.contains('hidden')) renderTable();
            if (!document.getElementById('keyManageSection').classList.contains('hidden')) renderKeyTable();
        }
 
        function closeFilterMenu() { document.getElementById('filterMenu').classList.add('hidden'); document.getElementById('filterMenu').classList.remove('flex'); currentFilterCol = null; }
        function applySort(order) { activeSort = order ? { col: currentFilterCol, order: order } : null; renderTable(); }
 
        function addHeartData() {
            const username = document.getElementById('heartUser').value.trim();
            const nickname = document.getElementById('heartNick').value.trim();
            const responseItem = document.getElementById('heartResponseItem').value;
            const content = document.getElementById('heartContent').value.trim();
            const dateStr = `${document.getElementById('heartDateYYYY').value}/${document.getElementById('heartDateMM').value}/${document.getElementById('heartDateDD').value}`;
           
            if(!username) return alert("請輸入粉絲帳號");
            heartData.push({ username, nickname, responseItem, content, date: dateStr });
            localStorage.setItem('heartData', JSON.stringify(heartData));
            renderHeartData();
            document.getElementById('heartUser').value = '';
            document.getElementById('heartNick').value = '';
            document.getElementById('heartContent').value = '';
            showToast('暖心紀錄已儲存');
        }
 
        function openEditHeartModal(idx) {
            const d = heartData[idx];
            document.getElementById('editHeartIndex').value = idx;
            document.getElementById('editHeartUser').value = d.username;
            document.getElementById('editHeartNick').value = d.nickname;
            document.getElementById('editHeartDate').value = d.date;
            document.getElementById('editHeartItem').value = d.responseItem;
            document.getElementById('editHeartContent').value = d.content;
            document.getElementById('editHeartModal').classList.remove('hidden');
        }
        function saveHeartEdit() {
            const idx = document.getElementById('editHeartIndex').value;
            heartData[idx] = {
                username: document.getElementById('editHeartUser').value,
                nickname: document.getElementById('editHeartNick').value,
                date: document.getElementById('editHeartDate').value,
                responseItem: document.getElementById('editHeartItem').value,
                content: document.getElementById('editHeartContent').value
            };
            localStorage.setItem('heartData', JSON.stringify(heartData));
            renderHeartData();
            document.getElementById('editHeartModal').classList.add('hidden');
        }
 
        function deleteHeartData(idx) {
            if(confirm("確定刪除?")) {
                heartData.splice(idx, 1);
                localStorage.setItem('heartData', JSON.stringify(heartData));
                renderHeartData();
            }
        }
 
        let fanLongPressTimer;
        let isLongPress = false;
 
        function startFanLongPress(e, username) {
            if(e.button !== 0 && e.type !== 'touchstart') return;
            isLongPress = false;
            fanLongPressTimer = setTimeout(() => {
                isLongPress = true;
                window.open(`https://www.threads.net/@${username}`, '_blank');
                if(navigator.vibrate) navigator.vibrate(50); // Optional feedback
            }, 600);
        }
 
        function cancelFanLongPress(element, username) {
            clearTimeout(fanLongPressTimer);
if (!isLongPress) {
                window.open(`https://www.instagram.com/${username}`, '_blank');
element.classList.remove('text-indigo-300', 'hover:text-indigo-100');
                element.classList.add('visited-link');
            }
        }


        // [新增] 訊息按鈕專用邏輯 (短按Modal / 長按Threads)
        let msgBtnTimer;
        let isMsgBtnLong = false;
        let currentMsgPlatform = 'ig'; // 新增：追蹤目前要發送的平台


        function startMsgBtnPress(e, username, id, type = 'fan') {
            // 只接受左鍵(0)或觸控
            if(e.button !== 0 && e.type !== 'touchstart') return;
            activeSourceType = type; // 設定操作來源
            isMsgBtnLong = false;
            msgBtnTimer = setTimeout(() => {
                isMsgBtnLong = true;
                if(navigator.vibrate) navigator.vibrate(50);
                // 長按：設定為 Threads 模式並開啟 Modal
                currentMsgPlatform = 'threads';
                openModal(id); 
   
             }, 600);
        }


        function endMsgBtnPress(e, id) {
            clearTimeout(msgBtnTimer);
            // 如果不是長按，代表是點擊，執行原本的開啟視窗 (IG模式)
            if (!isMsgBtnLong) {
                currentMsgPlatform = 'ig';
                openModal(id);
            }
            isMsgBtnLong = false;
            // 阻止預設行為避免重複觸發
            // if(e.cancelable && e.type !== 'mouseup') e.preventDefault();
        }
 
        function toggleStar(id) { const fan = fans.find(f => f.id === id);
            if(fan) { fan.isCloseFriend = !fan.isCloseFriend; saveData(); renderTable(); } }
       
        function initDateInput() {
            const today = new Date();
            const setup = (prefix) => {
                const els = [
                    { id: prefix + 'YYYY', val: today.getFullYear(), max: 4 },
                    { id: prefix + 'MM', val: String(today.getMonth()+1).padStart(2,'0'), max: 2 },
                    { id: prefix + 'DD', val: String(today.getDate()).padStart(2,'0'), max: 2 }
                ];
                els.forEach((c, i) => {
                    const el = document.getElementById(c.id);
                    if(!el) return;
                    el.value = c.val;
                    el.addEventListener('focus', function() { this.select(); });
                    el.addEventListener('input', function() {
                        this.value = this.value.replace(/[^0-9]/g, '');
                        if(this.value.length >= c.max && i < els.length - 1) setTimeout(() => document.getElementById(els[i+1].id).focus(), 0);
                    });
                });
            };
            setup('date'); // 手動記錄
            setup('igDate'); // IG
            setup('giftDate'); // Gift
            setup('heartDate'); // Heart
        }
 
        function addManualInteraction() {
            const usernameInput = document.getElementById('manualUsername');
            if (!validateInput(usernameInput)) return alert("帳號格式錯誤");
            const username = usernameInput.value.trim(); if (!username) return alert("請輸入帳號");
            const nickname = document.getElementById('manualNickname').value.trim();
            const language = document.getElementById('manualLang').value;
            const checkedBoxes = document.querySelector('#manualSection .interaction-checkboxes').querySelectorAll('input:checked');
            let tags = Array.from(checkedBoxes).map(cb => (cb.value === '新粉絲' ? '粉絲' : cb.value));
            const details = document.getElementById('manualDetails').value.trim();
            const manualDateStr = `${document.getElementById('dateYYYY').value}/${document.getElementById('dateMM').value.padStart(2, '0')}/${document.getElementById('dateDD').value.padStart(2, '0')}`;
           
            const existingFan = fans.find(f => f.username === username);
            if (existingFan) {
                existingFan.interactions = Array.from(new Set([...existingFan.interactions, ...tags]));
                if (details) existingFan.details = existingFan.details ? existingFan.details + " / " + details : details;
                if (nickname) existingFan.nickname = nickname;
                existingFan.language = language; // Update language
                if (parseDate(manualDateStr) >= parseDate(existingFan.latestDate)) { existingFan.latestType = tags.join(' / '); existingFan.latestDate = manualDateStr; }
                showToast(`已更新 @${username}`);
            } else {
                fans.push({ id: Date.now(), username, nickname, language, interactions: tags, latestType: tags.join(' / '), latestDate: manualDateStr, details, sent: false, sentDate: '', isCloseFriend: false });
                showToast(`已新增 @${username}`);
            }


            // 連動：寫入動態紀錄
            addHistoryLog(username, nickname, tags.join(' / '), manualDateStr, details);


            usernameInput.value = ''; document.getElementById('manualNickname').value = '';
            document.getElementById('manualDetails').value = ''; document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false); initDateInput();
            saveData(); renderTable();
        }
 
        function openEditFanModal(id) {
            const fan = fans.find(f => f.id === id);
            if(!fan) return;
            document.getElementById('editFanId').value = id;
            document.getElementById('editFanUsername').value = fan.username;
            document.getElementById('editFanNickname').value = fan.nickname || '';
            document.getElementById('editFanDetails').value = fan.details || '';
            const inputs = document.querySelectorAll('#editFanCheckboxes input');
            const standardTags = [];
            inputs.forEach(input => { standardTags.push(input.value); input.checked = fan.interactions.includes(input.value === '新粉絲' ? '粉絲' : input.value); });
            const extraTags = fan.interactions.filter(t => !standardTags.includes(t));
            const extraContainer = document.getElementById('editFanExtraTags');
            extraContainer.innerHTML = extraTags.length ?
            '其它標籤: ' + extraTags.map(t => `<span onclick="removeExtraTag(${id}, '${t}')" class="cursor-pointer hover:bg-red-900 border border-white/20 px-1 rounded ml-1 bg-white/5">${t} <i class="fas fa-times text-[10px]"></i></span>`).join('') : '';
            document.getElementById('editFanModal').classList.remove('hidden');
        }
 
        function removeExtraTag(fanId, tag) {
            const fan = fans.find(f => f.id === fanId);
            if(fan) { fan.interactions = fan.interactions.filter(t => t !== tag); saveData(); openEditFanModal(fanId); }
        }
 
        function saveFanEdit() {
            const id = parseFloat(document.getElementById('editFanId').value);
            const fan = fans.find(f => f.id === id);
            if(fan) {
                const usernameInput = document.getElementById('editFanUsername');
                if(!validateInput(usernameInput)) return alert("帳號格式錯誤");
                
                // 更新主資料
                fan.username = usernameInput.value.trim();
                fan.nickname = document.getElementById('editFanNickname').value.trim();
                fan.details = document.getElementById('editFanDetails').value.trim();
                const checked = Array.from(document.querySelectorAll('#editFanCheckboxes input:checked')).map(cb => cb.value === '新粉絲' ? '粉絲' : cb.value);
                const standardValues = Array.from(document.querySelectorAll('#editFanCheckboxes input')).map(cb => cb.value);
                const currentExtra = fan.interactions.filter(t => !standardValues.includes(t));
                fan.interactions = Array.from(new Set([...checked, ...currentExtra]));

                // [修正] 若在篩選模式，同步更新 duplicateResults 以即時反映變更
                if (isDuplicateMode) {
                    const dupFan = duplicateResults.find(f => f.id === id);
                    if (dupFan) {
                        dupFan.username = fan.username;
                        dupFan.nickname = fan.nickname;
                        dupFan.details = fan.details;
                        dupFan.interactions = fan.interactions;
                    }
                }

                saveData(); 
                renderTable(); 
                closeEditFanModal(); 
                showToast('資料已更新');
            }
        }
        function closeEditFanModal() { document.getElementById('editFanModal').classList.add('hidden'); }
        function clearAllData() {
            const currentBrandName = document.getElementById('userName').value.trim();
            if (confirm("⚠️ 警告：這將永久刪除所有資料！(包含粉絲列表、IG貼文、禮物貼文、暖心互動)")) {
                if (prompt(`請輸入品牌名稱「${currentBrandName}」確認刪除：`) === currentBrandName) {
                    // 1. 清空所有資料陣列
                    fans = [];
                    igPosts = [];
                    giftPosts = [];
                    heartData = [];
                    historyData = [];


                    // 2. 更新 LocalStorage
                    saveData();
// 儲存 fans
                    localStorage.setItem('igPosts', '[]');
localStorage.setItem('giftPosts', '[]');
                    localStorage.setItem('heartData', '[]');
                    localStorage.setItem('historyData', '[]');
                    localStorage.setItem('keyPermissions', '{}');
                    keyPermissions = {};




                    // 3. 重新渲染所有列表介面
                    renderTable();
                    renderIgPosts();
                    renderGiftPosts();
                    renderHeartData();
                    
                    // 4. 更新下拉選單選項 (移除已刪除的貼文/禮物選項)
                    updateResponseOptions();




                    showToast("所有資料已清空");
                }
            }
        }
        
        // --- Excel Import/Export Logic ---
        function exportExcel() {
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: 互動紀錄
            const wsData1 = fans.map(f => ({
                "帳號": f.username,
                "暱稱": f.nickname,
                "語言": f.language || '中',
                "互動類型": f.interactions.join(' / '),
                "最近互動/活動日期": f.latestDate,
                "詳細內容": f.details,
                // 新增訊息狀態欄位
                "訊息": f.sent ? `已發送 ${f.sentDate}` : "待處理"
            }));
            const ws1 = XLSX.utils.json_to_sheet(wsData1);
            XLSX.utils.book_append_sheet(wb, ws1, "互動紀錄");

            // Sheet 2: 暖心時刻
            const wsData2 = heartData.map(h => ({
                "粉絲帳號": h.username,
                "粉絲暱稱": h.nickname,
                "回應日期": h.date,
                "回應項目": h.responseItem,
                "回應內容": h.content
            }));
            const ws2 = XLSX.utils.json_to_sheet(wsData2);
            XLSX.utils.book_append_sheet(wb, ws2, "暖心時刻");

            // Sheet 3: 動態紀錄 (新增區塊)
            const wsData3 = historyData.map(h => ({
                "日期": h.date,
                "帳號": h.username,
                "暱稱": h.nickname,
                "類型": h.type,
                "詳細內容": h.details
            }));
            const ws3 = XLSX.utils.json_to_sheet(wsData3);
            XLSX.utils.book_append_sheet(wb, ws3, "動態紀錄");

            // 檔名改為 FanConnect_"Brand Name"_Export_YYYYMMDD
            const profile = JSON.parse(localStorage.getItem('userProfile')) || { name: 'Brand' };
            const brandName = (profile.name || 'Brand').replace(/\s+/g, '_');
            const now = new Date();
            const ymd = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
            
            XLSX.writeFile(wb, `FanConnect_${brandName}_Export_${ymd}.xlsx`);
        }




        function handleExcelImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            // [新增] 匯入前先存檔，確保可復原
            saveData();
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    let updateCount = 0, newCount = 0;
                    const todayStr = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
                    
                    // 1. 處理 {互動紀錄}
                    const sheet1Name = workbook.SheetNames.find(n => n.includes('互動')) || workbook.SheetNames[0];
                    const json1 = XLSX.utils.sheet_to_json(workbook.Sheets[sheet1Name], { defval: "" });
                    
                    json1.forEach(row => {
                        const getVal = (kws) => { const k = Object.keys(row).find(key => kws.some(kw => key.toLowerCase().includes(kw))); return k ? row[k] : ''; };
                        const username = getVal(['帳號','user']).toString().trim();
                        if (!username) return;
 
                        const nickname = getVal(['暱稱','name','profile']).toString().trim();
                        let dateVal = getVal(['日期','date','time']);
                        let fileDate = (typeof dateVal === 'number') ? excelDateToJSDate(dateVal) : dateVal.toString().trim() || todayStr;
                        
                        let typeRaw = getVal(['互動','type']).toString();
                        let tags = typeRaw.split(/[\/，,]/).map(s=>s.trim()).filter(s=>s).map(t=>(t==='新粉絲'||t==='New Fan')?'粉絲':t);
                        
                        const details = getVal(['詳細','details']).toString().trim();
                        const language = getVal(['語言']).toString().trim() || '中';
                        
                        const msgVal = getVal(['訊息', 'message', 'status']).toString().trim();
                        let isSent = false, sentDate = '';
                        if (msgVal.includes('已發送')) {
                            isSent = true;
                            sentDate = msgVal.replace('已發送', '').trim();
                        }

                        // 更新粉絲資料邏輯
                        const existing = fans.find(f => f.username === username);
                        if (existing) {
                            let mergedTags = new Set([...existing.interactions, ...tags]);
                            existing.interactions = Array.from(mergedTags);

                            if (details && !existing.details.includes(details)) existing.details += " / " + details;
                            if (nickname && !existing.nickname) existing.nickname = nickname;
                            existing.language = language;
                            if (msgVal) { existing.sent = isSent; existing.sentDate = sentDate; }
                            if (parseDate(fileDate) >= parseDate(existing.latestDate)) { 
                                existing.latestType = tags.join(' / ');
                                existing.latestDate = fileDate; 
                            }
                            updateCount++;
                        } else {
                            fans.push({ id: Date.now()+Math.random(), username, nickname, language, interactions: tags, latestType: tags.join(' / '), latestDate: fileDate, details, sent: isSent, sentDate: sentDate, isCloseFriend: false });
                            newCount++;
                        }
                        
                        // [更新] 連動動態紀錄 (加強去重：檢查 帳號+日期+類型+內容)
                        const tagStr = tags.join(' / ');
                        const existHistIdx = historyData.findIndex(h => 
                            h.username === username && 
                            h.date === fileDate && 
                            h.type === tagStr && // 嚴格比對類型
                            h.details === details
                        );
                        if (existHistIdx === -1) {
                             addHistoryLog(username, nickname, tagStr, fileDate, details, false);
                        } else {
                            // 若重複但新資料為「前帳粉」，則更新
                            const oldLog = historyData[existHistIdx];
                            if (tags.includes('前帳粉') && oldLog.type.includes('粉絲') && !oldLog.type.includes('前帳粉')) {
                                historyData[existHistIdx].type = tagStr;
                            }
                        }
                    });

                    // 2. 處理 {暖心時刻} (新增去重邏輯)
                    const sheet2Name = workbook.SheetNames.find(n => n.includes('暖心'));
                    if (sheet2Name) {
                        const json2 = XLSX.utils.sheet_to_json(workbook.Sheets[sheet2Name], { defval: "" });
                        let addedHeartCount = 0;
                        json2.forEach(row => {
                           const username = (row['粉絲帳號'] || row['username']).toString().trim();
                           if(username) {
                               let rawDate = row['回應日期'];
                               let finalDate = (typeof rawDate === 'number') ? excelDateToJSDate(rawDate) : (rawDate || todayStr).toString().trim();
                               const responseItem = (row['回應項目'] || 'DM').toString().trim();
                               const content = (row['回應內容'] || '').toString().trim();
                               
                               // [去重檢查] 檢查是否已存在完全相同的紀錄 (Username + Date + Item + Content)
                               const isDuplicate = heartData.some(h => 
                                   h.username === username &&
                                   h.date === finalDate &&
                                   h.responseItem === responseItem &&
                                   h.content === content
                               );

                               if (!isDuplicate) {
                                   heartData.push({
                                       id: Date.now() + Math.random(),
                                       username: username,
                                       nickname: (row['粉絲暱稱'] || '').toString().trim(),
                                       date: finalDate,
                                       responseItem: responseItem,
                                       content: content
                                   });
                                   addedHeartCount++;
                               }
                           }
                        });
                        console.log(`已匯入 ${addedHeartCount} 筆暖心紀錄 (略過重複)`);
                    }

                    localStorage.setItem('heartData', JSON.stringify(heartData));
                    localStorage.setItem('fans', JSON.stringify(fans));
                    localStorage.setItem('historyData', JSON.stringify(historyData)); 
                    renderTable(); 
                    renderHeartData();
                    showToast(`匯入完成：新粉絲 ${newCount} / 更新 ${updateCount}`); 
                    e.target.value = '';
                } catch (err) { alert("匯入失敗：" + err.message); }
            };
            reader.readAsArrayBuffer(file);
        }
 
        function deleteFan(id) { 
            if(confirm('刪除資料？')) { 
                fans = fans.filter(f => f.id !== id);
                // [修正] 若在重複模式，同步移除篩選結果中的資料
                if (isDuplicateMode) {
                    duplicateResults = duplicateResults.filter(f => f.id !== id);
                }
                saveData(); 
                renderTable(); 
                showToast('已刪除'); 
            } 
        }
        function openModal(id) {
            activeFanId = id;
            // 根據來源查找資料
            const data = activeSourceType === 'heart' ? heartData.find(h => h.id === id) : fans.find(f => f.id === id);
            if(!data) return;
            document.getElementById('targetUser').innerText = "@" + data.username;
            document.getElementById('targetNickname').innerText = data.nickname || data.username;
            document.getElementById('modalText').value = "";
            document.getElementById('modalTempSelect').innerHTML = '<option value="">-- 選擇模板 --</option>' + templates.map(t => `<option value="${t.id}">${t.title}</option>`).join('');
            // Populate Dropdown for Gifts
            const giftSelect = document.getElementById('targetLinkInput');
            giftSelect.innerHTML = '<option value="">-- 選擇禮物 --</option>';
            giftPosts.forEach(p => {
                giftSelect.innerHTML += `<option value="${p.giftId}">${p.giftId} (${p.fileName})</option>`;
            });
            document.getElementById('finalGeneratedLink').value = '';
            const btn = document.getElementById('genLinkBtn'); btn.innerHTML = '<i class="fas fa-lock mr-1"></i>生成'; btn.classList.remove('bg-green-600');
            document.getElementById('msgModal').classList.remove('hidden');
        }
 
        function confirmSend() {
            // 取得目前操作的資料物件
            const currentData = activeSourceType === 'heart' ?
                heartData.find(h => h.id === activeFanId) : fans.find(f => f.id === activeFanId);
            
            const text = document.getElementById('modalText').value;
            
            navigator.clipboard.writeText(text).then(() => {
                if(currentData) {
                    // 1. 準備統一的時間戳記與目標帳號
                    const now = new Date();
                    const timeStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                    const targetUserLower = currentData.username.trim().toLowerCase(); // 轉小寫以確保比對無誤


                    // 2. [強力同步] 掃描 FANS 列表：更新該粉絲的主檔狀態
                    fans.forEach(f => {
                        if (f.username.trim().toLowerCase() === targetUserLower) {
                            f.sent = true;
                            f.sentDate = timeStr;
                        }
                    });


                    // 3. [強力同步] 掃描 HEART 列表：更新該粉絲所有待處理的紀錄
                    heartData.forEach(h => {
                        if (h.username.trim().toLowerCase() === targetUserLower) {
                            // 無論之前狀態為何，統一更新為已發送 (因為已執行發送動作)
                            h.sent = true;
                            h.sentDate = timeStr;
                        }
                    });
                }


                // 4. 存檔並刷新所有介面
                saveData(); 
                renderTable();     // 刷新粉絲列表
                renderHeartData(); // 刷新暖心紀錄表
                
                closeModal(); 
                
                // 5. 根據平台開啟連結
                if (currentData) {
                    if (currentMsgPlatform === 'threads') {
                        window.open(`https://www.threads.net/@${currentData.username}`, '_blank');
                    } else {
                        window.open(`https://ig.me/m/${currentData.username}`, '_blank');
                    }
                }
            });
        }
 
                // 修改為 async 以支援等待 API 回應
        async function generateHashLink() {
            const data = activeSourceType === 'heart' ?
                heartData.find(h => h.id === activeFanId) : fans.find(f => f.id === activeFanId);
            const postInput = document.getElementById('targetLinkInput').value.trim();
            const expiryHours = document.querySelector('input[name="linkExpiry"]:checked').value;
            
            if (!data || !postInput) return alert("請選擇禮物 ID");
            
            let postId = postInput.includes('/') ? postInput.split('/').pop().split('?')[0] : postInput;
            
            // 1. 生成原始長連結
            const payload = { pid: postId, u: data.username, ts: Date.now(), exp: parseInt(expiryHours) };
            const token = btoa(encodeURIComponent(JSON.stringify(payload))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
            let finalUrl = `https://our-vault-iota.vercel.app/vault/secure/${token}`;
            
            const btn = document.getElementById('genLinkBtn');
            const originalBtnText = btn.innerHTML;
            const useShort = document.getElementById('useShortUrl').checked;


            // 2. 如果勾選縮網址，呼叫 TinyURL
            if (useShort) {
                try {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 縮短中...';
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    
                    // 使用 allorigins 作為 CORS Proxy 繞過瀏覽器限制
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent('https://tinyurl.com/api-create.php?url=' + finalUrl)}`;
                    const response = await fetch(proxyUrl);
                    const result = await response.json();
                    
                    if (result.contents && result.contents.startsWith('http')) {
                        finalUrl = result.contents; // 成功取得短網址
                    } else {
                        throw new Error('Shorten failed');
                    }
                } catch (e) {
                    console.error("縮網址失敗", e);
                    // 失敗時安靜地退回長網址，或用 Toast 提示
                    showToast("縮網址連線逾時，已保留原始連結");
                } finally {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }


            // 3. 更新介面
            document.getElementById('finalGeneratedLink').value = finalUrl;
            btn.innerHTML = '<i class="fas fa-check"></i> 完成';
            btn.classList.add('bg-green-600');
            
            // 延遲一下讓綠色勾勾顯示，再變回原樣 (可選)
            setTimeout(() => {
                btn.classList.remove('bg-green-600');
                btn.innerHTML = originalBtnText;
            }, 3000);


            if(document.getElementById('modalTempSelect').value) applyTemplate();
        }


 
        function applyTemplate() {
            const tId = document.getElementById('modalTempSelect').value;
            const data = activeSourceType === 'heart' ? heartData.find(h => h.id === activeFanId) : fans.find(f => f.id === activeFanId);
            const template = templates.find(t => t.id == tId);
            if(template && data) {
                let content = template.body.replace(/{nickname}/g, data.nickname || data.username);
                const link = document.getElementById('finalGeneratedLink').value;
                if(link) content = content.replace(/{link}|{url}/g, link);
                const msgBox = document.getElementById('modalText'); msgBox.value = content;
                msgBox.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }
 
        function runDecryption() {
            const input = document.getElementById('decryptInput').value.trim();
            const resultDiv = document.getElementById('decryptResult');
            if(!input) return alert("請輸入內容");
            try {
                let token = input.includes('/vault/') ? input.split('/').pop() : input;
                token = token.replace(/-/g, '+').replace(/_/g, '/'); while (token.length % 4) token += '=';
                const data = JSON.parse(decodeURIComponent(atob(token)));
                
                // Use token's exp if available, otherwise default to 24
                const expiryHours = data.exp || 24;
                const expiryMs = expiryHours * 60 * 60 * 1000;
                
                const isExpired = new Date() > new Date(data.ts + expiryMs);
                resultDiv.classList.remove('hidden');
                document.getElementById('resPid').innerText = data.pid; document.getElementById('resUser').innerText = data.u;
                document.getElementById('resTime').innerText = new Date(data.ts).toLocaleString('zh-TW');
                document.getElementById('resExpire').innerText = new Date(data.ts + expiryMs).toLocaleString('zh-TW');
                document.getElementById('resStatus').innerHTML = isExpired ?
                '<span class="text-red-500">❌ 已過期</span>' : '<span class="text-green-400">✅ 有效連結</span>';
            } catch (e) { alert("解密失敗"); resultDiv.classList.add('hidden'); }
        }
 




































function showSection(s) {
            // [修正] 切換頁面時，強制退出疑似重複篩選模式，避免資料欄位錯亂 (undefined)
            if (typeof exitDuplicateMode === 'function' && isDuplicateMode) {
                exitDuplicateMode();
            }

            // 加入 'history', 'compare', 'keyManage' 到隱藏列表
            ['fans', 'manual', 'templates', 'decrypt', 'keyManage', 'igPosts', 'giftPosts', 'heartStats', 'history', 'compare'].forEach(x => {
                const el = document.getElementById(x+'Section');
                if(el) el.classList.add('hidden');
            });
            
            if(s === 'keyManage') renderKeyTable(); // 新增渲染呼叫
            const target = document.getElementById(s+'Section');
            if(target) target.classList.remove('hidden');
           
            if(s==='templates') renderTemplateList();
            if(s==='igPosts') renderIgPosts();
            if(s==='giftPosts') renderGiftPosts();
            if(s==='heartStats') renderHeartData();
            if(s==='history') renderHistory(); // 渲染動態紀錄
            if(s==='manual' || s==='heartStats') updateUsernameDatalist();
        }
        function closeModal() { document.getElementById('msgModal').classList.add('hidden');
        }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.remove('translate-y-20', 'opacity-0');
        setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000); }
 
        function addTemplate() {
            const id = document.getElementById('tmpId').value;
            const title = document.getElementById('tmpTitle').value; const body = document.getElementById('tmpBody').value;
            if(!title || !body) return;
            if(id) { const t = templates.find(x => x.id == id); t.title = title; t.body = body;
            } else { templates.push({ id: Date.now(), title, body }); }
            localStorage.setItem('templates', JSON.stringify(templates));
            cancelEditTemplate(); renderTemplateList();
        }
        function editTemplate(id) { const t = templates.find(x => x.id === id);
            document.getElementById('tmpId').value = t.id; document.getElementById('tmpTitle').value = t.title; document.getElementById('tmpBody').value = t.body; document.getElementById('saveTmpBtn').innerText = "更新模板"; document.getElementById('cancelTmpBtn').classList.remove('hidden');
        }
        function cancelEditTemplate() { document.getElementById('tmpId').value = ''; document.getElementById('tmpTitle').value = ''; document.getElementById('tmpBody').value = '';
            document.getElementById('saveTmpBtn').innerText = "儲存模板"; document.getElementById('cancelTmpBtn').classList.add('hidden'); }
        function deleteTemplate(id) { if(confirm('刪除模板？')) { templates = templates.filter(t => t.id !== id);
            localStorage.setItem('templates', JSON.stringify(templates)); renderTemplateList(); } }
        function renderTemplateList() { document.getElementById('templateListDisplay').innerHTML = templates.map(t => `<div class="flex justify-between items-center bg-black/30 p-3 rounded border border-white/5"><div><div class="font-bold text-indigo-200 text-sm">${t.title}</div><div class="text-xs text-gray-500 truncate w-64">${t.body}</div></div><div><button onclick="editTemplate(${t.id})" class="text-gray-400 hover:text-white px-2"><i class="fas fa-edit"></i></button><button onclick="deleteTemplate(${t.id})" class="text-gray-600 hover:text-red-500 px-2"><i class="fas fa-trash"></i></button></div></div>`).join('');
        }
       
        function backupData() {
            const profile = JSON.parse(localStorage.getItem('userProfile')) || { name: 'Brand' };
            const brandName = (profile.name || 'Brand').replace(/\s+/g, '');
            const now = new Date();
            const ymd = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
            const hm = `${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
            const filename = `FanConnect_${brandName}_${ymd}_${hm}.json`;
            const link = document.createElement('a');
            // 備份加入 historyData 與 keyPermissions
            link.href = 'data:application/json;charset=utf-8,'+ encodeURIComponent(JSON.stringify({ fans, templates, userProfile: profile, igPosts, giftPosts, heartData, historyData, keyPermissions }));
            link.download = filename; link.click();
        }
       
        function handleRestore(e) {
            const r = new FileReader();
            r.onload = (ev) => {
                try {
                    const o = JSON.parse(ev.target.result);
                    if(confirm(`確認還原備份？\n包含 ${o.fans.length} 筆粉絲資料與設定`)) {
                        fans = o.fans;
                        templates = o.templates || templates;
                        igPosts = o.igPosts || [];
                        giftPosts = o.giftPosts || [];
                        heartData = o.heartData || [];
                        historyData = o.historyData || [];
                        keyPermissions = o.keyPermissions || {}; // 還原鑰匙權限
                        if (o.userProfile) { localStorage.setItem('userProfile', JSON.stringify(o.userProfile)); loadProfile(); }
                        saveData();
                        localStorage.setItem('igPosts', JSON.stringify(igPosts));
                        localStorage.setItem('giftPosts', JSON.stringify(giftPosts));
                        localStorage.setItem('heartData', JSON.stringify(heartData));
                        localStorage.setItem('historyData', JSON.stringify(historyData));
                        localStorage.setItem('keyPermissions', JSON.stringify(keyPermissions));
                        localStorage.setItem('templates', JSON.stringify(templates));
                        renderTable(); renderTemplateList();
                        renderIgPosts(); renderGiftPosts(); renderHeartData();
                    }
                } catch(e){alert("格式錯誤");}
            };
            r.readAsText(e.target.files[0]);
        }




















































































        
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
        function updateUsernameDatalist() {
            const datalist = document.getElementById('usernameOptions');
            if (!datalist) return;
            const uniqueUsers = [...new Set(fans.map(f => f.username))];
            datalist.innerHTML = uniqueUsers.sort().map(u => {
                const fan = fans.find(f => f.username === u);
                const nick = fan && fan.nickname ? `(${fan.nickname})` : '';
                return `<option value="${u}">${nick}</option>`;
            }).join('');
        }
 




















        // --- 新增：官方資料比對與動態紀錄邏輯 ---
        
        let pendingNewFans = [];
        let pendingUnfollowed = [];




        // 1. 動態紀錄功能
        function renderHistory() {
            const tbody = document.getElementById('historyTableBody');
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase();

            // [修正] A. 準備資料來源
            let displayData = [];

            if (isDuplicateMode) {
                // 重複模式：直接使用篩選結果
                displayData = [...duplicateResults];
            } else {
                // 正常模式：合併資料
                // 1. 系統紀錄 (過濾掉舊的 '留言'/'DM'，避免與 heartData 重複)
                const systemLogs = historyData.filter(h => h.type !== '留言' && h.type !== 'DM');
                
                // 2. 互動紀錄 (從 heartData 即時生成，確保內容與暱稱同步)
                const interactionLogs = heartData.map(h => ({
                    id: h.id,
                    date: h.date,
                    username: h.username,
                    // nickname: h.nickname, // 不使用儲存的舊暱稱，稍後動態取得
                    type: h.responseItem === 'DM' ? 'DM' : '留言',
                    details: h.responseItem === 'DM' ? h.content : `已回應：${h.content}`, // 格式化內容
                    isInteraction: true // 標記來源
                }));
                displayData = [...systemLogs, ...interactionLogs];
            }

            // C. 搜尋過濾
            if (searchTerm) {
                displayData = displayData.filter(h => 
                    (h.username || '').toLowerCase().includes(searchTerm) ||
                    (getFanNickname(h.username) || '').toLowerCase().includes(searchTerm) || // 搜尋最新暱稱
                    (h.type || '').toLowerCase().includes(searchTerm) ||
                    (h.details || '').toLowerCase().includes(searchTerm)
                );
            }

            // D. 排序
            if (!isDuplicateMode) {
                displayData.sort((a, b) => {
                    const dateA = parseDate(a.date);
                    const dateB = parseDate(b.date);
                    return dateB - dateA;
                });
            }

            // [新增] 用於切換重複群組顏色的變數
            let lastGroupId = -1;
            let useGroupColorA = true;
            
            tbody.innerHTML = displayData.map(h => {
                // [新增] 套用重複群組樣式Class
                let rowClass = 'table-row';
                if (isDuplicateMode && h.dupGroupId !== undefined) {
                    if (h.dupGroupId !== lastGroupId) {
                        useGroupColorA = !useGroupColorA;
                        lastGroupId = h.dupGroupId;
                    }
                    rowClass += useGroupColorA ? ' duplicate-group-a' : ' duplicate-group-b';
                }

                // [關鍵] 強制取得最新暱稱
                const currentNick = getFanNickname(h.username);

                let typeClass = 'text-gray-400';
                const t = (h.type || '').toString();
                
                // 樣式判斷
                if(t.includes('新粉絲')) typeClass = 'text-green-400 font-bold';
                else if(t.includes('退追')) typeClass = 'text-red-400 font-bold';
                else if(t.includes('前帳粉')) typeClass = 'text-[#763BE3] font-bold';
                else if(t.includes('粉絲')) typeClass = 'text-pink-300';
                else if(h.type === '更新') typeClass = 'text-blue-400';
                else if(h.type === 'DM') typeClass = 'text-indigo-300'; // DM 樣式
                else if(h.type === '留言') typeClass = 'text-pink-300'; // 留言 樣式

                // 操作按鈕：如果是同步過來的互動紀錄，顯示提示文字代替按鈕，避免邏輯錯誤
                // [修正] 重複模式下，即使是互動紀錄也允許操作(因為是顯示特定的duplicateResults項目)
                const actionButtons = (h.isInteraction && !isDuplicateMode) ? 
                    `<span class="text-[10px] text-gray-600 select-none">(同步顯示)</span>` :
                    `<div class="flex justify-center gap-2">
                        <button onclick="openHistoryModal('${h.id}')" class="text-gray-400 hover:text-white" title="編輯"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteHistory('${h.id}')" class="text-red-500 hover:text-white" title="刪除"><i class="fas fa-trash-alt"></i></button>
                    </div>`;

                return `<tr class="${rowClass}">
                    <td class="text-xs text-gray-500">${h.date}</td>
                    <td class="font-bold">
                        <span class="text-indigo-300 cursor-pointer hover:text-indigo-100 hover:underline select-none" 
                              onmousedown="startFanLongPress(event, '${h.username}')" 
                              onmouseup="cancelFanLongPress(this, '${h.username}')" 
                              ontouchstart="startFanLongPress(event, '${h.username}')" 
                              ontouchend="cancelFanLongPress(this, '${h.username}')">
                            ${h.username}
                        </span>
                    </td>
                    <td class="text-xs text-gray-400">${currentNick}</td>
                    <td class="text-xs ${typeClass}">${h.type}</td>
                    <td class="text-xs text-gray-300 whitespace-pre-wrap">${h.details || ''}</td>
                    <td class="text-center">
                        ${actionButtons}
                    </td>
                </tr>`;
            }).join('');
        }




        // [更新後的程式碼]
        // 增加 save 參數，預設為 true。批次匯入時可設為 false 以避免重複寫入歷史
        function addHistoryLog(username, nickname, type, dateStr, details, save = true) {
            historyData.push({
                id: Date.now() + Math.random(),
                date: dateStr,
                username: username,
                nickname: nickname,
                type: type,
                details: details
            });
            // 只有當 save 為 true 時才觸發存檔
            if (save) saveData();
        }


        // --- History Modal Logic ---
        // --- History Modal Logic ---
        function openHistoryModal(id = null) {
            const modal = document.getElementById('historyModal');
            const title = document.getElementById('historyModalTitle');
            const inputs = {
                id: document.getElementById('historyId'),
                user: document.getElementById('histUsername'),
                nick: document.getElementById('histNickname'),
                y: document.getElementById('histDateYYYY'),
                m: document.getElementById('histDateMM'),
                d: document.getElementById('histDateDD'),
                detail: document.getElementById('histDetails')
            };
            
            document.querySelectorAll('#histCheckboxes input').forEach(cb => cb.checked = false);


            if (id) {
                const h = historyData.find(d => d.id == id);
                if (!h) return;
                title.innerText = "編輯動態紀錄";
                inputs.id.value = h.id;
                inputs.user.value = h.username || '';
                inputs.nick.value = h.nickname || '';
                inputs.detail.value = h.details || '';
                
                if(h.date) {
                    const parts = h.date.split(' ')[0].split('/'); 
                    if(parts.length >= 3) {
                        inputs.y.value = parts[0]; inputs.m.value = parts[1]; inputs.d.value = parts[2];
                    }
                }
                const types = (h.type || '').split(' / ');
                document.querySelectorAll('#histCheckboxes input').forEach(cb => {
                    if(types.includes(cb.value)) cb.checked = true;
                });
            } else {
                title.innerText = "新增動態紀錄";
                inputs.id.value = '';
                inputs.user.value = '';
                inputs.nick.value = '';
                inputs.detail.value = '';
                const now = new Date();
                inputs.y.value = now.getFullYear();
                inputs.m.value = String(now.getMonth()+1).padStart(2,'0');
                inputs.d.value = String(now.getDate()).padStart(2,'0');
            }
            modal.classList.remove('hidden');
        }


        function closeHistoryModal() {
            document.getElementById('historyModal').classList.add('hidden');
        }


        function saveHistoryData() {
            const id = document.getElementById('historyId').value;
            const user = document.getElementById('histUsername').value.trim();
            const nick = document.getElementById('histNickname').value.trim();
            const dateStr = `${document.getElementById('histDateYYYY').value}/${document.getElementById('histDateMM').value}/${document.getElementById('histDateDD').value}`;
            const details = document.getElementById('histDetails').value.trim();
            const checked = Array.from(document.querySelectorAll('#histCheckboxes input:checked')).map(cb => cb.value);
            const typeStr = checked.join(' / ');

            if (!user) return alert("請輸入帳號");

            if (id) {
                // 1. 嘗試更新 HistoryData (系統/手動紀錄)
                const histIdx = historyData.findIndex(h => h.id == id);
                let isHeartSource = false;

                if (histIdx !== -1) {
                    historyData[histIdx] = { ...historyData[histIdx], username: user, nickname: nick, date: dateStr, type: typeStr, details: details };
                } else {
                    // 2. 若找不到，嘗試更新 HeartData (顯示在動態紀錄中的暖心互動)
                    const heartIdx = heartData.findIndex(h => h.id == id);
                    if (heartIdx !== -1) {
                        isHeartSource = true;
                        // 更新暖心紀錄 (注意欄位對應: details -> content)
                        heartData[heartIdx].username = user;
                        heartData[heartIdx].nickname = nick;
                        heartData[heartIdx].date = dateStr;
                        heartData[heartIdx].content = details; // 暖心內容對應 details
                        // 暖心紀錄通常不修改 'type' (留言/DM 由 responseItem 決定)，此處略過 typeStr 更新
                    }
                }

                // 3. [修正] 同步更新 duplicateResults
                if (isDuplicateMode) {
                    const dupItem = duplicateResults.find(h => h.id == id);
                    if (dupItem) {
                        dupItem.username = user;
                        dupItem.nickname = nick;
                        dupItem.date = dateStr;
                        dupItem.type = typeStr;
                        dupItem.details = details;
                        if (isHeartSource) dupItem.content = details; // 若是暖心來源，同步 content
                    }
                }
                
                saveData(); // 全局存檔
                renderHistory();
                if (isHeartSource) renderHeartData(); // 若更動了暖心紀錄，同步刷新暖心表
            } else {
                addHistoryLog(user, nick, typeStr, dateStr, details);
            }
            
            closeHistoryModal();
        }


        function addManualInteraction() {
            const usernameInput = document.getElementById('manualUsername');
            if (!validateInput(usernameInput)) return alert("帳號格式錯誤");
            const username = usernameInput.value.trim(); if (!username) return alert("請輸入帳號");
            const nickname = document.getElementById('manualNickname').value.trim();
            const language = document.getElementById('manualLang').value;
            const checkedBoxes = document.querySelector('#manualSection .interaction-checkboxes').querySelectorAll('input:checked');
            let tags = Array.from(checkedBoxes).map(cb => (cb.value === '新粉絲' ? '粉絲' : cb.value));
            const details = document.getElementById('manualDetails').value.trim();
            const manualDateStr = `${document.getElementById('dateYYYY').value}/${document.getElementById('dateMM').value.padStart(2, '0')}/${document.getElementById('dateDD').value.padStart(2, '0')}`;
           
            const existingFan = fans.find(f => f.username === username);
            if (existingFan) {
                existingFan.interactions = Array.from(new Set([...existingFan.interactions, ...tags]));
                if (details) existingFan.details = existingFan.details ? existingFan.details + " / " + details : details;
                if (nickname) existingFan.nickname = nickname;
                existingFan.language = language; 
                if (parseDate(manualDateStr) >= parseDate(existingFan.latestDate)) { existingFan.latestType = tags.join(' / '); existingFan.latestDate = manualDateStr; }
                showToast(`已更新 @${username}`);
            } else {
                fans.push({ id: Date.now(), username, nickname, language, interactions: tags, latestType: tags.join(' / '), latestDate: manualDateStr, details, sent: false, sentDate: '', isCloseFriend: false });
                showToast(`已新增 @${username}`);
            }


            addHistoryLog(username, nickname, tags.join(' / '), manualDateStr, details);


            usernameInput.value = ''; document.getElementById('manualNickname').value = '';
            document.getElementById('manualDetails').value = ''; document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false); initDateInput();
            saveData(); // 使用全局存檔
            renderTable();
        }


        // [新增] 勾選框互斥邏輯
        function toggleHeartCheck(type) {
            const checkComment = document.getElementById('heartCheckComment');
            const checkDM = document.getElementById('heartCheckDM');
            
            if (type === 'comment' && checkComment.checked) {
                checkDM.checked = false;
            } else if (type === 'dm' && checkDM.checked) {
                checkComment.checked = false;
            }
            
            // 確保至少一個被選取 (若取消當前，則選取另一個)
            if (!checkComment.checked && !checkDM.checked) {
                if (type === 'comment') checkDM.checked = true;
                else checkComment.checked = true;
            }
        }

        // [新增] 下拉選單連動邏輯
        function handleHeartItemChange(select) {
            if (select.value === 'DM') {
                document.getElementById('heartCheckDM').checked = true;
                document.getElementById('heartCheckComment').checked = false;
            }
        }

        // [新增] 輔助函式：取得粉絲最新暱稱 (確保各列表顯示同步)
        function getFanNickname(username) {
            const fan = fans.find(f => f.username.toLowerCase() === username.toLowerCase());
            return fan ? (fan.nickname || '-') : '-';
        }

        function addHeartData() {
            const username = document.getElementById('heartUser').value.trim();
            const nickname = document.getElementById('heartNick').value.trim();
            const rawResponseItem = document.getElementById('heartResponseItem').value;
            const inputContent = document.getElementById('heartContent').value.trim();
            const dateStr = `${document.getElementById('heartDateYYYY').value}/${document.getElementById('heartDateMM').value}/${document.getElementById('heartDateDD').value}`;
            
            const isDM = document.getElementById('heartCheckDM').checked;
           
            if(!username) return alert("請輸入粉絲帳號");
            
            // 定義儲存與顯示的內容變數
            let saveResponseItem, saveContent, latestType, detailMsg;

            if (isDM) {
                // --- DM 模式邏輯 ---
                latestType = 'DM';
                saveResponseItem = 'DM'; 

                if (rawResponseItem && rawResponseItem !== 'DM') {
                    saveContent = `回應項目: ${rawResponseItem}\n${inputContent}`;
                    detailMsg = `回應項目: ${rawResponseItem}`; 
                } else {
                    saveContent = inputContent;
                    detailMsg = '';
                }

            } else {
                // --- 留言 模式邏輯 ---
                latestType = '留言';
                saveResponseItem = rawResponseItem;
                saveContent = inputContent;
                detailMsg = `在"${rawResponseItem}"留言`;
            }

            // 1. 新增暖心紀錄
            heartData.push({ 
                id: Date.now(), 
                username, 
                nickname, // 這裡存的暱稱僅供備份，顯示時將優先使用 getFanNickname
                responseItem: saveResponseItem, 
                content: saveContent, 
                date: dateStr 
            });

            // 2. 同步至粉絲列表
            let fan = fans.find(f => f.username.toLowerCase() === username.toLowerCase());
            
            if (fan) {
                // 同步互動標籤
                if (isDM) {
                    if (!fan.interactions.includes('DM')) fan.interactions.push('DM');
                } else {
                    if (!fan.interactions.includes('留言')) fan.interactions.push('留言');
                }
                
                // 更新時間
                const newDateTs = parseDate(dateStr);
                const oldDateTs = fan.latestDate ? parseDate(fan.latestDate) : 0;
                
                if (!fan.latestDate || newDateTs >= oldDateTs) {
                    fan.latestType = latestType;
                    fan.latestDate = dateStr;
                }
                if (nickname && !fan.nickname) fan.nickname = nickname;

                // 更新詳細內容
                if (detailMsg) {
                    if (fan.details) {
                        fan.details += ` / ${detailMsg}`;
                    } else {
                        fan.details = detailMsg;
                    }
                }
            } else {
                // 新粉絲建立
                fans.unshift({
                    id: Date.now() + Math.random(),
                    username: username,
                    nickname: nickname || '',
                    language: '中',
                    interactions: isDM ? ['DM'] : ['留言'],
                    latestType: latestType,
                    latestDate: dateStr,
                    details: detailMsg,
                    sent: false,
                    sentDate: '',
                    isCloseFriend: false
                });
            }
            
            // 3. [修正] 移除 addHistoryLog 呼叫，避免資料雙重儲存與不同步
            // 顯示將由 renderHistory 自動合併 heartData 生成
            
            saveData(); 
            renderHeartData(); 
            renderTable(); // 刷新粉絲列表
            if(typeof renderHistory === 'function') renderHistory(); // 刷新動態紀錄
            
            document.getElementById('heartUser').value = '';
            document.getElementById('heartNick').value = '';
            document.getElementById('heartContent').value = '';
            showToast('暖心紀錄已儲存並同步');
        }


        function openEditHeartModal(id) {
            const d = heartData.find(h => h.id === id); // Fix: use find by id
            if(!d) return;
            document.getElementById('editHeartIndex').value = id; // Actually storing ID
            document.getElementById('editHeartUser').value = d.username;
            document.getElementById('editHeartNick').value = d.nickname;
            document.getElementById('editHeartDate').value = d.date;
            document.getElementById('editHeartItem').value = d.responseItem;
            document.getElementById('editHeartContent').value = d.content;
            document.getElementById('editHeartModal').classList.remove('hidden');
        }


        function saveHeartEdit() {
            const id = parseFloat(document.getElementById('editHeartIndex').value);
            const idx = heartData.findIndex(h => h.id === id);
            if(idx !== -1) {
                // 更新主資料
                heartData[idx] = {
                    id: id,
                    username: document.getElementById('editHeartUser').value,
                    nickname: document.getElementById('editHeartNick').value,
                    date: document.getElementById('editHeartDate').value,
                    responseItem: document.getElementById('editHeartItem').value,
                    content: document.getElementById('editHeartContent').value,
                    sent: heartData[idx].sent, // 保留發送狀態
                    sentDate: heartData[idx].sentDate
                };

                // [修正] 若在篩選模式，同步更新 duplicateResults
                if (isDuplicateMode) {
                    const dupItem = duplicateResults.find(h => h.id === id);
                    if (dupItem) {
                        dupItem.username = heartData[idx].username;
                        dupItem.nickname = heartData[idx].nickname;
                        dupItem.date = heartData[idx].date;
                        dupItem.responseItem = heartData[idx].responseItem;
                        dupItem.content = heartData[idx].content;
                    }
                }

                saveData(); // 使用全局存檔
                renderHeartData();
                document.getElementById('editHeartModal').classList.add('hidden');
            }
        }
 
        function deleteHeartData(id) {
            if(confirm("確定刪除?")) {
                // [關鍵修復] 如果在篩選模式，先強制同步當前狀態到 LocalStorage
                // 這確保了等一下 saveData() 建立的快照裡，duplicateResults 是「刪除前」的完整狀態
                if (isDuplicateMode) saveData(false);

                // 1. 執行刪除 (寬鬆比對)
                heartData = heartData.filter(h => h.id != id);
                
                // 2. 同步移除篩選結果
                if (isDuplicateMode) {
                    duplicateResults = duplicateResults.filter(h => h.id != id);
                }
                
                // 3. 建立快照 (這時會讀取到剛才強制同步的完整列表作為 Undo 備份) 並存檔
                saveData(); 
                
                renderHeartData();
                showToast('已刪除');
            }
        }




        function deleteHistory(id) {
            if(confirm("刪除此條紀錄？")) {
                // [關鍵修復] 刪除前強制同步，確保 Undo 快照包含完整篩選列表
                if (isDuplicateMode) saveData(false);

                // 1. 嘗試從 historyData (系統紀錄) 刪除
                const initialHistoryLen = historyData.length;
                historyData = historyData.filter(h => h.id != id);
                
                // 2. 如果 historyData 沒變 (代表可能是暖心紀錄)，則嘗試從 heartData 刪除
                if (historyData.length === initialHistoryLen) {
                    heartData = heartData.filter(h => h.id != id);
                }

                // 3. 若在重複模式，同步移除篩選結果中的資料
                if (isDuplicateMode) {
                    duplicateResults = duplicateResults.filter(h => h.id != id);
                }

                saveData();
                renderHistory();
                // 若刪到了暖心紀錄，建議也刷新暖心表 (雖然當下看不到)
                if (document.getElementById('heartStatsSection') && !document.getElementById('heartStatsSection').classList.contains('hidden')) {
                     renderHeartData();
                }
                showToast('已刪除');
            }
        }




        // 2. 官方資料比對功能
        function handleIGJsonImport(e) {
            const file = e.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const json = JSON.parse(ev.target.result);
                    let officialUsers = [];
                    
                    const findValues = (obj) => {
                        if(Array.isArray(obj)) {
                            obj.forEach(item => findValues(item));
                        } else if (typeof obj === 'object' && obj !== null) {
                            if(obj.hasOwnProperty('string_list_data')) {
                                obj.string_list_data.forEach(d => {
                                    if(d.value) officialUsers.push(d.value);
                                });
                            } else {
                                Object.values(obj).forEach(val => findValues(val));
                            }
                        }
                    };
                    findValues(json);
                    
                    officialUsers = [...new Set(officialUsers)];
                    if(officialUsers.length === 0) throw new Error("找不到粉絲資料，請確認檔案格式");




                    compareData(officialUsers);
                    e.target.value = ''; 
                } catch(err) {
                    alert("解析失敗：" + err.message);
                }
            };
            reader.readAsText(file);
        }




        function compareData(officialUsers) {
            const currentUsers = fans.map(f => f.username);
            const newUsers = officialUsers.filter(u => !currentUsers.includes(u));
            
            pendingNewFans = newUsers.map(u => ({ username: u, nickname: '', lang: '中' }));
            
            const unfollowedUsers = fans.filter(f => {
                const isMarkedFan = f.interactions.includes('粉絲');
                return isMarkedFan && !officialUsers.includes(f.username);
            });
            
            pendingUnfollowed = unfollowedUsers;
            renderCompareResults();
        }




        function renderCompareResults() {
            document.getElementById('newFansCount').innerText = pendingNewFans.length;
            const newBody = document.getElementById('newFansBody');
            if(pendingNewFans.length > 0) {
                document.getElementById('newFansResult').classList.remove('hidden');
                newBody.innerHTML = pendingNewFans.map((u, idx) => `
                    <tr class="border-b border-white/5 hover:bg-white/5">
                        <td class="py-2 font-bold text-green-300">${u.username}</td>
                        <td><input type="text" onchange="updatePendingNewFan(${idx}, 'nickname', this.value)" placeholder="暱稱" class="bg-black/30 border border-gray-600 rounded px-2 py-1 text-xs w-24"></td>
                        <td>
                            <select onchange="updatePendingNewFan(${idx}, 'lang', this.value)" class="bg-black/30 border border-gray-600 rounded px-1 py-1 text-xs">
                                <option value="中">中</option>
                                <option value="英">英</option>
                            </select>
                        </td>
                        <td class="text-xs text-gray-400">待加入</td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('newFansResult').classList.add('hidden');
            }




            document.getElementById('unfollowedCount').innerText = pendingUnfollowed.length;
            const unfBody = document.getElementById('unfollowedBody');
            if(pendingUnfollowed.length > 0) {
                document.getElementById('unfollowedResult').classList.remove('hidden');
                unfBody.innerHTML = pendingUnfollowed.map(f => `
                    <tr class="border-b border-white/5 hover:bg-white/5">
                        <td class="py-2 font-bold text-red-300">${f.username}</td>
                        <td class="text-gray-400 text-xs">${f.nickname || '-'}</td>
                        <td class="text-gray-500 text-xs">${f.latestDate || '-'}</td>
                        <td><span class="text-xs bg-red-900/50 text-red-300 px-2 py-1 rounded border border-red-500/30">將移除「粉絲」標籤</span></td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('unfollowedResult').classList.add('hidden');
            }
        }




        function updatePendingNewFan(idx, field, value) {
            pendingNewFans[idx][field] = value;
        }




        function confirmNewFans() {
            if(!confirm(`確定加入 ${pendingNewFans.length} 位新粉絲？`)) return;
            const nowStr = new Date().toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'});
            
            pendingNewFans.forEach(u => {
                fans.push({
                    id: Date.now() + Math.random(),
                    username: u.username,
                    nickname: u.nickname,
                    language: u.lang,
                    interactions: ['粉絲'],
                    latestType: '新粉絲',
                    latestDate: nowStr,
                    details: '官方比對匯入',
                    sent: false,
                    isCloseFriend: false
                });
                // 更新參數順序：user, nick, type, date, detail
                addHistoryLog(u.username, u.nickname, '新粉絲', nowStr, '官方資料比對加入');
            });
            
            saveData();
            pendingNewFans = [];
            renderCompareResults();
            showToast('已加入新粉絲');
        }




        function confirmUnfollowed() {
            if(!confirm(`確定更新 ${pendingUnfollowed.length} 位退追狀態？\n(將移除「粉絲」標籤)`)) return;
            
            const nowStr = new Date().toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'});
            pendingUnfollowed.forEach(u => {
                const fan = fans.find(f => f.id === u.id);
                if(fan) {
                    fan.interactions = fan.interactions.filter(t => t !== '粉絲');
                    // 更新參數順序
                    addHistoryLog(fan.username, fan.nickname, '退追', nowStr, '官方資料比對移除粉絲標籤');
                }
            });
            
            saveData();
            pendingUnfollowed = [];
            renderCompareResults();
            showToast('已更新退追狀態');
        }















// --- 鑰匙管理系統邏輯 (功能修復版) ---

        let currentKeyMode = 'none'; // 'none', 'append', 'edit'

        // 1. 初始化與更新下拉選單
        function updateKeyDropdown() {
            const select = document.getElementById('keyGiftSelect');
            const heartSelect = document.getElementById('heartKeySelect');
            if(!select) return;
            const oldVal = select.value;
            let options = '<option value="">-- 請選擇 --</option>';
            giftPosts.forEach(g => {
                options += `<option value="${g.giftId}">${g.giftId}</option>`;
            });
            select.innerHTML = options;
            select.value = oldVal;
            if(heartSelect) heartSelect.innerHTML = options.replace('請選擇', '選擇');
        }

        // 2. 複製連結功能
        function copyKeyLink() {
            const input = document.getElementById('keyLinkInput');
            if(!input.value) return showToast("請先選擇禮物 ID");
            input.select(); document.execCommand('copy');
            showToast("連結已複製");
        }

        // 3. [核心] 主渲染函式：負責顯示邏輯、搜尋範圍與排序
        function renderKeyTable() {
            if(document.getElementById('keyGiftSelect').options.length <= 1) updateKeyDropdown();
            
            const giftId = document.getElementById('keyGiftSelect').value;
            const tbody = document.getElementById('keyTableBody');
            const emptyState = document.getElementById('keyEmptyState');
            const selectAllBox = document.getElementById('keySelectAll');
            const linkInput = document.getElementById('keyLinkInput');

            // 更新表頭圖示狀態 (Keys)
            const setIcon = (id, condition) => {
                const el = document.getElementById(id);
                if(el) condition ? el.classList.remove('hidden') : el.classList.add('hidden');
            };
            setIcon('key_icon_filter_status', activeDateFilters.length > 0 || (activeSort && activeSort.col === 'status'));
            setIcon('key_icon_filter_interactions', activeFilters.tags.length > 0);
            setIcon('key_icon_filter_sent', activeFilters.pending || activeFilters.oldSent || (activeSort && activeSort.col === 'sent'));
            setIcon('key_icon_filter_username', activeKeyStatusFilters.length > 0);

            // 1. 無 ID 狀態
            if (!giftId) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                selectAllBox.disabled = true;
                selectAllBox.classList.add('cursor-not-allowed');
                linkInput.value = "";
                document.getElementById('keyStatusText').innerText = "";
                return;
            }

            // 2. 有 ID，準備初始資料
            linkInput.value = `https://our-vault-iota.vercel.app/vault/${giftId}/entry`;
            emptyState.classList.add('hidden');
            const existingKeys = keyPermissions[giftId] || [];
            document.getElementById('keyStatusText').innerText = `名單人數: ${existingKeys.length}`;

            // 全選框狀態
            selectAllBox.disabled = (currentKeyMode === 'none');
            selectAllBox.classList.toggle('cursor-not-allowed', currentKeyMode === 'none');
            selectAllBox.checked = false;

            // 3. 決定初始資料池
            let displayFans;
            if (currentKeyMode === 'none') {
                // 檢視模式：只顯示已在名單內的人
                displayFans = fans.filter(f => existingKeys.includes(f.username));
            } else {
                // 編輯/追加模式：顯示所有人，讓使用者挑選
                displayFans = [...fans];
            }

            // 4. [修正] 多重篩選邏輯 (Date, Tags, Sent, KeyStatus)
            displayFans = displayFans.filter(f => {
                // A. 日期篩選
                if (activeDateFilters.length > 0) {
                    if (!f.latestDate) return false;
                    const d = parseDate(f.latestDate);
                    const diffDays = (Date.now() - d) / 86400000;
                    const matchDate = activeDateFilters.some(filter => {
                        if (filter === 'over30') return diffDays > 30;
                        if (filter === 'over7') return diffDays > 7;
                        return diffDays <= parseInt(filter);
                    });
                    if (!matchDate) return false;
                }

                // B. 互動標籤篩選 (AND)
                if (activeFilters.tags.length > 0) {
                    const matchAll = activeFilters.tags.every(tag => {
                        if (tag === '非粉絲') return !f.interactions.includes('粉絲');
                        return f.interactions.includes(tag);
                    });
                    if (!matchAll) return false;
                }

                // C. 訊息狀態篩選
                if (activeFilters.pending && f.sent) return false;
                const DAYS_14_MS = 1209600000;
                if (activeFilters.oldSent) {
                    const isOld = f.sent && f.sentDate && (Date.now() - parseDate2(f.sentDate) > DAYS_14_MS);
                    if (!isOld) return false;
                }

                // D. 鑰匙名單狀態篩選
                if (activeKeyStatusFilters.length > 0) {
                    const isInKey = existingKeys.includes(f.username);
                    const matchStatus = activeKeyStatusFilters.some(s => {
                        if (s === 'inList') return isInKey;
                        if (s === 'notInList') return !isInKey;
                        return false;
                    });
                    if (!matchStatus) return false;
                }

                return true;
            });

            // 5. 關鍵字搜尋
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
            if (searchTerm) {
                displayFans = displayFans.filter(f => 
                    (f.username || '').toLowerCase().includes(searchTerm) ||
                    (f.nickname || '').toLowerCase().includes(searchTerm) ||
                    (f.interactions || []).join('').toLowerCase().includes(searchTerm) ||
                    (f.details || '').toLowerCase().includes(searchTerm)
                );
            }

            // 6. [修正] 排序邏輯
            displayFans.sort((a, b) => {
                if (activeSort) {
                    const { col, order } = activeSort;
                    if (col === 'username') return order === 'az' ? a.username.localeCompare(b.username) : b.username.localeCompare(a.username);
                    if (col === 'status') {
                        const dateA = parseDate(a.latestDate);
                        const dateB = parseDate(b.latestDate);
                        return order === 'new' ? dateB - dateA : dateA - dateB;
                    }
                    if (col === 'sent') {
                        const getSentValue = (fan) => {
                            if (!fan.sent) return 9999999999999;
                            return fan.sentDate ? parseDate2(fan.sentDate) : 0;
                        };
                        const valA = getSentValue(a);
                        const valB = getSentValue(b);
                        return order === 'date_new' ? valB - valA : valA - valB;
                    }
                    // [修正] 互動標籤數量排序
                    if (col === 'interactions') return b.interactions.length - a.interactions.length;
                }
                return a.username.localeCompare(b.username);
            });

            // 7. 產生 HTML
            tbody.innerHTML = displayFans.map(fan => {
                const isInKey = existingKeys.includes(fan.username);
                let rowClass = 'table-row';
                let checkboxDisabled = true;
                let checkboxChecked = false;
                let checkboxClass = 'accent-emerald-500 cursor-not-allowed';

                // 根據模式設定狀態
                if (currentKeyMode === 'none') {
                    // 檢視模式：列表呈灰色，Checkbox 勾選但鎖死
                    checkboxChecked = true; 
                    rowClass += ' key-row-disabled'; 
                } else if (currentKeyMode === 'append') {
                    // 追加模式：已在名單者反灰(鎖死)，未在名單者可勾選
                    if (isInKey) {
                        checkboxChecked = true;
                        checkboxDisabled = true;
                        rowClass += ' key-row-pinned opacity-50';
                    } else {
                        checkboxDisabled = false;
                        checkboxClass = 'accent-emerald-500 cursor-pointer key-action-check';
                    }
                } else if (currentKeyMode === 'edit') {
                    // 僅編輯模式：所有框可勾選，已在名單者特別標示(但不強制置頂)
                    checkboxDisabled = false;
                    checkboxChecked = isInKey;
                    checkboxClass = 'accent-yellow-500 cursor-pointer key-action-check';
                    if (isInKey) rowClass += ' key-row-pinned'; // 僅保留顏色標示，不影響排序
                }

                const latestInfo = (fan.latestDate || fan.latestType) ? `<div class="flex flex-col"><span class="text-white font-bold text-xs">${fan.latestType || '無'}</span><span class="text-[10px] text-gray-500">${fan.latestDate || ''}</span></div>` : `-`;
                const tagsHtml = fan.interactions.map(tag => `<span class="px-1 py-0.5 rounded text-[10px] border border-white/10 bg-white/5 text-gray-400">${tag}</span>`).join('');
                const statusHtml = fan.sent ? `<span class="text-green-400 text-xs">✓ 已發</span>` : `<span class="text-gray-600 text-xs">● 待發</span>`;

                return `
                <tr class="${rowClass}">
                    <td class="text-center sticky-col-1 bg-inherit z-10">
                        <input type="checkbox" value="${fan.username}" ${checkboxChecked ? 'checked' : ''} ${checkboxDisabled ? 'disabled' : ''} class="${checkboxClass} w-4 h-4 transition-all">
                    </td>
                    <td class="font-medium sticky-col-2 bg-inherit z-10 text-emerald-100">${fan.username}</td>
                    <td class="text-gray-400 text-xs">${fan.nickname || '-'}</td>
                    <td class="text-xs">${latestInfo}</td>
                    <td><div class="flex flex-wrap gap-1 max-w-[150px]">${tagsHtml}</div></td>
                    <td><div class="text-xs text-gray-500 truncate w-32" title="${fan.details}">${fan.details}</div></td>
                    <td>${statusHtml}</td>
                    <td class="text-center sticky-col-last bg-inherit z-10">
                        <button onmousedown="startMsgBtnPress(event, '${fan.username}', ${fan.id})" 
                                onmouseup="endMsgBtnPress(event, ${fan.id})" 
                                class="btn-indigo px-3 py-1 rounded text-xs text-white font-bold">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }

        // 4. [按鈕邏輯] 切換主編輯模式
        function toggleKeyEditMaster() {
            const giftId = document.getElementById('keyGiftSelect').value;
            if(!giftId) return alert("請先選擇禮物 ID");

            const masterBtn = document.getElementById('btnKeyMaster');
            const subBtns = document.getElementById('keyModeBtns');
            
            // 如果已在編輯中，則關閉 (Reset)
            if (currentKeyMode !== 'none') {
                currentKeyMode = 'none';
                subBtns.classList.add('hidden');
                masterBtn.classList.remove('flashing-master', 'bg-red-600');
                masterBtn.classList.add('bg-gray-700');
                masterBtn.innerHTML = '<i class="fas fa-cog mr-1"></i>編輯鑰匙名單';
                
                // 重置子按鈕
                document.getElementById('btnKeyAppend').classList.remove('flashing-append', 'opacity-100');
                document.getElementById('btnKeyAppend').classList.add('opacity-50');
                document.getElementById('btnKeyEdit').classList.remove('flashing-edit', 'opacity-100');
                document.getElementById('btnKeyEdit').classList.add('opacity-50');
                
                renderKeyTable(); // 回到檢視模式
                return;
            }

            // 啟動主編輯 (Master 閃爍)
            masterBtn.classList.add('flashing-master');
            subBtns.classList.remove('hidden');
        }

        // 5. [按鈕邏輯] 切換子模式 (追加/僅編輯)
        function setKeySubMode(mode) {
            const masterBtn = document.getElementById('btnKeyMaster');
            const btnAppend = document.getElementById('btnKeyAppend');
            const btnEdit = document.getElementById('btnKeyEdit');

            // 如果點擊「正在閃爍」的按鈕 -> 執行 Finish
            if (currentKeyMode === mode) {
                finishKeyAction();
                return;
            }

            currentKeyMode = mode;
            masterBtn.classList.remove('flashing-master'); // 主按鈕停閃

            // 設定狀態與閃爍
            if (mode === 'append') {
                btnAppend.classList.add('flashing-append', 'opacity-100');
                btnAppend.classList.remove('opacity-50');
                btnAppend.innerHTML = '<i class="fas fa-check mr-1"></i>確認追加'; 

                btnEdit.classList.remove('flashing-edit', 'opacity-100');
                btnEdit.classList.add('opacity-50');
                btnEdit.innerHTML = '<i class="fas fa-edit mr-1"></i>僅編輯';
            } else {
                btnEdit.classList.add('flashing-edit', 'opacity-100');
                btnEdit.classList.remove('opacity-50');
                btnEdit.innerHTML = '<i class="fas fa-check mr-1"></i>確認存檔'; 

                btnAppend.classList.remove('flashing-append', 'opacity-100');
                btnAppend.classList.add('opacity-50');
                btnAppend.innerHTML = '<i class="fas fa-plus mr-1"></i>追加並產出';
            }
            renderKeyTable(); // 重繪 (觸發開放池與置頂)
        }

        // 6. [核心功能] 完成並產出
        function finishKeyAction() {
            const giftId = document.getElementById('keyGiftSelect').value;
            const existingKeys = keyPermissions[giftId] || [];
            let copyText = "";

            if (currentKeyMode === 'append') {
                // 追加模式：僅抓取 checked 的新 checkbox
                // 這裡只會抓到「可見且勾選」的新增者，不會影響既有名單
                const newChecks = document.querySelectorAll('.key-action-check:checked');
                const newUsers = Array.from(newChecks).map(cb => cb.value);
                
                if (newUsers.length === 0) return alert("未勾選任何新粉絲");

                const combined = new Set([...existingKeys, ...newUsers]);
                keyPermissions[giftId] = Array.from(combined);
                copyText = newUsers.map(u => `"${u}"`).join(','); 

            } else if (currentKeyMode === 'edit') {
                // 編輯模式：需修正邏輯以「保留被篩選隱藏的既有名單」
                
                // 1. 取得當前「畫面上可見」的所有使用者 (包含勾選與未勾選)
                const visibleRows = document.querySelectorAll('#keyTableBody .key-action-check');
                const visibleUsernames = Array.from(visibleRows).map(cb => cb.value);

                // 2. 取得「畫面上被勾選」的使用者
                const checkedVisibleRows = document.querySelectorAll('#keyTableBody .key-action-check:checked');
                const checkedUsernames = Array.from(checkedVisibleRows).map(cb => cb.value);

                // 3. 找出「原本在名單內，但目前被篩選隱藏」的使用者 (這些人應該要被保留)
                const hiddenButSelected = existingKeys.filter(user => !visibleUsernames.includes(user));

                // 4. 新名單 = (隱藏且保留者) + (畫面上勾選者)
                const finalUsers = [...hiddenButSelected, ...checkedUsernames];

                keyPermissions[giftId] = finalUsers;
                copyText = JSON.stringify(finalUsers);
            }

            saveData(); 
            
            navigator.clipboard.writeText(copyText).then(() => {
                 showToast("已複製清單");
            });
            
            toggleKeyEditMaster(); 
        }

        function handleKeySelectAll(source) {
            // [修正] 強制只抓取 keyTableBody 內的 Checkbox，確保不選到隱藏或非當前列表的資料
            const checkboxes = document.querySelectorAll('#keyTableBody .key-action-check');
            checkboxes.forEach(cb => {
                // 額外增加 offsetParent 判斷，確保該元素在畫面上是可見的 (雙重保險)
                if(!cb.disabled && cb.offsetParent !== null) {
                    cb.checked = source.checked;
                }
            });
        }

        function openMakeListModal(giftId) {
             if(!giftId) return alert("請先選擇禮物 ID");
             const perms = keyPermissions[giftId] || [];
             const json = JSON.stringify(perms);
             document.getElementById('jsonOutput').value = json;
             document.getElementById('jsonListModal').classList.remove('hidden');
        }

        function copyJsonOutput() {
            const el = document.getElementById('jsonOutput');
            el.select();
            document.execCommand('copy');
            showToast('JSON 已複製');
        }

        // --- 暖心互動整合邏輯 ---

        function toggleHeartKeyMode() {
            const btn = document.getElementById('addToKeyBtn');
            const select = document.getElementById('heartKeySelect');
            const th = document.getElementById('heartCheckHeader');
            
            if (!isHeartKeyMode) {
                // 階段 1: 啟動選擇模式 (紫光閃爍)
                isHeartKeyMode = true;
                btn.classList.add('animate-pulse', 'bg-purple-600', 'border-purple-400');
                btn.classList.remove('bg-gray-700');
                btn.innerHTML = '<i class="fas fa-check mr-1"></i>確認新增';
                select.classList.remove('hidden');
                th.classList.remove('hidden'); // 顯示表頭勾選框
                renderHeartData(); // 重新渲染以顯示 checkbox
                showToast('請選擇粉絲並指定禮物ID');
            } else {
                // 階段 2: 確認新增
                const giftId = select.value;
                if (!giftId) {
                    alert("請選擇要新增到的禮物 ID");
                    return;
                }
                
                // 收集勾選的粉絲
                const checks = document.querySelectorAll('.heart-key-checkbox:checked');
                if (checks.length === 0) {
                    alert("請至少勾選一位粉絲");
                    return;
                }

                const usersToAdd = Array.from(checks).map(c => c.value);
                
                // 更新權限
                if (!keyPermissions[giftId]) keyPermissions[giftId] = [];
                // 合併並去重
                const newSet = new Set([...keyPermissions[giftId], ...usersToAdd]);
                keyPermissions[giftId] = Array.from(newSet);
                
                saveData();
                
                // 變回綠色並重置
                btn.className = "text-xs bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-2 rounded transition-all border border-transparent";
                btn.innerHTML = '<i class="fas fa-check-double mr-1"></i>已新增';
                
                setTimeout(() => {
                    // 2秒後恢復原狀
                    isHeartKeyMode = false;
                    btn.className = "text-xs bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded transition-all border border-transparent";
                    btn.innerHTML = '<i class="fas fa-plus mr-1"></i>新增至鑰匙名單';
                    select.classList.add('hidden');
                    th.classList.add('hidden');
                    renderHeartData();
                }, 2000);
            }
        }

        function toggleAllHeartChecks(source) {
            document.querySelectorAll('.heart-key-checkbox').forEach(cb => cb.checked = source.checked);
        }












        window.onload = () => {
            loadProfile();
            renderTable();
            renderTemplateList();
            initDateInput();
            renderIgPosts();
            renderGiftPosts();
            renderHeartData();
        };
    </script>
</body>
</html>





